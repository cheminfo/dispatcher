define(["modules/default/defaultcontroller","src/util/api","src/util/versioning","src/data/structures"],function(a,b,c,d){function e(){}var f=new RegExp(";base64,(.+)$");return e.prototype=$.extend(!0,{},a),e.prototype.moduleInformation={moduleName:"Drag and drop",description:"Drop a file or paste some content to load",author:"Norman Pellet, MichaÃ«l Zasso",date:"31.07.2014",license:"MIT",cssClass:"dragdrop"},e.prototype.references={data:{label:"First data element"},dataarray:{label:"Array of loaded data"}},e.prototype.events={onRead:{label:"The data has been read",refVariable:["data","dataarray"]}},e.prototype.configurationStructure=function(){for(var a=d._getList(),b=a.length,c=new Array(b),e=0;b>e;e++)c[e]={key:a[e],title:a[e]};return{groups:{group:{options:{type:"list"},fields:{label:{type:"text",title:"Text displayed by default","default":"Drop your file here"},dragoverlabel:{type:"text",title:"Text displayed on drag"},hoverlabel:{type:"text",title:"Text displayed on hover"}}},vars:{options:{type:"table",multiple:!0,title:"For files"},fields:{filter:{type:"combo",title:"filter on",options:[{title:"File extension",key:"ext"},{title:"Mime-type",key:"mime"}],"default":"ext"},extension:{type:"text",title:"Filter","default":"*"},filetype:{type:"combo",title:"Read type",options:[{title:"Text",key:"text"},{title:"Base64 Encoded",key:"base64"},{title:"Object URL",key:"url"}],"default":"text"},type:{type:"combo",title:"Force type",options:c,"default":"string"},mime:{type:"text",title:"Force mime-type"},variable:{type:"text",title:"Temporary variable","default":"file"}}},string:{options:{type:"table",multiple:!1,title:"For strings"},fields:{type:{type:"combo",title:"Force type",options:c,"default":"string"},variable:{type:"text",title:"Temporary variable","default":"str"}}}}}},e.prototype.configAliases={vartype:["groups","group",0,"vartype",0],label:["groups","group",0,"label",0],dragoverlabel:["groups","group",0,"dragoverlabel",0],hoverlabel:["groups","group",0,"hoverlabel",0],vars:["groups","vars",0],string:["groups","string",0,0]},e.prototype.initImpl=function(){var a,b,c,d,e=this.module.getConfiguration("vars");if(e){var f=[];for(a=0,b=e.length;b>a;a++)c=e[a],d=$.extend({},c),f.push(d),c.extension?d.match=new RegExp("^"+c.extension.replace(/\*/g,".*").replace(/\?/g,".")+"$","i"):ecfgEl.match=/^.*$/i,c.filter||(d.filter="ext");this.fileCfg=f}this.stringCfg=this.module.getConfiguration("string"),this.resolveReady()},e.prototype.parseString=function(a,b){try{var c=d._parse(b.cfg.type,a);this.tmpVar(c,b)}catch(e){}},e.prototype.open=function(a){if(a.items.length){this.module.model.tmpVars=new DataObject,this.module.model.tmpVarsArray=new DataObject;for(var b,c,d,e=this,f=[],g=this.fileCfg,h=this.stringCfg,i=0,j=a.items.length;j>i;i++)b=a.items[i],d=$.Deferred(),f.push(d),"file"===b.kind?(b=b.getAsFile(),(c=this.checkMetadata(b,g))?(c.def=d,this.read(b,c)):d.resolve()):this.treatString(b,{filename:"",mime:"",def:d,cfg:h});$.when.apply(window,f).done(function(){e.createDataFromEvent("onRead","data",e.module.model.tmpVars),e.createDataFromEvent("onRead","dataarray",e.module.model.tmpVarsArray)})}},e.prototype.treatString=function(a,b){var c=this;a.getAsString(function(a){c.parseString(a,b)})},e.prototype.checkMetadata=function(a,b){if(!b)return console.warn("No filter configured");a.name=a.name||"";var c,d,e=a.name.split(".");c=e.length<2?"":e.pop().toLowerCase();for(var f=0,g=b.length;g>f;f++){var h=b[f].filter;if("ext"===h){var i=b[f].extension;if("*"===i||-1!==i.split(",").indexOf(c)){d=b[f];break}}else{var j=b[f].match,k=a.type;if(j.test(k)){d=b[f];break}}}return!d&&a.name?console.warn("Extension "+c+" not configured (filename: "+a.name+")"):d?{filename:a.name,mime:d.mime||a.type||"application/octet-stream",cfg:d}:console.warn("Item has no filename and mime-type doesn't match: "+a.type)},e.prototype.fileRead=function(a,b){switch(b.cfg.filetype){case"text":this.parseString(a,b);break;case"base64":var c=f.exec(a)[1];this.tmpVar(c,b);break;case"url":this.tmpVar(a,b)}},e.prototype.read=function(a,b){var c=this,d=new FileReader;switch(d.onload=function(a){c.fileRead(a.target.result,b)},d.onerror=function(a){console.error(a)},b.cfg.filetype){case"text":d.readAsText(a);break;case"base64":case"url":d.readAsDataURL(a)}},e.prototype.tmpVar=function(a,b){var c=b.cfg.variable,d=new DataObject({filename:b.filename,mimetype:b.mime,content:a},!0);this.module.model.tmpVarsArray[c]||(this.module.model.tmpVarsArray[c]=new DataArray),this.module.model.tmpVarsArray[c].push(d),this.module.model.tmpVars[c]=d,b.def.resolve()},e});