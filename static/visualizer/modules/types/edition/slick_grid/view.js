require.config({paths:{dragevent:"components/slickgrid/lib/jquery.event.drag-2.2",dropevent:"components/slickgrid/lib/jquery.event.drop-2.2",slickcore:"components/slickgrid/slick.core",slickgrid:"components/slickgrid/slick.grid",slickdataview:"modules/types/edition/slick_grid/slick.dataview.custom",slickgroupitemmetadataprovider:"modules/types/edition/slick_grid/slick.groupitemmetadataprovider.custom"},shim:{dragevent:["jquery"],dropevent:["jquery"],slickcore:["jquery-ui","components/jquery/jquery-migrate.min"],slickgrid:["slickcore","dragevent","dropevent","components/slickgrid/plugins/slick.cellrangedecorator","components/slickgrid/plugins/slick.cellrangeselector","components/slickgrid/plugins/slick.cellselectionmodel","components/slickgrid/plugins/slick.rowselectionmodel","components/slickgrid/slick.formatters","modules/types/edition/slick_grid/slick.editors.custom"],slickdataview:["slickgrid","slickgroupitemmetadataprovider"],slickgroupitemmetadataprovider:["slickgrid"]}}),define(["require","modules/default/defaultview","src/util/debug","lodash","src/util/util","src/util/api","src/util/typerenderer","slickgrid","slickdataview"],function(a,b,c,d,e,f,g){function h(){}function i(){return"..."}function j(){return'<div style="width:100%; height: 100%; display: table-cell"><a class="recycle-bin"></a></div>'}function k(a,b,c,d){if(!c.__group){this.module.data.traceSync([b]);var e=g.toScreen(c,this.module,{},d.jpath);e.always(function(b){$(a).html(b),e.build&&e.build()})}}var l=[];l.push(e.loadCss("./components/slickgrid/slick.grid.css"));var m=Promise.all(l),n={},o={typerenderer:i,"slick.text":Slick.Formatters.Text,"slick.percent":Slick.Formatters.PercentComplete,"slick.percentbar":Slick.Formatters.PercentCompleteBar,"slick.yesno":Slick.Formatters.YesNoSelect},p={"boolean":Slick.Editors.Checkbox,mf:Slick.Editors.TextValue,color:Slick.Editors.ColorValue,string:Slick.Editors.TextValue,number:Slick.Editors.TextValue,DataString:Slick.Editors.SpecialNativeObject,DataNumber:Slick.Editors.DataNumberEditor,DataBoolean:Slick.Editors.DataBooleanEditor};h.prototype=$.extend(!0,{},b,{init:function(){this.$dom||(this._id=e.getNextUniqueId(),this.$dom=$("<div>").attr("id",this._id).css({width:"100%",height:"100%"}),this.$rowHelp=$("<div>").attr("class","rowHelp"),this.module.getDomContent().html(this.$rowHelp),this.module.getDomContent().append(this.$dom)),this.slick={},this.colConfig=this.module.getConfiguration("cols"),this.idPropertyName="_sgid",this.resolveReady()},getSlickColumns:function(){var a=this,b=$.proxy(k,this),d=this.colConfig.map(function(d){var e,f;if("auto"===d.editor&&a.module.data)if(a.module.data.length){var g=a.module.data.get(0).getChildSync(d.jpath);g instanceof DataString?e=Slick.Editors.SpecialNativeObject:g instanceof DataNumber?e=Slick.Editors.DataNumberEditor:g instanceof DataBoolean?e=Slick.Editors.DataBooleanEditor:(f=a.module.data.get(0).getChildSync(d.jpath).type,e=p[f])}else e=Slick.Editors.SpecialNativeObject,c.warn("Slick grid: using editor based on type when the input variable is empty. Cannot determine type");else e=p[d.editor],f=d.editor;return{id:d.name,name:d.name,field:d.name,width:+d.width||void 0,minWidth:+d.minWidth||void 0,maxWidth:+d.maxWidth||void 0,resizable:d.resizable.indexOf("yes")>-1?!0:void 0,selectable:d.selectable.indexOf("yes")>-1,focusable:d.focusable.indexOf("yes")>-1,sortable:d.sortable.indexOf("yes")>-1,defaultSortAsc:d.defaultSortAsc.indexOf("yes")>-1,editor:e,formatter:o[d.formatter],asyncPostRender:"typerenderer"===d.formatter?b:void 0,jpath:d.jpath,dataType:f}});return this.module.getConfigurationCheckbox("slickCheck","rowDelete")&&d.unshift({id:"rowDeletion",width:30,field:"rowDeletion",selectable:!1,resizable:!1,focusable:!1,sortable:!1,formatter:j}),d},getSlickOptions:function(){var a=this;return{editable:a.module.getConfigurationCheckbox("slickCheck","editable"),enableAddRow:a.module.getConfigurationCheckbox("slickCheck","enableAddRow"),enableCellNavigation:a.module.getConfigurationCheckbox("slickCheck","enableCellNavigation"),autoEdit:a.module.getConfigurationCheckbox("slickCheck","autoEdit"),enableTextSelectionOnCells:a.module.getConfigurationCheckbox("slickCheck","enableTextSelectionOnCells"),enableColumnReorder:a.module.getConfigurationCheckbox("slickCheck","enableColumnReorder"),forceFitColumns:a.module.getConfigurationCheckbox("slickCheck","forceFitColumns"),multiColumnSort:a.module.getConfigurationCheckbox("slickCheck","multiColumnSort"),asyncEditorLoading:!0,enableAsyncPostRender:!0,asyncPostRenderDelay:0,defaultColumnWidth:a.module.getConfiguration("slick.defaultColumnWidth")||80,dataItemColumnValueExtractor:function(a){return a},explicitInitialization:!0,rowHeight:a.module.getConfiguration("slick.rowHeight"),showHeaderRow:a.module.getConfigurationCheckbox("slickCheck","filterColumns"),headerRowHeight:30}},inDom:function(){},update:{list:function(a){function b(a){for(var b in n)if(void 0!==b&&""!==n[b]){var c=e.slick.data.getIdxById(a[e.idPropertyName]),f=e.grid.getColumns()[e.grid.getColumnIndex(b)],g=d.clone(f.jpath);if(g.unshift(c),!e.module.data.getChildSync(g).get().toString().match(n[b]))return!1}return!0}var e=this;this.module.data=a,this._highlights=d.pluck(this.module.data,"_highlight"),this.slick.columns=this.getSlickColumns(),this.slick.options=this.getSlickOptions(),this.incrementalId=0,this.generateUniqIds(),this.addRowAllowed=this.module.getConfigurationCheckbox("slickCheck","enableAddRow"),m.then(function(){return e.cssLoaded}).then(function(){e.slick.groupItemMetadataProvider=new Slick.Data.GroupItemMetadataProvider,e.slick.data=new Slick.Data.DataView({groupItemMetadataProvider:e.slick.groupItemMetadataProvider}),e.slick.data.setModule(e.module),e.$dom=$("#"+e._id),e.grid=new Slick.Grid("#"+e._id,e.slick.data,e.slick.columns,e.slick.options),e.grid.registerPlugin(e.slick.groupItemMetadataProvider),e.grid.setSelectionModel("row"===e.module.getConfiguration("slick.selectionModel")?new Slick.RowSelectionModel:new Slick.CellSelectionModel),e._activateHighlights(),e.grid.module=e.module,e.module.getConfigurationCheckbox("slickCheck","oneUncollapsed")&&e.slick.groupItemMetadataProvider.onGroupExpanded.subscribe(function(a,b){this.getData().collapseAllGroups(b.item.level),this.getData().expandGroup(b.item.groupingKey)}),e.slick.data.onRowCountChanged.subscribe(function(){e.grid.updateRowCount(),e.grid.render()}),e.slick.data.onRowsChanged.subscribe(function(a,b){e.grid.invalidateRows(b.rows),e.grid.render()}),e.grid.onAddNewRow.subscribe(function(){e.module.model.dataTriggerChange(e.module.data)}),e.grid.onViewportChanged.subscribe(function(){setTimeout(function(){e.lastViewport=e.grid.getViewport(),e._resetDeleteRowListeners()},300),e.lastViewport=e.grid.getViewport(),e.module.getConfigurationCheckbox("slickCheck","rowNumbering")&&(e.$rowHelp.html((e.lastViewport.bottom-(e.addRowAllowed?2:1)).toString()+"/"+e.grid.getDataLength()),e.$rowHelp.fadeIn(),clearTimeout(e.lastRowHelp),e.lastRowHelp=setTimeout(function(){e.$rowHelp.fadeOut()},1e3))}),e.grid.onMouseEnter.subscribe(function(a){e._hl&&f.highlightId(e._hl,0),e.count=void 0===e.count?0:e.count,e.count++,e.hovering=!0;var b=e._getItemInfoFromEvent(a);if(b){var c=b.item._highlight;e._hl=c,c&&(f.highlightId(c,1),q=c),e.module.controller.onHover(b.idx,b.item)}}),e.grid.onMouseLeave.subscribe(function(a){e._e=a,e.count--,console.log("count",e.count),e.hovering=!1;var b=e._getItemInfoFromEvent(a);if(b){var c=b.item._highlight;c?f.highlightId(c,0):q&&f.highlightId(q,0)}}),e.grid.onClick.subscribe(function(a,b){var c=e.grid.getColumns(),d=e._getItemInfoFromRow(b.row);d&&c[b.cell]&&"rowDeletion"!==c[b.cell].id&&e.module.controller.onClick(d.idx,d.item)}),e.grid.onColumnsResized.subscribe(function(){for(var a=e.grid.getColumns(),b=0;b<a.length;b++)e.module.definition.configuration.groups.cols[0][b].width=a[b].width;e.grid.invalidate()}),e.grid.onCellChange.subscribe(function(a,b){var c=e._getItemInfoFromRow(b.row);c&&e.module.controller.onRowChange(c.idx,c.item)}),e.grid.onActiveCellChanged.subscribe(function(a,b){e.lastActiveCell=b.cell,e.lastActiveRow=b.row}),e.grid.onColumnsReordered.subscribe(function(){var a=e.grid.getColumns(),b=e.module.definition.configuration.groups.cols[0],f=d.pluck(b,"name"),g=d.pluck(a,"id");if(f.concat().sort().join()!==g.concat().sort().join())return void c.warn("Something might be wrong, number of columns in grid and in configuration do not match");e.module.definition.configuration.groups.cols[0]=[];for(var h=0;h<a.length;h++){var i=f.indexOf(g[h]);i>-1&&e.module.definition.configuration.groups.cols[0].push(b[i])}}),$(e.grid.getHeaderRow()).delegate(":input","change keyup",function(){var a=$(this).data("columnId");null!=a&&(n[a]=$.trim($(this).val()),e.slick.data.refresh())}),e.grid.onHeaderRowCellRendered.subscribe(function(a,b){$(b.node).empty(),$("<input type='text'>").css("width","100%").data("columnId",b.column.id).val(n[b.column.id]).appendTo(b.node)}),e.grid.init(),e.slick.data.beginUpdate();var a=(d.pluck(e.slick.columns,"id"),d.chain(e.module.getConfiguration("groupings")).filter(function(a){return a&&a.groupName&&a.getter?!0:!1}).map(function(a){return{getter:a.getter,formatter:function(b){return a.groupName+": "+b.value+"  <span style='color:green'>("+b.count+" items)</span>"},aggregateCollapsed:!1,lazyTotalsCalculation:!0}}).value());a.length&&e.slick.data.setGrouping(a),e.module.getConfigurationCheckbox("slickCheck","filterColumns")&&e.slick.data.setFilter(b),e.slick.data.setItems(e.module.data,e.idPropertyName),e.slick.data.endUpdate(),e.lastViewport&&e.grid.scrollRowToTop(e.lastViewport.top),d.isUndefined(e.lastActiveRow)||e.grid.setActiveCell(e.lastActiveRow,e.lastActiveCell),e.grid.render(),e._resetDeleteRowListeners(),e._setBaseCellCssStyle()})}},blank:{list:function(){this.$dom.html("")}},_setBaseCellCssStyle:function(){var a=this.grid.getColumns();this.baseCellCssStyle={};for(var b=0;b<a.length;b++)this.baseCellCssStyle[a[b].id]="highlighted-cell"},_resetDeleteRowListeners:function(){var a=this,b=a.$rb=$("#"+a._id).find("a.recycle-bin");b.off("click"),b.on("click",function(b){var c=a.grid.getColumns(),d=a._checkCellFromEvent(b);if(a.lastViewport=a.grid.getViewport(),c[d.cell]&&"rowDeletion"===c[d.cell].id){var e=a._getItemInfoFromRow(d.row);a.module.data.splice(e.idx,1),a.module.data.triggerChange()}})},_checkCellFromEvent:function(a){var b=this.grid.getCellFromEvent(a);return b.row>=this.module.data.length?null:b},_getItemInfoFromEvent:function(a){var b=this,c=this.grid.getCellFromEvent(a);if(!c)return null;var d=b.slick.data.mapRowsToIds([c.row])[0];return d?{id:d,idx:b.slick.data.getIdxById(d),item:b.slick.data.getItemById(d)}:null},_getItemInfoFromRow:function(a){var b=this;if(d.isUndefined(a))return null;var c=b.slick.data.mapRowsToIds([a])[0];return c?{id:c,idx:b.slick.data.getIdxById(c),item:b.slick.data.getItemById(c)}:null},_selectHighlight:function(a){if(!this.hovering){var b=this,c=this._highlights.indexOf(a[0]);if(this.lastViewport=this.grid.getViewport(),c>-1){var d=b.slick.data.getItemByIdx(c),e=b.slick.data.mapIdsToRows([d[b.idPropertyName]])[0];if(!e)return;(e<this.lastViewport.top||e>this.lastViewport.bottom)&&this.grid.scrollRowToTop(e),this.grid.setActiveCell(e,0)}}},_drawHighlight:function(a){var b=this;!a instanceof Array&&(a=[a]);var c={};this._selectHighlight(a),this.lastViewport=this.grid.getViewport();for(var e=this.lastViewport.top;e<=this.lastViewport.bottom;e++){var f=this.grid.getDataItem(e);f&&d.any(a,function(a){return a===f._highlight})&&(c[e]=b.baseCellCssStyle)}this.grid.setCellCssStyles(a.join(""),c)},_undrawHighlight:function(a){this.grid.removeCellCssStyles(a)},_activateHighlights:function(){var a=this,b=d(this.module.data).pluck("_highlight").uniq().value();f.killHighlight(this.module.getId());for(var c=0;c<b.length;c++)!function(c){f.listenHighlight({_highlight:b[c]},function(b,c){b?a._drawHighlight(c):a._undrawHighlight(c)})}(c)},onResize:function(){this.grid&&this.grid.resizeCanvas(),this.$rowHelp.css({bottom:0})},getNextIncrementalId:function(){return this.incrementalId++},generateUniqIds:function(){if(this.module.data)for(var a=0;a<this.module.data.length;a++)this.module.data[a][this.idPropertyName]||Object.defineProperty(this.module.data[a],this.idPropertyName,{value:"id_"+this.incrementalId,writable:!1,configurable:!1,enumerable:!1}),this.incrementalId++},onActionReceive:{hoverRow:function(a){var b;if(b=d.isNumber(a)||a instanceof DataNumber?this.module.data[a]:a,b&&b[this.idPropertyName]){var c=this.slick.data.mapIdsToRows([b[this.idPropertyName]])[0],e=this.slick.data.getIdxById(b[this.idPropertyName]);this.module.controller.onHover(e,b),this.grid.scrollRowToTop(c)}},selectRow:function(a){var b;if(b=d.isNumber(a)||a instanceof DataNumber?this.module.data[a]:a,b&&b[this.idPropertyName]){var c=this.slick.data.mapIdsToRows([b[this.idPropertyName]])[0],e=this.slick.data.getIdxById(b[this.idPropertyName]);this.module.controller.onClick(e,b),this.grid.scrollRowToTop(c),this.grid.setActiveCell(c,0)}}}});var q="";return h});