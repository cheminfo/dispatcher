define(["require","modules/default/defaultview","src/util/util","threejs"],function(a,b,c,d){function e(){}return e.prototype=$.extend(!0,{},b,{init:function(){var b=this;this.webgl=function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(a){return!1}}();var e=$.proxy(b.module.getConfiguration,b.module);this._id=c.getNextUniqueId();var f=$("<div>",{Id:this._id});f.css("display","table").css("height","100%").css("width","100%").css("overflow","hidden"),this.dom=f,this.module.getDomContent().html(this.dom).css("overflow","hidden"),this.zFunctionText=e("function")||"sin(sqrt(0.01*x^2  + 0.01*y^2))*10",this.xMin=e("xMin")||-100,this.xMax=e("xMax")||100,this.yMin=e("yMin")||-100,this.yMax=e("yMax")||100,this.zMin=e("zMin")||-100,this.zMax=e("zMax")||100,this.xRange=this.xMax-this.xMin,this.yRange=this.yMax-this.yMin,this.scene&&(this.scene.remove(this.graphGeometry),this.scene.remove(this.graphMesh),this.scene.remove(this.floor),delete this.graphGeometry,delete this.graphMesh,delete this.floor),a(["./TrackballControls","lib/parser/Parser"],function(){b.createGraph(),b.scene=new d.Scene,b.renderer||(b.renderer=b.webgl?new d.WebGLRenderer({antialias:!0}):new d.CanvasRenderer,b.renderer.setClearColor(15658734,1)),b.dom.append(b.renderer.domElement),b.addFloor(b.scene),b.resolveReady()}),this.doAnimation=!1,this.dom.on("mouseenter",function(){b.doAnimation=!0}),this.dom.on("mouseleave",function(){b.doAnimation=!1})},blank:function(){this.dom.empty()},inDom:function(){},onResize:function(){if(this.webgl){var b=this;console.log(this.onReady),this.module.viewReady.then(function(){{var c=$.proxy(b.module.getConfiguration,b.module);c("segments")}b.graphMesh&&b.scene.remove(b.graphMesh);var e=new d.ImageUtils.loadTexture(a.toUrl("./square.png"));e.wrapS=e.wrapT=d.RepeatWrapping,e.repeat.set(40,40);var f=new d.MeshBasicMaterial({map:e,vertexColors:d.VertexColors,side:d.DoubleSide});b.graphMesh=new d.Mesh(b.graphGeometry,f),b.graphMesh.doubleSided=!0,b.scene.add(b.graphMesh),b.renderer.setSize(b.width,b.height),b.setCamera(),b.setControls(),b.firstAnimation=60,b.animate()})}},addFloor:function(a){var b=new d.MeshBasicMaterial({color:136,wireframe:!0,side:d.DoubleSide}),c=new d.PlaneGeometry(1e3,1e3,10,10);self.floor=new d.Mesh(c,b),a.add(self.floor)},update:{"function":function(){}},animate:function(){var a=this;requestAnimationFrame(a.animate.bind(a)),(a.doAnimation||a.firstAnimation>0)&&(a.firstAnimation>0&&a.firstAnimation--,a.renderer.render(a.scene,a.camera),a.controls.update())},setCamera:function(){var a=45,b=this.width/this.height,c=.1,e=2e4;this.camera=new d.PerspectiveCamera(a,b,c,e),this.camera.position.set(2*this.xMax,.5*this.yMax,4*this.zMax),this.camera.up=new d.Vector3(0,0,1),this.camera.lookAt(this.scene.position),this.scene.add(this.camera)},setControls:function(){this.controls=new d.TrackballControls(this.camera,this.renderer.domElement)},createGraph:function(){var a=this,b=$.proxy(a.module.getConfiguration,a.module),c=b("segments"),e=Parser.parse(a.zFunctionText).toJSFunction(["x","y"]),f=function(b,c){b=a.xRange*b+a.xMin,c=a.yRange*c+a.yMin;var f=e(b,c);return isNaN(f)?new d.Vector3(0,0,0):new d.Vector3(b,c,f)},g=new d.ParametricGeometry(f,c,c,!0);g.computeBoundingBox(),a.zMin=g.boundingBox.min.z,a.zMax=g.boundingBox.max.z,a.zRange=a.zMax-a.zMin;for(var h,i,j,k,l,m=["a","b","c","d"],n=0;n<g.vertices.length;n++)i=g.vertices[n],h=new d.Color(255),h.setHSL(.7*(a.zMax-i.z)/a.zRange,1,.5),g.colors[n]=h;for(var n=0;n<g.faces.length;n++){j=g.faces[n],k=j instanceof d.Face3?3:4;for(var o=0;k>o;o++)l=j[m[o]],j.vertexColors[o]=g.colors[l]}a.graphGeometry=g},getDom:function(){return this.dom}}),e});