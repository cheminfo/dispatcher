define(["require","modules/default/defaultview","src/util/webworker","src/util/util","components/jquery.threedubmedia/event.drag/jquery.event.drag","components/jquery-throttle-debounce/jquery.ba-throttle-debounce.min"],function(a,b,c,d){function e(){}return e.prototype=$.extend(!0,{},b,{init:function(){this.colors=null,this.canvas=document.createElement("canvas"),this.canvasContext=this.canvas.getContext("2d"),this.scaleCanvas=document.createElement("canvas"),this.scaleCanvasContext=this.scaleCanvas.getContext("2d"),this.scaleCanvas.width=40,this.canvasContainer=$("<div />").addClass("matrix-container"),this.scaleContainer=$("<div />").addClass("scale-container"),this.dom=$("<div />").addClass("canvasmatrix-container").append(this.canvasContainer.append(this.canvas)).append(this.scaleContainer.append(this.scaleCanvas)),this.module.getDomContent().html(this.dom),this.squareLoading=250,this.availableZooms=[1,2,3,4,5,6,7,8,9,10],this.buffers={};var a=this;a.accumulatedDelta=0,$(this.canvasContainer).on("mousewheel","canvas",function(b){b.preventDefault();var c=b.originalEvent.detail||b.originalEvent.wheelDelta;a.max&&c>0||a.min&&0>c||(a.accumulatedDelta+=c,void 0!==c&&a.changeZoom(a.accumulatedDelta/1e3,b.offsetX||b.pageX-$(b.target).offset().left,b.offsetY||b.pageY-$(b.target).offset().top))}).on("dblclick",function(b){a.accumulatedDelta=0,a.changeZoom(a.accumulatedDelta/1e3,b.offsetX||b.pageX-$(b.target).offset().left,b.offsetY||b.pageY-$(b.target).offset().top)}),$(this.canvasContainer).drag(function(b,c){b.preventDefault();var d=a.baseShift,e=a.getXYShift();e.x=d.x+c.deltaX,e.y=d.y+c.deltaY,a.doCanvasErase(),a.doCanvasRedraw(),a.launchWorkers(!0)}),$(this.canvasContainer).drag("start",function(b){b.preventDefault(),a.baseShift=$.extend({},a.getXYShift())})},inDom:function(){this.canvasContainer.width(this.dom.width()-55),this.onResize(!0),this.initWorkers(),this.module.controller.initEvents(),this.resolveReady()},onResize:function(a){this.canvas.width=this.canvasContainer.width(),this.canvas.height=this.canvasContainer.height(),a||(this.doCanvasErase(),this.doCanvasRedraw())},doCanvasErase:function(){this.redrawStarted=!1,this.canvasContext.clearRect(0,0,this.canvas.width,this.canvas.height)},doCanvasRedraw:function(){for(var a=this.getBufferIndices(this.getPxPerCell()),b=a.minXIndexBuffer;b<=a.maxXIndexBuffer;b++)for(var c=a.minYIndexBuffer;c<=a.maxXIndexBuffer;c++)this.doCanvasDrawBuffer(b,c)},getBufferIndices:function(a){var b=this.getPxPerCell(),c=b/a,d=this.getXYShift(),e=0;d.x<0&&(e=Math.floor(-d.x/b/this.squareLoading));var f=0;d.y<0&&(f=Math.floor(-d.y/b/this.squareLoading));var g=Math.min(this.canvasNbX/this.squareLoading-1,(this.canvas.width-d.x)/a/this.squareLoading),h=Math.min(this.canvasNbY/this.squareLoading-1,(this.canvas.height-d.y)/a/this.squareLoading),i={minXIndexBuffer:e,minYIndexBuffer:f,maxXIndexBuffer:Math.ceil(g),maxYIndexBuffer:Math.ceil(h)};if(b>a){var j=Math.ceil(this.canvasNbX/this.squareLoading)-1,k=Math.ceil(this.canvasNbY/this.squareLoading)-1,l=i.maxXIndexBuffer-i.minXIndexBuffer,m=i.maxYIndexBuffer-i.minYIndexBuffer;i.minXIndexBuffer=Math.floor(Math.max(0,i.minXIndexBuffer-l*(c-1))),i.maxXIndexBuffer=Math.floor(Math.min(j,i.maxXIndexBuffer+l*(c-1)-1)),i.minYIndexBuffer=Math.floor(Math.max(0,i.minXIndexBuffer-m*(c-1))),i.maxYIndexBuffer=Math.floor(Math.min(k,i.maxYIndexBuffer+m*(c-1)-1))}return i},getBufferKey:function(a,b,c){return a+"-"+b+"-"+c},doCanvasDrawBuffer:function(a,b){var c=this.getXYShift(),d=this.getPxPerCell(),e=this.getBufferKey(d,a,b);this.buffers[e]&&this.canvasContext.putImageData(this.buffers[e],a*this.squareLoading*d+c.x,b*this.squareLoading*d+c.y)},getPxPerCell:function(a){return this.pxPerCell&&!a?this.pxPerCell:(this.pxPerCell=this.getOriginalPxPerCell(),this.resetZoomPrefetch(this.pxPerCell),this.pxPerCell)},resetZoomPrefetch:function(){var a,b,c;for(b=0;b<this.availableZooms.length;b++)if(this.availableZooms[b]==this.pxPerCell){a=b;break}var d=this.availableZooms.slice(a-2,a).reverse(),e=this.availableZooms.slice(a+1,a+3);for(this.availableZoomsForFetch=[],b=0,c=d.length+e.length;c>b;b++)this.availableZoomsForFetch.push(b%2&&d.length>0||0==e.length?d.shift():e.shift())},getOriginalPxPerCell:function(){return this.getClosest(this.availableZooms,Math.max(1,Math.min(this.canvas.width/this.canvasNbX,this.canvas.height/this.canvasNbY)))},getClosest:function(a,b){for(var c=!1,d=0;d<a.length;d++)(!c||a[d]-b<0&&b-a[d]<b-c)&&(c=a[d]);return c},changeZoom:function(a,b,c){var d=Math.max(1,this.getClosest(this.availableZooms,this.getOriginalPxPerCell()+this.tanh(a)));if(this.pxPerCell!=d){var e=d/this.pxPerCell,f=this.getXYShift();f.x=b-(b-f.x)*e,f.y=c-(c-f.y)*e,this.pxPerCell=d,this.pxPerCell==this.availableZooms[this.availableZooms.length-1]?(this.max=!0,this.min=!1):this.pxPerCell==this.availableZooms[0]?(this.min=!0,this.max=!1):(this.min=!1,this.max=!1),this.doCanvasErase(),this.launchWorkers(!0),this.doCanvasRedraw()}},tanh:function(a){return a/=15,2.5*this.availableZooms[this.availableZooms.length-1]*a},getXYShift:function(){if(this.xyShift&&!isNaN(this.xyShift.x)&&!isNaN(this.xyShift.y))return this.xyShift;var a=this.getPxPerCell(),b=a*this.canvasNbX,c=a*this.canvasNbY;return this.xyShift={x:Math.floor((this.canvas.width-b)/2),y:Math.floor((this.canvas.height-c)/2)}},update:{matrix:function(a){if(this.canvas){this.doCanvasErase(),a=a.get(),this.gridData=a.data,this.canvasNbX=this.gridData[0].length,this.canvasNbY=this.gridData.length;var b=this;this.minmaxworker||(this.minmaxworker=new Worker("src/util/workers/getminmaxmatrix.js"),this.minmaxworker.addEventListener("message",function(a){b.minValue=a.data.min,b.maxValue=a.data.max,b.doChangeWorkersData(),b.buffers=[],b.buffersDone=[],b.getHighContrast()||(b.minValue=0,b.maxValue=1),b.redoScale(b.minValue,b.maxValue),b.launchWorkers(!0)})),this.minmaxworker.postMessage(JSON.stringify(a.data))}}},initWorkers:function(){this.workers=this.initWorker()},getCurrentPxPerCellFetch:function(){return this.currentPxFetch?this.currentPxFetch:this.currentPxFetch=this.getPxPerCell()},incrementPxPerCellFetch:function(){return this.currentPxFetch=this.availableZoomsForFetch.shift()},launchWorkers:function(a){var b;if(this.cachedPxPerCell=this.pxPerCell,a?(b=this.getPxPerCell(),this.resetZoomPrefetch(b),this.pxPerCell=this.cachedPxPerCell):b=this.getCurrentPxPerCellFetch(),!this.postNextMessageToWorker(b)){if(!this.incrementPxPerCellFetch())return;this.launchWorkers()}},postNextMessageToWorker:function(a){for(var b=this.getBufferIndices(a),c=b.minXIndexBuffer;c<=b.maxXIndexBuffer;c++)for(var d=b.minYIndexBuffer;d<=b.maxYIndexBuffer;d++){var e=this.getBufferKey(a,c,d);if("undefined"==typeof this.buffers[e])return this.doPostNextMessageToWorker(a,c,d),!0}Math.ceil(this.canvasNbX/this.squareLoading)-1,Math.ceil(this.canvasNbY/this.squareLoading)-1;return!1},doPostNextMessageToWorker:function(a,b,c){if(!this.buffers[this.getBufferKey(a,b,c)]){var d=this.squareLoading,e=this.squareLoading;(b+1)*this.squareLoading>this.canvasNbX&&(d=this.canvasNbX%this.squareLoading),(c+1)*this.squareLoading>this.canvasNbY&&(e=this.canvasNbY%this.squareLoading),this.buffers[this.getBufferKey(a,b,c)]=this.canvasContext.createImageData(d*a,e*a)}this.workers.postMessage({title:"doPx",message:{pxPerCell:a,indexX:b,indexY:c,buffer:this.buffers[this.getBufferKey(a,b,c)],nbValX:d}})},doChangeWorkersData:function(){this.workers.postMessage({title:"changeData",message:{data:JSON.stringify(this.gridData),min:this.minValue,max:this.maxValue}})},initWorker:function(){var b=new Worker(a.toUrl("./worker.js"));b.postMessage({title:"init",message:{colors:this.getColors(),squareLoading:this.squareLoading,highcontrast:this.getHighContrast()}});var c=this;return b.addEventListener("message",function(a){var b=a.data,d=b.pxPerCell,e=b.indexX,f=b.indexY;c.buffers[c.getBufferKey(d,e,f)]=b.data,c.getPxPerCell()==d&&c.doCanvasDrawBuffer(e,f),c.launchWorkers()}),b},getColors:function(){if(!this.colors){var a=this.module.getConfiguration("colors");a?(1===a.length&&a.push([255,255,255,1]),this.colors=a):this.colors=[[0,0,0,1],[255,255,255,1]]}return this.colors},getHighContrast:function(){return this.highContrast||(this.highContrast=this.module.getConfiguration("highContrast",!1))},redoScale:function(a,b){var c=this.getColors();this.scaleCanvas.height=this.scaleContainer.height()-20,this.scaleCanvas.width=40;for(var e=this.scaleCanvas.height-30,f=(b-a)/(c.length-1),g=e/(c.length-1),h=this.scaleCanvasContext.createLinearGradient(0,0,0,e),i=0;i<c.length;i++)h.addColorStop(i/(c.length-1),d.getColor(c[i])),this.scaleCanvasContext.fillText(String(Math.round(100*(i*f+a))/100),5,0>=g*i?15:g*i-5);this.scaleCanvasContext.fillStyle=h,this.scaleCanvasContext.fillRect(28,5,10,e)},erase:function(){this.dom.remove(),this.highContrast=!1,this.colors=!1,this.workers.terminate(),this.workers=[],this.buffers=[]}}),e});