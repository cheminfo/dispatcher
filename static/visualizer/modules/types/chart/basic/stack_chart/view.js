define(["modules/default/defaultview","src/util/datatraversing","src/util/api","src/util/util","lib/flot/jquery.flot"],function(a,b,c,d){function e(){}return e.prototype=$.extend(!0,{},a,{DEBUG:!0,init:function(){this.DEBUG&&console.log("Stack Chart: init"),this.dom&&this.dom.empty(),this.dom||(this._id=d.getNextUniqueId(),this.dom=$('<p id="choices'+this._id+'" style="float:right; width:15%;"><br></p><div style="height: 100%;width: 80%" id="'+this._id+'"></div>'),this.module.getDomContent().html(this.dom)),this._flot&&delete this._flot,this.loadedData=$.Deferred(),this.DEBUG&&console.log("Stack Chart: ID: "+this._id),this._data=[];var a=$.proxy(this.module.getConfiguration,this.module);axis=void 0,x=void 0,this.updateOptions(a,axis,x),this.resolveReady()},inDom:function(){this.DEBUG&&console.log("Stack Chart: inDom")},onResize:function(){this.DEBUG&&console.log("Stack Chart: onResize");var a=this;this.loadedData.done(function(){this._plot=a.plot(a._id,a._data,a._options);var b=$("#choices"+a._id);b.empty(),$.each(a._data,function(a,c){b.append("<br/><input type='checkbox' name='"+a+"' checked='checked' id='id"+a+"'></input><label for='id"+a+"'>"+c.label+"</label>")}),b.find("input").bind("click",function(){a.plotAccordingToChoices(b,a._id)})})},update:{chart:function(a){if(a&&a.value){var b=this,c=$.proxy(this.module.getConfiguration,this.module);this.DEBUG&&console.log("stack Chart: update from chart object"),this._convertChartToData(a.get().data);var d=a.get().axis,e=a.get().data[0].x;this.updateOptions(c,d,e),this._plot=b.plot(b._id,b._data,b._options),this.loadedData.resolve()}}},_convertChartToData:function(a){this._data=[];var b=this;if(b._data=this._data,Array.isArray(a)&&a&&Array.isArray(a.x))for(var c=0;c<a.length;c++){var d=a[c].x,e=a[c].y,f=a[c]._highlight,g=a[c].serieLabel,h=a[c].info[0].name;s=[];for(var i=0;i<e.length;i++)s.push($.isNumeric(d[i])?{0:d[i],1:e[i],_highlight:f[i]}:{0:i,1:e[i],_highlight:f[i]});this._data[c]={data:s,info:g,label:h}}},updateOptions:function(a,b,c){var d=null,e=null,f=null,g=null,h=null,j=null,k=null,l=null;if(void 0!=b){if(d=b[0].type,e=b[1].type,h=b[0].max,j=b[1].max,f=b[0].min,g=b[1].min,Array.isArray(c)){for(u=[],i=0;i<c.length;i++)u.push([i,c[i]]);k=u}if(Array.isArray(b[1].unit)){for(u=[],i=0;i<b[1].unit.length;i++)u.push([i,b[1].unit[i]]);l=u}}var m=!1,n=!1,o=!1,p=a("stack"),q=a("barWidth"),r=a("xLabel"),s=a("yLabel"),t=a("xLabelHeight"),v=a("xLabelWidth"),w=a("yLabelHeight"),x=a("yLabelWidth");switch(a("preference")){case"Lines With Steps":m=!0,o=!0;break;case"Bars":n=!0;break;case"Lines":o=!0}this._options={xaxis:{show:!0,position:d,min:f,max:h,tickFormatter:function(a,b){return a<b.max?a.toFixed(2):r},ticks:k,labelWidth:v,labelHeight:t},yaxis:{position:e,min:g,max:j,ticks:l,tickFormatter:function(a,b){return a<b.max?a.toFixed(2):s},labelWidth:x,labelHeight:w},grid:{clickable:!0,hoverable:!0},series:{stack:p,lines:{show:o,fill:a("fill"),steps:m},bars:{show:n,barWidth:q}}}},plot:function(a,b,c){var d=this;this._plot=$.plot("#"+a,b,c),$("#"+a).bind("plotclick",function(a,b,c){a.preventDefault(),c&&console.log("Y:"+c.datapoint[1])}),$("#"+a).bind("plothover",function(a,b,c){c?d.module.controller.elementHover(d._data[c.seriesIndex].data[c.dataIndex]):d.module.controller.elementOut()})},plotAccordingToChoices:function(a,b){var c=this,d=[];a.find("input:checked").each(function(){var a=$(this).attr("name");a&&c._data[a]&&d.push(c._data[a])}),d.length>0&&this.plot(b,d,c._options)}}),e});