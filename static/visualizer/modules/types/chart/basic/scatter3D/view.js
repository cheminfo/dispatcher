define(["modules/default/defaultview","src/util/datatraversing","src/util/api","src/util/util","underscore","threejs","components/three.js/examples/js/controls/TrackballControls"],function(a,b,c,d,e){function f(a,b,c){for(var d=[],e=0;a>e;e++)d.push(Math.random()*(c-b)+b);return d}function g(a,b){var c=f(b,0,a.length-.001);return c=c.map(function(b){return a[Math.floor(b)]})}function h(a){for(var b=[],c="0123456789ABCDEF".split(""),d=0;a>d;d++){for(var e="#",f=0;3>f;f++)e+=c[Math.floor(16*Math.random())];b.push(e)}return b}function i(a){var b=a.toString(16);return 1==b.length?"0"+b:b}function j(a,b,c){return"#"+i(a)+i(b)+i(c)}function k(a){return 3===a.length?"rgba("+a[0]+","+a[1]+","+a[2]+",1)":4===a.length?"rgba("+a[0]+","+a[1]+","+a[2]+","+a[3]+")":"rgba(0,0,0,1)"}function l(){this._firstLoad=!0}var m=1e3,n=100,o=3,p="#eeeeee",q="#888888",r="#0000ff",s=.03,t="sphere",u="rgba(0,0,0,1)",v=m/1e3,w=2,x=1e4,y={sphere:"modules/types/chart/basic/scatter3D/img/ball.png",tetrahedron:"modules/types/chart/basic/scatter3D/img/tetrahedron2.png"};return $.fn.listHandlers=function(a,b){return this.each(function(){var c=this,d=$(this).data("events");d&&$.each(d,function(d,e){new RegExp("^("+("*"===a?".+":a.replace(",","|").replace(/^on/i,""))+")$","i").test(d)&&$.each(e,function(a,e){b(c,"\n"+a+": ["+d+"] : "+e)})})})},l.prototype=$.extend(!0,{},a,{DEBUG:!0,_initThreejs:function(){function a(a){var b=new THREE.Vector3(a.offsetX/$(s.renderer.domElement).width()*2-1,2*-(a.offsetY/$(s.renderer.domElement).height())+1,.5);projector=new THREE.Projector,projector.unprojectVector(b,s.camera);for(var c=new THREE.Ray(s.camera.position,b.sub(s.camera.position).normalize()),d=0,f=[],g=0;g<s.mathPoints.length;g++)c.isIntersectionSphere(s.mathPoints[g])&&(d++,f.push({index:s.mathPoints[g].index,distance:s.camera.position.distanceTo(s.mathPoints[g].center)}));return f.sort(D),f=e.filter(f,function(a){return a.distance>w}),f=e.map(f,function(a){return a.index})}function b(a){if(s._configCheckBox("displayPointCoordinates","onhover")){var b=[];b.push("X: "+parseFloat(s._data.x[a].toPrecision(3)).toExponential()),b.push("Y: "+parseFloat(s._data.y[a].toPrecision(3)).toExponential()),b.push("Z: "+parseFloat(s._data.z[a].toPrecision(3)).toExponential()),$("#legend_point_coordinates").html(b.join("<br/>")),$("#legend_point_coordinates").show()}}function d(){s._configCheckBox("displayPointCoordinates","onhover")&&$("#legend_point_coordinates").hide()}function f(e){var f;if(f=a(e),t=f,u=e,f.length>0){var g=f[0],h=g,i=h!==y;y&&i?(c.highlightId(s._data._highlight[y],0),c.highlightId(s._data._highlight[h],1),b(g)):i&&(c.highlightId(s._data._highlight[h],1),b(g)),y=h}else null!==y&&(c.highlightId(s._data._highlight[y],0),d()),y=null}function g(){if(0!==t.length){var a=s.module.getConfiguration("tooltipJpath");if(a){var b=s._data;if(b.info){var c=b.info[t[0]],d=c.getChildSync(a);$("#scatter3D_tooltip").css("left",u.offsetX-n),$("#scatter3D_tooltip").css("top",u.offsetY),$("#scatter3D_tooltip").css("width",n),$("#scatter3D_tooltip").html(d.value),$("#scatter3D_tooltip").show()}}}}function h(){$("#scatter3D_tooltip").hide()}function i(){if(0!==t.length){var a=t[0];C.length>0&&k();var b={color:8947848},c=new THREE.Vector3(s._data.normalizedData.x[a],s._data.normalizedData.y[a],s._data.normalizedData.z[a]),d=new THREE.Vector3(s._data.normalizedData.x[a],s._data.normalizedData.y[a],0);C.push(s._drawLine(c,d,b)),C.push(s._drawCircle({color:"#000000",radius:s._data.size[a],x:s._data.normalizedData.x[a],y:s._data.normalizedData.y[a],z:v+s.gorigin.z})),d=new THREE.Vector3(s._data.normalizedData.x[a],0,s._data.normalizedData.z[a]),C.push(s._drawLine(c,d,b)),C.push(s._drawCircle({rotationAngle:Math.PI/2,rotationAxis:{x:1},color:"#000000",radius:s._data.size[a],x:s._data.normalizedData.x[a],y:v+s.gorigin.y,z:s._data.normalizedData.z[a]})),d=new THREE.Vector3(0,s._data.normalizedData.y[a],s._data.normalizedData.z[a]),C.push(s._drawLine(c,d,b)),C.push(s._drawCircle({rotationAngle:Math.PI/2,rotationAxis:{y:1},color:"#000000",radius:s._data.size[a],x:v+s.gorigin.x,y:s._data.normalizedData.y[a],z:s._data.normalizedData.z[a]})),q()}}function k(){for(var a=0;a<C.length;a++)s.scene.remove(C[a]);C=[],q()}function l(){function a(){if(t.length>0){var a=t[0];s.module.controller.onHover([s._data.info[a],[s._data.x[a],s._data.y[a],s._data.z[a]]],["info","coordinates"])}}s.camera=s.camera||new THREE.PerspectiveCamera(60,s.dom.width()/s.dom.height(),w,x),s.controls||(s.controls=new THREE.TrackballControls(s.camera,s.dom.get(0)),s.controls.rotateSpeed=1,s.controls.zoomSpeed=1.2,s.controls.panSpeed=.8,s.controls.noZoom=!1,s.controls.noPan=!1,s.controls.staticMoving=!0,s.controls.dynamicDampingFactor=.3,s.controls.keys=[65,83,68],s.controls.addEventListener("change",q)),s.scene=new THREE.Scene,s.renderer=new THREE.WebGLRenderer({antialias:!1});var b=s.module.getConfiguration("backgroundColor");s.renderer.setClearColor(j(b[0],b[1],b[2])||p,1),s.renderer.setSize(window.innerWidth,window.innerHeight),r=document.getElementById(s.dom.attr("id")),r.innerHTML="",r.appendChild(s.renderer.domElement),$(s.dom).append('<div id="scatter3D_tooltip" style="z-index: 10000; position:absolute; top: 20px; width:'+n+'100px; height: auto; background-color: #f9edbe;"> </div>'),$("#scatter3D_tooltip").hide(),$(s.dom).append('<div id="legend" style="z-index: 10000; right:10px ;position:absolute; top: 25px; height: auto; background-color: #ffffff;"> </div>'),$("#legend").append('<div id="legend_titles"></div>'),$("#legend").append('<div id="legend_point_coordinates"></div>'),$("#legend").css("background-color",s.module.getConfiguration("backgroundColor")).css("text-align","right"),$("#legend_titles").hide(),$("#legend_point_coordinates").hide(),m(),console.log("Init three js"),$(s.renderer.domElement).on("mousemove",e.throttle(f,100)),$(s.renderer.domElement).on("mousemove",e.throttle(a,300)),console.log("tooltip config: ",s.module.getConfiguration("tooltip")),console.log("tooltip jpath: ",s.module.getConfiguration("tooltipJpath")),s._configCheckBox("tooltip","show")&&(console.log("Activating tooltip"),$(s.renderer.domElement).on("mousemove",e.debounce(g,500)),$(s.renderer.domElement).on("mousemove",e.throttle(h,500))),s._configCheckBox("projection","show")&&(console.log("Activating projections"),$(s.renderer.domElement).on("mousemove",e.debounce(i,500)),$(s.renderer.domElement).on("mousemove",e.throttle(k,500))),$(s.renderer.domElement).listHandlers("mousemove",function(a,b){console.log("handler list: ",a,b)})}function m(){s.camera.aspect=s.dom.width()/s.dom.height(),s.camera.updateProjectionMatrix(),s.renderer.setSize(s.dom.width(),s.dom.height()),s.controls.handleResize(),q()}function o(){requestAnimationFrame(o),s.controls.update()}function q(){s._render(),s.headlight&&(s.headlight.position.x=s.camera.position.x+200,s.headlight.position.y=s.camera.position.y+200,s.headlight.position.z=s.camera.position.z+200),s.tickLabels&&(z(),A(),B())}var r,s=this,t=[],u=null,y=null,z=$.proxy(e.throttle(s._drawTickLabels,500),s),A=$.proxy(e.throttle(s._drawAxisLabels,500),s),B=$.proxy(e.throttle(s._drawGraphTitle,500),s),C=[];l(),o();var D=function(a,b){return a.distance-b.distance}},_drawGraph:function(){var a=this,b=(new Date).getTime();e.keys(a.scene.children).forEach(function(b){a.scene.remove(a.scene.children[b])}),console.log("objects removed",(new Date).getTime());var c;c=new THREE.AmbientLight(2236962,1),a.scene.add(c),a.headlight=new THREE.PointLight(11184810,1.5),a.headlight.position.x=1e3,a.headlight.position.y=1e3,a.headlight.position.z=1e3,a.scene.add(a.headlight),a._mathPoints(),a._drawPointsQuick(),a._drawAxes(),a._drawFaces(),a._drawGrid(),a._drawSecondaryGrid(),a._drawTicks(),a._drawTickLabels(),a._drawAxisLabels(),a._drawGraphTitle(),a._render(),console.log("end plot points",(new Date).getTime()-b)},_drawPointsQuick:function(){var a=this;if(a._mainParticleObjects)for(var b in a._mainParticleObjects)a.scene.remove(a._mainParticleObjects[b]);a._mainParticleObjects={};for(var c={},d=0;d<a._data.shape.length;d++)c[a._data.shape[d]]=c[a._data.shape[d]]||[],c[a._data.shape[d]].push(d);for(var b in c)a._mainParticleObjects[b]=a._newParticleObject(c[b],{shape:b}),a._updateParticleObject(a._mainParticleObjects[b]),a.scene.add(a._mainParticleObjects[b]);a.renderer.render(a.scene,a.camera)},_configCheckBox:function(a,b){return this.module.getConfiguration(a)&&e.find(this.module.getConfiguration(a),function(a){return a===b})},_getDataField:function(a){return this._data?e.flatten(e.pluck(this._data.data,a)):[]},_normalizeData:function(){var a=this;this._data&&(a._data.normalizedData={},a._data.normalizedData.x=e.map(a._data.x,function(b){return m*(b-a._data.realMin.x)/a._data.realLen.x}),a._data.normalizedData.y=e.map(a._data.y,function(b){return m*(b-a._data.realMin.y)/a._data.realLen.y}),a._data.normalizedData.z=e.map(a._data.z,function(b){return m*(b-a._data.realMin.z)/a._data.realLen.z}),console.log("Data normalized"))},_computeMinMax:function(){var a=this;if(a._data){a.minMax={};var b=a._data.x,c=a._data.y,d=a._data.z;a._data.min={},a._data.max={},a._data.len={},a._data.min.x=parseFloat(a.module.getConfiguration("minX"))||Math.min.apply(null,b),a._data.min.y=parseFloat(a.module.getConfiguration("minY"))||Math.min.apply(null,c),a._data.min.z=parseFloat(a.module.getConfiguration("minZ"))||Math.min.apply(null,d),a._data.max.x=parseFloat(a.module.getConfiguration("maxX"))||Math.max.apply(null,b),a._data.max.y=parseFloat(a.module.getConfiguration("maxY"))||Math.max.apply(null,c),a._data.max.z=parseFloat(a.module.getConfiguration("maxZ"))||Math.max.apply(null,d),a._data.len.x=a._data.max.x-a._data.min.x,a._data.len.y=a._data.max.y-a._data.min.y,a._data.len.z=a._data.max.z-a._data.min.z}},_getUnitPerTick:function(a,b,c,d){var e=this;b=b?Math.min(b,a/10):a/10;for(var f=c/b,g=Math.floor(Math.log(f)/Math.log(10)),h=f*Math.pow(10,-g),i=[1,2,5,10],j=!1,k=i.length-1;k>=0;k--)(!j||Math.abs(i[k]-h)<Math.abs(j-h))&&(j=i[k]);var l=j*Math.pow(10,g),n=c/l;e._data.realMin[d]=Math.floor(e._data.min[d]/l)*l,e._data.realMax[d]=Math.ceil(e._data.max[d]/l)*l,console.log("Real min x",e._data.realMin.x,"Min x",e._data.min.x),e._data.realMin[d]!==e._data.min[d]&&n++,e._data.realMax[d]!==e._data.max[d]&&n++,e._data.intervalVal[d]=l,e._data.realLen[d]=e._data.realMax[d]-e._data.realMin[d],e._data.nbTicks[d]=Math.round((e._data.realMax[d]-e._data.realMin[d])/e._data.intervalVal[d]+1),e._data.intervalPx[d]=m/(e._data.nbTicks[d]-1),e._data.decimals[d]=g;var o=Math.floor(Math.log(l)/Math.log(10));e._data.intervalFactor[d]=Math.abs(o)<=1?1:Math.pow(10,o)},_computeTickInfo:function(){console.log("compute tick info");var a=this;a._data.realMin={},a._data.realMax={},a._data.realLen={},a._data.intervalPx={},a._data.nbTicks={},a._data.intervalVal={},a._data.decimals={},a._data.intervalFactor={},a._getUnitPerTick(m,3,a._data.len.x,"x"),a._getUnitPerTick(m,3,a._data.len.y,"y"),a._getUnitPerTick(m,3,a._data.len.z,"z")},_drawAxes:function(){var a=this;if(a._data){a._reinitObject3DArray("axes");var b=new THREE.Vector3(1,0,0),c=new THREE.Vector3(0,1,0),d=new THREE.Vector3(0,0,-1),e=(new THREE.Vector3(0,0,0),0),f=new THREE.ArrowHelper(b,new THREE.Vector3(0,0,m),m,e,1,1),g=new THREE.ArrowHelper(c,new THREE.Vector3(0,0,m),m,e,1,1),h=new THREE.ArrowHelper(d,new THREE.Vector3(m,0,m),m,e,1,1);a.axes.push(f,g,h),this.scene.add(f),this.scene.add(g),this.scene.add(h)}},_drawCircle:function(a){var a=a||{},b=new THREE.Shape,c=a.radius||s;c*=m;for(var d=0;16>d;d++){var e=(d+1)/16,f=e*Math.PI*2,g=c*Math.cos(f),h=c*Math.sin(f);0==d?b.moveTo(g,h):b.lineTo(g,h)}var i=b.makeGeometry(),j=new THREE.MeshBasicMaterial({color:a.color||q,side:THREE.DoubleSide}),k=new THREE.Mesh(i,j),l=new THREE.Matrix4,n=new THREE.Matrix4;return a.rotationAxis&&l.makeRotationAxis(new THREE.Vector3(a.rotationAxis.x||0,a.rotationAxis.y||0,a.rotationAxis.z||0),a.rotationAngle||0),n.makeTranslation(a.x||0,a.y||0,a.z||0),n.multiplyMatrices(n,l),k.applyMatrix(n),this.scene.add(k),k},_drawLine:function(a,b,c){c=c||{};var d=this,e=new THREE.LineBasicMaterial({color:c.color||0}),f=new THREE.Geometry;f.vertices.push(a),f.vertices.push(b);var g=new THREE.Line(f,e);return d.scene.add(g),g},_reinitObject3DArray:function(a){this[a]=this[a]||[];for(var b=0;b<this[a].length;b++)this.scene.remove(this[a][b]);this[a]=[]},_setGridOrigin:function(){var a=this;a.gorigin={},a.gorigin.x=parseFloat(a.module.getConfiguration("gridOriginX")||a._data.realMin.x),a.gorigin.y=parseFloat(a.module.getConfiguration("gridOriginY")||a._data.realMin.y),a.gorigin.z=parseFloat(a.module.getConfiguration("gridOriginZ")||a._data.realMin.z),a.gorigin.x=m*(a.gorigin.x-a._data.realMin.x)/a._data.realLen.x,a.gorigin.y=m*(a.gorigin.y-a._data.realMin.y)/a._data.realLen.y,a.gorigin.z=m*(a.gorigin.z-a._data.realMin.z)/a._data.realLen.z,console.log("GRID ORIGIN",a.gorigin.x,a.gorigin.y,a.gorigin.z)},_drawSecondaryGrid:function(){var a=this;a._reinitObject3DArray("secondaryGrid"),console.log("secondary grid",a._data.nbTicks.x);for(var b={color:8947848},c=a.module.getConfiguration("secondaryGrids")||2,d=0;d<a._data.nbTicks.x-1;d++)for(var e=1;c>e;e++)this._configCheckBox("grid","xysec")&&a.secondaryGrid.push(a._drawLine(new THREE.Vector3(a._data.intervalPx.x*d+a._data.intervalPx.x/c*e,0,v+a.gorigin.z),new THREE.Vector3(a._data.intervalPx.x*d+a._data.intervalPx.x/c*e,m,v+a.gorigin.z),b)),this._configCheckBox("grid","xzsec")&&a.secondaryGrid.push(a._drawLine(new THREE.Vector3(a._data.intervalPx.x*d+a._data.intervalPx.x/c*e,v+a.gorigin.y,0),new THREE.Vector3(a._data.intervalPx.x*d+a._data.intervalPx.x/c*e,v+a.gorigin.y,m),b));for(var d=0;d<a._data.nbTicks.y-1;d++)for(var e=1;c>e;e++)this._configCheckBox("grid","yzsec")&&a.secondaryGrid.push(a._drawLine(new THREE.Vector3(v+a.gorigin.x,a._data.intervalPx.y*d+a._data.intervalPx.y/c*e,0),new THREE.Vector3(v+a.gorigin.x,a._data.intervalPx.y*d+a._data.intervalPx.y/c*e,m),b)),this._configCheckBox("grid","xysec")&&a.secondaryGrid.push(a._drawLine(new THREE.Vector3(0,a._data.intervalPx.y*d+a._data.intervalPx.y/c*e,v+a.gorigin.z),new THREE.Vector3(m,a._data.intervalPx.y*d+a._data.intervalPx.y/c*e,v+a.gorigin.z),b));for(var d=0;d<a._data.nbTicks.z-1;d++)for(var e=1;c>e;e++)this._configCheckBox("grid","yzsec")&&a.secondaryGrid.push(a._drawLine(new THREE.Vector3(v+a.gorigin.x,0,a._data.intervalPx.z*d+a._data.intervalPx.z/c*e),new THREE.Vector3(v+a.gorigin.x,m,a._data.intervalPx.z*d+a._data.intervalPx.z/c*e),b)),this._configCheckBox("grid","xzsec")&&a.secondaryGrid.push(a._drawLine(new THREE.Vector3(0,v+a.gorigin.y,a._data.intervalPx.z*d+a._data.intervalPx.z/c*e),new THREE.Vector3(m,v+a.gorigin.y,a._data.intervalPx.z*d+a._data.intervalPx.z/c*e),b))},_drawGrid:function(){var a=this;a._reinitObject3DArray("grid");for(var b=0;b<a._data.nbTicks.x;b++)this._configCheckBox("grid","xy")&&a.grid.push(a._drawLine(new THREE.Vector3(a._data.intervalPx.x*b,0,v+a.gorigin.z),new THREE.Vector3(a._data.intervalPx.x*b,m,v+a.gorigin.z))),this._configCheckBox("grid","xz")&&a.grid.push(a._drawLine(new THREE.Vector3(a._data.intervalPx.x*b,v+a.gorigin.y,0),new THREE.Vector3(a._data.intervalPx.x*b,v+a.gorigin.y,m)));for(var b=0;b<a._data.nbTicks.y;b++)this._configCheckBox("grid","yz")&&a.grid.push(a._drawLine(new THREE.Vector3(v+a.gorigin.x,a._data.intervalPx.y*b,0),new THREE.Vector3(v+a.gorigin.x,a._data.intervalPx.y*b,m))),this._configCheckBox("grid","xy")&&a.grid.push(a._drawLine(new THREE.Vector3(0,a._data.intervalPx.y*b,v+a.gorigin.z),new THREE.Vector3(m,a._data.intervalPx.y*b,v+a.gorigin.z)));for(var b=0;b<a._data.nbTicks.z;b++)this._configCheckBox("grid","yz")&&a.grid.push(a._drawLine(new THREE.Vector3(v+a.gorigin.x,0,a._data.intervalPx.z*b),new THREE.Vector3(v+a.gorigin.x,m,a._data.intervalPx.z*b))),this._configCheckBox("grid","xz")&&a.grid.push(a._drawLine(new THREE.Vector3(0,v+a.gorigin.y,a._data.intervalPx.z*b),new THREE.Vector3(m,v+a.gorigin.y,a._data.intervalPx.z*b)))},_drawTicks:function(){var a=this;if(a._reinitObject3DArray("ticks"),a._configCheckBox("ticks","x"))for(var b=0;b<a._data.nbTicks.x;b++)a.ticks.push(a._drawLine(new THREE.Vector3(a._data.intervalPx.x*b,0,m),new THREE.Vector3(a._data.intervalPx.x*b,0,1.05*m)));if(a._configCheckBox("ticks","y"))for(var b=0;b<a._data.nbTicks.y;b++)a.ticks.push(a._drawLine(new THREE.Vector3(0,a._data.intervalPx.y*b,m),new THREE.Vector3(-.05*m,a._data.intervalPx.y*b,m)));if(a._configCheckBox("ticks","z"))for(var b=0;b<a._data.nbTicks.z;b++)a.ticks.push(a._drawLine(new THREE.Vector3(m,0,a._data.intervalPx.z*b),new THREE.Vector3(1.05*m,0,a._data.intervalPx.z*b)))},_addText:function(a,b,c,d,e){var f=this,e=e||{};e.size=e.size||50,e.fillStyle=e.fillStyle||k(f.module.getConfiguration("annotationColor"))||u,e.textAlign=e.textAlign||"left",e.font=e.font||"Arial",e.opacity=e.opacity||.99;var g=document.createElement("canvas");switch(g.height=1.2*e.size,g.width=e.size*a.length/2+e.size/2,e.textAlign){case"left":b+=g.width/2;break;case"right":b-=g.width/2}var h=g.getContext("2d");h.font="Bold "+e.size+"px "+e.font,h.fillStyle=e.fillStyle,h.fillText(a,0,e.size);var i=new THREE.Texture(g);i.needsUpdate=!0;var j=new THREE.MeshBasicMaterial({map:i,transparent:1===e.opacity?!1:!0,opacity:e.opacity}),l=new THREE.Mesh(new THREE.PlaneGeometry(g.width,g.height),j),m=f.camera.matrix.clone();return m.setPosition(new THREE.Vector3(0,0,0)),l.applyMatrix(m),l.position.set(b,c,d),l.castShadow=!1,l.receiveShadow=!1,f.scene.add(l),l},_drawTickLabels:function(){var a=this;if(a._reinitObject3DArray("tickLabels"),a._configCheckBox("ticks","zlab"))for(var b=0;b<a._data.nbTicks.z;b++){var c=((a._data.realMin.z+b*a._data.intervalVal.z)/a._data.intervalFactor.z).toString();a.tickLabels.push(a._addText(c,1.1*m,0,b*a._data.intervalPx.z,{textAlign:"left"}))}if(a._configCheckBox("ticks","ylab"))for(var b=0;b<a._data.nbTicks.y;b++){var c=((a._data.realMin.y+b*a._data.intervalVal.y)/a._data.intervalFactor.y).toString();a.tickLabels.push(a._addText(c,-.05*m,b*a._data.intervalPx.y,m,{textAlign:"right"}))}if(a._configCheckBox("ticks","xlab"))for(var b=0;b<a._data.nbTicks.x;b++){var c=((a._data.realMin.x+b*a._data.intervalVal.x)/a._data.intervalFactor.x).toString();a.tickLabels.push(a._addText(c,b*a._data.intervalPx.x,0,1.1*m,{textAlign:"right"}))}},_drawGraphTitle:function(){var a=this;a._reinitObject3DArray("graphTitle");var b=a.module.getConfiguration("labels"),c=a._meta.title||"";if(c&&""!==c)switch(b){case"none":return;default:a.graphTitle.push(a._addText(c,m/10,1.3*m,100,{textAlign:"left"}))}},_drawAxisLabels:function(){function a(a,b,c){var d=[];d.push("X: "+a),d.push("Y: "+b),d.push("Z: "+c),$("#legend_titles").html(d.join("<br/>"))}function b(a,b,d){e.tickLabels.push(e._addText(c(a,"x"),m/2,0,1.4*m,{textAlign:"right"})),e.tickLabels.push(e._addText(c(b,"y"),-.4*m,m/2,m,{textAlign:"right"})),e.tickLabels.push(e._addText(c(d,"z"),1.4*m,0,m/2,{textAlign:"left"}))}function c(a,b){return 1===e._data.intervalFactor[b]?a:e._data.intervalFactor[b]>1?a+" (× 10"+d(Math.round(Math.log(e._data.intervalFactor[b])/Math.LN10))+")":a+" (× 10"+d("-"+-Math.round(Math.log(e._data.intervalFactor[b])/Math.LN10))+")"}function d(a){for(var a=a.toString(),b="",c=0;c<a.length;c++)parseInt(0/0===a[c])||("2"===a[c]||"3"===a[c]?b+=String.fromCharCode(176+parseInt(a[c])):a[c]>="0"&&a[c]<"9"?b+=String.fromCharCode(8304+parseInt(a[c])):"-"===a[c]&&(b+=String.fromCharCode(8315)));return b}var e=this;e._reinitObject3DArray("axisLabels");var f=e.module.getConfiguration("labels"),g=e._data.xAxis?e._data.xAxis:null,h=e._data.yAxis?e._data.xAxis:null,i=e._data.yAxis?e._data.xAxis:null;console.log("xAxis",e._data),console.log("meta",e._meta);var j=g&&e._meta.axis&&e._meta.axis[g]?e._meta.axis[g].name:"X",k=h&&e._meta.axis&&e._meta.axis[h]?e._meta.axis[h].name:"Y",l=i&&e._meta.axis&&e._meta.axis[i]?e._meta.axis[i].name:"Z";switch(console.log("xtitle",j),f){case"axis":b(j,k,l),$("#legend_titles").hide();break;case"alegend":b("X","Y","Z"),a(j,k,l),$("#legend_titles").show();break;case"both":b(j,k,l),a(j,k,l),$("#legend_titles").show();break;default:return}},_drawFaces:function(){var a=this;if(a._data){a._reinitObject3DArray("faces");var b,c,d,e=new THREE.PlaneGeometry(m,m),f=new THREE.PlaneGeometry(m,m),g=new THREE.PlaneGeometry(m,m),h=new THREE.PlaneGeometry(m,m),i=new THREE.PlaneGeometry(m,m),j=new THREE.PlaneGeometry(m,m),k=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide,transparent:!0,opacity:.6}),l=new THREE.Mesh(e,k),n=new THREE.Mesh(f,k),o=new THREE.Mesh(g,k),p=new THREE.Mesh(h,k),q=new THREE.Mesh(i,k),r=new THREE.Mesh(j,k);b=new THREE.Matrix4,c=new THREE.Matrix4,d=new THREE.Matrix4,b.makeTranslation(m/2,m/2,a.gorigin.z),c.makeTranslation(0,0,m/2),l.applyMatrix(b),c.multiplyMatrices(b,c),p.applyMatrix(c),b=new THREE.Matrix4,c=new THREE.Matrix4,d=new THREE.Matrix4,b.makeRotationY(Math.PI/2),c.makeTranslation(-m/2,m/2,a.gorigin.x),c.multiplyMatrices(b,c),d.makeTranslation(0,0,m),n.applyMatrix(c),d.multiplyMatrices(c,d),q.applyMatrix(d),b=new THREE.Matrix4,c=new THREE.Matrix4,d=new THREE.Matrix4,b.makeRotationX(Math.PI/2),c.makeTranslation(m/2,m/2,-a.gorigin.y),c.multiplyMatrices(b,c),o.applyMatrix(c),d.makeTranslation(0,0,-m),d.multiplyMatrices(c,d),r.applyMatrix(d),p.visible=!1,q.visible=!1,r.visible=!1,a.faces.push(l),a.faces.push(n),a.faces.push(o);for(var s=0;s<a.faces.length;s++)a.scene.add(a.faces[s])}},_inBoundary:function(a){var b=this;return e.isObject(a)?a.x<b._data.realMin.x||a.x>b._data.realMax.x?!1:a.y<b._data.realMin.y||a.y>b._data.realMax.y?!1:a.z<b._data.realMin.z||a.z>b._data.realMax.z?!1:!0:e.isArray(a)?b._inBoundary({x:a[0],y:a[1],z:a[2]}):!1},_computeInBoundaryIndexes:function(){var a=this;a._data.inBoundary=[];for(var b=0;b<a._data.x.length;b++)a._data.inBoundary.push(a._inBoundary({x:a._data.x[b],y:a._data.y[b],z:a._data.z[b]})?!0:!1)},_mathPoints:function(){var a=this;if(a._data){a.mathPoints=[];for(var b=0;b<a._data.x.length;b++)if(a._data.inBoundary[b]){var c=s;if(a._data.size&&a._data.size[b])var c=a._data.size[b];var d=new THREE.Sphere(new THREE.Vector3(a._data.normalizedData.x[b],a._data.normalizedData.y[b],a._data.normalizedData.z[b]),c*m);d.index=b,a.mathPoints.push(d)}}},_updateMathPoints:function(a){var b,c=this;if(a.applyFilter){b=c._data.inBoundary.slice(0);for(var d=0;d<c._dispFilter.length;d++)b[d]=c._dispFilter[d]&&b[d]}else b=c._data.inBoundary;for(var d=0;d<c._data.x.length;d++)c.mathPoints[d].radius=b[d]?c._data.size[d]*m:0},_zoomToFit:function(){console.log("Zoom to fit");var a=this,b=Math.PI/3,c=Math.PI/4,d=m*o,e=this._polarToCartesian(b,c,d);e=new THREE.Vector3(e[0],e[1],e[2]);var f=new THREE.Vector3(m/2,m/2,m/2);a.camera.position=e,a.camera.lookAt(f)},_polarToCartesian:function(a,b,c){var d=Math.sin(b)*Math.cos(a)*c,e=Math.sin(b)*Math.sin(a)*c,f=Math.cos(b)*c;return[d,e,f]},init:function(){this.DEBUG&&console.log("Scatter 3D: init"),this.dom||(this._id=d.getNextUniqueId(),this.dom=$(' <div id="'+this._id+'"></div>').css("height","100%").css("width","100%"),this.module.getDomContent().html(this.dom)),this.dom&&this.dom.empty(),this._flot&&delete this._flot,this.loadedData=$.Deferred(),this.resolveReady(),this.DEBUG&&console.log("Scatter 3D: ID: "+this._id)},onResize:function(){console.log("In onResize");var a=this;this.DEBUG&&console.log("Scatter 3D: onResize"),this.loadedData.done(function(){a._initThreejs(),a._firstLoad&&(a._activateHighlights(),a._zoomToFit(),a._firstLoad=!1),a._data&&a._drawGraph(),console.log("loadedData done")})},_newParticleObject:function(a,b){var c=this;b=b||{};var d=y[b.shape]||y[t];b.transparent&&(d=d.replace(/\.(png|svg|jpeg|jpg|gif)$/i,"t.$1")),console.log("IMAGE repalce:",d),attributes={size:{type:"f",value:[]},ca:{type:"c",value:[]}},uniforms={amplitude:{type:"f",value:1},color:{type:"c",value:new THREE.Color("#e5be39")},texture:{type:"t",value:THREE.ImageUtils.loadTexture(d)}};var e=new THREE.ShaderMaterial({uniforms:uniforms,attributes:attributes,vertexShader:"			attribute float size;			attribute vec4 ca;			varying vec4 vColor;			void main() {				vColor = ca;				vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );				gl_PointSize = size * ( 1.0 / length( mvPosition.xyz ) );				gl_Position = projectionMatrix * mvPosition;			}",fragmentShader:"uniform vec3 color;			uniform sampler2D texture;			varying vec4 vColor;			void main() {				vec4 outColor = texture2D( texture, gl_PointCoord );				if ( outColor.a < 0.5 ) discard;				gl_FragColor = outColor * vec4( color * vColor.xyz, 1.0 );				float depth = gl_FragCoord.z / gl_FragCoord.w;				const vec3 fogColor = vec3( 0.0 );				float fogFactor = smoothstep( 0.0, 10000.0, depth );				gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );			}",transparent:!0}),f=new THREE.Geometry;if(a)for(var g=0;g<a.length;g++){var h=new THREE.Vector3;h.x=c._data.normalizedData.x[a[g]],h.y=c._data.normalizedData.y[a[g]],h.z=c._data.normalizedData.z[a[g]],f.vertices.push(h)}else for(var g=0;g<c._data.normalizedData.x.length;g++){var h=new THREE.Vector3;h.x=c._data.normalizedData.x[g],h.y=c._data.normalizedData.y[g],h.z=c._data.normalizedData.z[g],f.vertices.push(h)}var i=new THREE.ParticleSystem(f,e);return i.indexes=a,i},_updateParticleObject:function(a,b){if(a){var c=this;b=b||{};var d,e=a.indexes,f=a.geometry.vertices,g=a.material.attributes.size.value,h=a.material.attributes.ca.value,i=c._data.color,j=c._data.size,k=2.2388*(b.sizeFactor||1)*m*c.dom.height(),l=b.forcedColor?new THREE.Color(b.forcedColor):null,n=b.updateColor||!0;if(b.applyFilter){d=c._data.inBoundary.slice(0);for(var o=0;o<c._dispFilter.length;o++)d[o]=c._dispFilter[o]&&d[o]}else d=c._data.inBoundary;if(e)for(var p=0;p<f.length;p++)g[p]=d[e[p]]?(j[e[p]]||s)*k:-1,l?h[p]=l:n&&(h[p]=new THREE.Color(i[p]||r));else for(var p=0;p<f.length;p++)g[p]=d[p]?(j[p]||s)*k:0,l?h[p]=l:n&&(h[p]=new THREE.Color(i[p]||r));a.material.attributes.size.needsUpdate=!0,c.renderer.render(c.scene,c.camera)}},_prepareHighlights:function(a){var b=this;b._highlightParticleObjects=b._highlightParticleObjects||{};for(var c={},d=0;d<a.length;d++)c[b._data.shape[d]]=c[b._data.shape[d]]||{},c[b._data.shape[d]][a[d]]=c[b._data.shape[d]][a[d]]||[],c[b._data.shape[d]][a[d]].push(d);for(var e in c)for(var f in c[e]){var g=(new Date).getTime();b._highlightParticleObjects[e]=b._highlightParticleObjects[e]||{},b._highlightParticleObjects[e][f]=b._newParticleObject(c[e][f],{shape:e||t,transparent:!0}),b._updateParticleObject(b._highlightParticleObjects[e][f],{sizeFactor:1.5,forcedColor:"#e5be39"}),console.log("highlight time:",(new Date).getTime()-g)}},_updatePoints:function(){},update:{chart:function(a){return this.DEBUG&&console.log("Scatter 3D: update from chart object"),console.log("module value on update",a),a.get()?(this._convertChartToData(a.get()),this._computeMinMax(),this._computeTickInfo(),this._computeInBoundaryIndexes(),this._normalizeData(),this._setGridOrigin(),this._updateChartData(),this._firstLoad||this._activateHighlights(),console.log("moduleValue.get(): ",this._data),console.log("state:",this.loadedData.state()),void("pending"===this.loadedData.state()?this.loadedData.resolve():(console.log("points changed"),this._drawGraph()))):void console.error("Unvalid value",a)},data3D:function(a){return console.log("data3d received"),console.log("Scatter 3D: update from data3D object"),a&&a.get()?(this._convertData3dToData(a.get()),console.log(this._data),this._computeMinMax(),this._computeTickInfo(),this._computeInBoundaryIndexes(),this._normalizeData(),this._setGridOrigin(),this._updateChartData(),this._firstLoad||this._activateHighlights(),console.log("moduleValue.get(): ",this._data),console.log("state:",this.loadedData.state()),void("pending"===this.loadedData.state()?this.loadedData.resolve():(console.log("points changed"),this._drawGraph()))):void console.error("Unvalid value",a)},boolArray:function(a){if(console.log("bool array received"),this._data&&this._mainParticleObjects){var b=this;if(!a||!a.get())return void console.error("Unvalid value boolArray",a);b._dispFilter=a.get();for(var c in b._mainParticleObjects)b._updateParticleObject(b._mainParticleObjects[c],{applyFilter:!0,updateColor:!1});b._updateMathPoints({applyFilter:!0});for(var c in b._highlightParticleObjects)for(var d in b._highlightParticleObjects[c])b._updateParticleObject(b._highlightParticleObjects[c][d],{applyFilter:!0,updateColor:!1,sizeFactor:1.5})}}},_render:function(){var a=this;setTimeout(function(){a.renderer.render(a.scene,a.camera,0)},20)},_convertData3dToData:function(a){var b=this;(!a instanceof Array||0===a.length)&&console.error("Data 3D not valid"),b._data={};for(var c=0;c<a.length;c++)for(var d in a[c])b._data[d]?b._data[d].push(a[c][d]):b._data[d]=[a[c][d]];b._meta={},b._data._highlight=b._data._highlight||[],b._data.info=b._data._info||[],b._dispFilter=b._dispFilter||[]},_convertChartToData:function(a){this._data={},this._meta={};var b=this;if(!(!a.data instanceof Array||!a.data[0]||!a.data[0].y instanceof Array)){a.data.length>0&&console.log("Scatter 3D module will merge series together");for(var c=0;c<a.data.length;c++)e.keys(a.data[c]).forEach(function(d){a.data[c][d]instanceof Array?(b._data[d]=b._data[d]||[],b._data[d].push(a.data[c][d]),b._data[d]=e.flatten(b._data[d],!0)):b._data[d]=a.data[c][d],e.filter(b._data[d],function(a){return void 0!==a})});e.keys(a).forEach(function(c){"data"!==c&&(b._meta[c]=a[c])}),b._dispFilter=b._dispFilter||[],console.log("meta: ",b._meta);var d=1e3;b._data.x=f(d,0,5),b._data.y=f(d,0,5),b._data.z=f(d,0,5),b._data.size=f(d,.01,.02),b._data.color=h(d),b._data._highlight=g(["A","B","C","D"],d),console.log("Converted data: ",b._data)}},_completeDataInfo:function(a,b){var c=this;c._data[a]=c._data[a]||[];for(var d=0;d<c._data.x.length;d++)c._data[a][d]||(c._data[a][d]=b)},_updateChartData:function(){this._completeDataInfo("size",s),this._completeDataInfo("color",r),this._completeDataInfo("shape",t)},_activateHighlights:function(){function a(a){f._prepareHighlights(a);var g=e.uniq(a);e.keys(g).forEach(function(a){g[a]&&c.listenHighlight({_highlight:g[a]},function(a,c){a?d(c):b(c)})})}function b(a){var b=!1;for(var c in f._highlightParticleObjects)f._highlightParticleObjects[c][a]&&f._highlightParticleObjects[c][a].drawn&&(f.scene.remove(f._highlightParticleObjects[c][a]),f._highlightParticleObjects[c][a].drawn=!1,b=!0);b&&f._render()}function d(a){console.log("draw highlights",a);for(var b in f._highlightParticleObjects)if(f._highlightParticleObjects[b][a]){if(f._highlightParticleObjects[b][a].drawn===!0)return;f.scene.add(f._highlightParticleObjects[b][a]),f._highlightParticleObjects[b][a].drawn=!0,f._render()}}var f=this;if(f._data){c.killHighlight(f.module.getId());console.log("-----"),f._data._highlight&&(console.log("listen highlights"),a(f._data._highlight));var g=e.flatten(e.pluck(f._data.info,"_highlight"));g&&a(g)}},updateOptions:function(){console.log("update options"),this._options={grid:{clickable:!0,hoverable:!0},series:{pie:{show:!0}}}}}),l});