requirejs.config({shim:{"components/leaflet/dist/leaflet":{exports:"L",init:function(){return this.L.noConflict()}}}}),define(["modules/default/defaultview","src/util/util","src/util/api","components/leaflet/dist/leaflet"],function(a,b,c,d){function e(){this.mapID=b.getNextUniqueId()}function f(a){return new i({marker:a,iconAnchor:a.center})}function g(a){var b=this.options=$.extend({},g.defaultOptions,a);switch(this.div=$("<div>"),this.kind=b.kind,b.kind){case"image":this.div=$('<img src="'+b.img+'">');break;case"circle":this.div.css("border-radius",b.size);default:this.div.css("background",b.color)}this.div.css({width:this.width,height:this.height})}function h(a){var b=a.feature.properties||{},e=this;this.module.data=b;var h;if(a instanceof d.Marker){var i={};b instanceof DataObject&&$.extend(i,b.getChildSync(this.markerjpath));var j=new g(i);h=f(j),a.setIcon(h)}c.listenHighlight(b,function(b){b?a instanceof d.Marker?h._marker.highlight(!0):a.setStyle({color:"#ff3300"}):a instanceof d.Marker?h._marker.highlight(!1):a.setStyle(a.feature&&a.feature.properties&&a.feature.properties.style?a.feature.properties.style:{color:"#0033ff"})},!1,this.module.getId()),a.addEventListener({mouseover:function(){e.module.controller.hoverElement(b)},click:function(){e.module.controller.clickElement(b)},mouseout:function(){c.highlight(b,0)}},this)}b.loadCss("components/leaflet/dist/leaflet.css");var i=d.Icon.extend({createIcon:function(){this._marker=this.options.marker;var a=this._marker.div[0];return this._setIconStyles(a,"icon"),a},createShadow:function(){return null}});return g.defaultOptions={size:30,color:"rgba(1,1,1,0.5)",kind:"circle"},g.setDefaultOptions=function(a){$.extend(g.defaultOptions,a)},g.prototype={highlight:function(a){a?"image"===this.kind&&this.options.imgHighlight?this.div.attr("src",this.options.imgHighlight):this.div.css("border","solid"):"image"===this.kind&&this.options.imgHighlight?this.div.attr("src",this.options.img):this.div.css("border","none")},get center(){return"image"===this.kind?[this.width/2,this.height]:[this.width/2,this.height/2]},get width(){return this.options.width||this.options.height||this.options.size},get height(){return this.options.height||this.options.width||this.options.size}},e.prototype=$.extend(!0,{},a,{init:function(){this.mapLayers={},this.dom=$('<div id="'+this.mapID+'"></div>').css({height:"100%",width:"100%"}),this.module.getDomContent().html(this.dom),c.killHighlight(this.module.getId()),g.setDefaultOptions({kind:this.module.getConfiguration("markerkind"),color:b.getColor(this.module.getConfiguration("markercolor")),size:parseInt(this.module.getConfiguration("markersize")),img:"components/leaflet/dist/images/marker-icon.png",imgHighlight:"modules/types/chart/maps/leaflet/marker-icon-red.png"}),this.markerjpath=this.module.getConfiguration("markerjpath")},inDom:function(){function a(){b.module.controller.moveAction.call(b),b.module.controller.zoomAction.call(b)}this.dom.empty();var b=this;this.map=d.map(this.mapID,{zoomAnimation:!1}),this.getTileLayer().addTo(b.map),this.map.on("drag",b.module.controller.moveAction,b),this.map.on("zoomend",a);var c,e=[46.522117,6.566144],f=this.module.getConfiguration("mapcenter");c=f?Promise.resolve(f):new Promise(function(a){window.navigator&&window.navigator.geolocation?navigator.geolocation.getCurrentPosition(function(b){a([b.coords.latitude,b.coords.longitude])},function(){a(e)}):a(e)}),c.then(function(a){var c=b.module.getConfiguration("mapzoom")||10;b.map.setView(a,c),b.resolveReady()})},blank:{geojson:function(a){this.mapLayers.hasOwnProperty(a)&&(this.mapLayers[a].clearLayers(),delete this.mapLayers[a])}},update:{position:function(a){2===a.length&&this.map.setView(d.latLng(a[0],a[1]))},geojson:function(a,b){if(a){var c=a.get(),e=d.geoJson(c,{style:function(a){return a.properties&&a.properties.style}});e.addTo(this.map),this.mapLayers[b]=e,e.eachLayer(h,this)}}},onResize:function(){this.map.invalidateSize()},onActionReceive:{position:function(a){this.map.setView(d.latLng(a[0],a[1]))},zoom:function(a){var b=this.map.getMinZoom(),c=this.map.getMaxZoom();b>a?a=b:a>c&&(a=c),this.map.setZoom(a)}},getTileLayer:function(){var a=this.module.getConfiguration("maptiles")||"osm",b={parameters:{}};switch(a){case"hb":b.template="http://toolserver.org/tiles/hikebike/{z}/{x}/{y}.png";break;case"osm":default:b.template="http://{s}.tile.osm.org/{z}/{x}/{y}.png",b.parameters.attribution='&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}return d.tileLayer(b.template,b.parameters)}}),e});