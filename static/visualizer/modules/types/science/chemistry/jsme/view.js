define(["require","modules/default/defaultview","src/util/api"],function(a,b,c){function d(){}var e={};return window.addEventListener("message",function(a){try{var b=JSON.parse(a.data)}catch(c){return}if("jsme"===b.module){var d=b.id;if(!e[d])return void console.error("No view with ID "+d);var f=e[d];switch(b.type){case"ready":f.resolveReady();break;case"onChange":f.module.controller.onChange(b.message.mol,b.message.smiles,b.message.jme);break;case"doHighlight":f._doHighlight(b.message.mol,b.message.atom);break;default:console.error("Message type not handled: ",b.type)}}}),d.prototype=$.extend(!0,{},b,{init:function(){var b=this,c=this.module.getId();e[c]=this,this.dom=$("<iframe>",{src:a.toUrl("./lib/jsme.html")}).css("border",0),this.module.getDomContent().html(this.dom),this.dom.bind("load",function(){b.postMessage("init",{prefs:b.getPrefs(),highlightColor:b.getHighlightColor(),bondwidth:b.module.getConfiguration("bondwidth"),labelsize:b.module.getConfiguration("labelsize"),id:c})})},getPrefs:function(){return this.module.getConfiguration("prefs").join()},getHighlightColor:function(){return this.module.getConfiguration("highlightColor","3")},onResize:function(){this.dom.attr("width",this.width),this.dom.attr("height",this.height),this.module.getDomContent().css("overflow","hidden"),this.postMessage("setSize",{width:this.width,height:this.height})},onProgress:function(){this.dom.html("Progress. Please wait...")},blank:{mol:function(){this.postMessage("clear","*")},jme:function(){this.postMessage("clear","*")}},update:{mol:function(a){this._currentValue=a,this._currentType="mol",a.get()&&(this.postMessage("setMolFile",a.get()),this._initHighlight(a))},jme:function(a){this._currentValue=a,this._currentType="jme",a.get()&&(this.postMessage("setJmeFile",a.get()),this._initHighlight(a))}},_initHighlight:function(a){var b=this;c.killHighlight(this.module.getId()),c.listenHighlight(a,function(c,d){for(var e=[],f=0,g=d.length;g>f;f++)a._atoms[d[f]]instanceof Array||(a._atoms[d[f]]=[a._atoms[d[f]]]),e=e.concat(a._atoms[d[f]]);b.postMessage("setHighlight",{atoms:e,onOff:c})},!1,this.module.getId())},_doHighlight:function(a,b){if(this._currentValue){for(var d in this._currentValue._atoms)this._currentValue._atoms[d].indexOf(this.highlightedAtom)>-1&&c.highlightId(d,!1);for(var d in this._currentValue._atoms)0!=b&&this._currentValue._atoms[d].indexOf(b-1)>-1&&c.highlightId(d,1);this.highlightedAtom=b-1}},postMessage:function(a,b){var c=this.dom.get(0).contentWindow;c&&c.postMessage(JSON.stringify({type:a,message:b}),"*")},remove:function(a){delete e[a]}}),d});