define(["jquery","lib/plot/plot"],function(a,b){var c=function(){this.gcSeries=[],this.msData=null,this.firstMs=!0,this.firstRange=!0,this.msContinuous=!1,this.rangeLimit=!1};return c.prototype={inDom:function(a,c){var d=this,e={paddingTop:5,paddingBottom:0,paddingLeft:20,paddingRight:20,close:{left:!0,right:!0,top:!0,bottom:!0},title:"",zoomMode:"x",defaultMouseAction:"zoomX",defaultWheelAction:"zoomY",shiftMouseAction:"rangeX",lineToZero:!1,unZoomMode:"gradualX",rangeLimitX:parseInt(this.rangeLimit)||1,plugins:["zoom","drag","integral"],onRangeX:function(){},onAnnotationSelect:function(a){switch(a.type){case"verticalLine":break;case"surfaceUnderCurve":d.selectAnnot(a),d.onIntegralSelect(a)}},onAnnotationChange:function(a){d.selectAnnot(a),d.onAnnotationChange(a)},onAnnotationRemove:function(a){d.onAnnotationRemove(a)},onAnnotationMake:function(a){return a=new DataObject(a,!0),d.onAnnotationMake(a),a},onAnnotationUnselect:function(){d.serieIntegral&&(d.serieIntegral.kill(!0),d.serieIntegral=!1)},onRangeXRemove:function(a){a.serie&&(a.serie.kill(!0),a.serie=!1)},onMouseMoveData:function(a,b){for(var c in b)break;if(void 0!=b[c]){var e=b[c].xBeforeIndex,f=d.msData[e];d.msSerie&&(d.msSerie.kill(!0),d.msSerie=!1),f&&(d.msSerie=d.ms.newSerie("",{lineToZero:!this.msContinuous}),d.msSerie.autoAxis(),d.msSerie.setData(f),d.ms.getLeftAxis().setMaxValue(d.ms.getBoundaryAxisFromSeries(d.ms.getLeftAxis(),"y","max")),d.ms.getLeftAxis().setMinMaxToFitSeries(),d.ms.redraw(!d.firstMs),d.firstMs=!1,d.ms.drawSeries())}}},f={bottom:[{labelValue:"Time",unitModification:"time",primaryGrid:!1,nbTicksPrimary:10,secondaryGrid:!1,axisDataSpacing:{min:0,max:.1},onZoom:function(a,b){d.onZoomGC&&d.onZoomGC(a,b)}}],left:[{labelValue:"Intensity (-)",ticklabelratio:1,primaryGrid:!0,secondaryGrid:!1,nbTicksPrimary:3,exponentialFactor:-7,forcedMin:0,display:!1}]},g={paddingTop:5,paddingBottom:0,paddingLeft:20,paddingRight:20,close:{left:!0,right:!0,top:!0,bottom:!0},title:"",zoomMode:"x",defaultMouseAction:"zoom",defaultWheelAction:"zoomY",plugins:["zoom","drag","verticalLine"],onAnnotationMake:function(a){a._msIon=new DataObject({name:a.id,data:[],lineColor:a.fillColor||a.strokeColor,lineWidth:"2"}),this.options.onAnnotationChange(a),d.onAnnotationMake(a)},onAnnotationChange:function(a){for(var b,c,e,a=new DataObject(a,!0),e=a.pos.x,f=[],g=0,h=d.msData.length;h>g;g++){for(b=d.searchBinaryIndexMs(g,e),c=b,valAdd=0;d.msData[g][c]>e-.3;)valAdd+=d.msData[g][c+1],c-=2;for(c=b+2;d.msData[g][c]<e+.7;)valAdd+=d.msData[g][c+1],c+=2;f.push(d.gcData[2*g]),f.push(valAdd)}a._msIon.data=f,a._msIon.triggerChange()}},h={bottom:[{labelValue:"m/z",unitModification:!1,primaryGrid:!1,nbTicksPrimary:10,nbTicksSecondary:4,secondaryGrid:!1,axisDataSpacing:{min:0,max:.1},onZoom:function(a,b){d.onZoomMS&&d.onZoomMS(a,b)}}],left:[{labelValue:"Intensity (-)",ticklabelratio:1,primaryGrid:!0,nbTicksSecondary:4,secondaryGrid:!1,scientificTicks:!0,nbTicksPrimary:3,forcedMin:0,axisDataSpacing:{min:0,max:.2}}],right:[{primaryGrid:!1,secondaryGrid:!1,nbTicksSecondary:5,axisDataSpacing:{min:0,max:.2}}]};this.gc=new b(a,e,f),this.ms=new b(c,g,h)},selectAnnot:function(a){var b=this,c=a.pos.x,d=a.pos2.x,e=b.gcSeries[0].searchClosestValue(c).xBeforeIndex,f=b.gcSeries[0].searchClosestValue(d).xBeforeIndex,g=Math.min(e,f),h=Math.max(e,f);if(h!=g){var i,j,k,m=[],n=[];for(i=g;h>=i;i++)for(j=0,l=b.msData[i].length;l>j;j+=2)k=Math.floor(b.msData[i][j]+.3),m[k]?m[k]+=b.msData[i][j+1]:(m[k]=b.msData[i][j+1],n.push(k));n.sort(function(a,b){return a-b});for(var o=[],i=0;i<n.length;i++)o.push(n[i]),o.push(Math.round(m[n[i]]/Math.abs(h-g)));b.serieIntegral&&(b.serieIntegral.kill(!0),b.serieIntegral=!1),b.serieIntegral=b.ms.newSerie("av",{lineToZero:!this.msContinuous}),b.serieIntegral.autoAxis(),b.serieIntegral.setYAxis(b.ms.getRightAxis()),b.serieIntegral.setData(o),b.serieIntegral.options.autoPeakPicking=!0,b.serieIntegral.setLineColor(a.strokeColor||a.fillColor),b.ms.getRightAxis().setMaxValue(b.ms.getBoundaryAxisFromSeries(b.ms.getRightAxis(),"y","max")),b.ms.getRightAxis().setMinMaxToFitSeries(),b.ms.redraw(!b.firstRange),b.firstRange=!1,b.ms.drawSeries(),b.onMSSelect(o,a)}},unload:function(){this.gc.kill(),this.ms.kill()},zoomOn:function(a,b){this.gc.getBottomAxis()._doZoomVal(a-.4*(b-a),b+.4*(b-a)),this.gc.getLeftAxis().scaleToFitAxis(this.gc.getBottomAxis(),a,b),this.gc.redraw(!0),this.gc.drawSeries()},setMSContinuous:function(a){this.msContinuous=a},setRangeLimit:function(a){this.rangeLimit=a},resize:function(a,b){this.gc.resize(a-10,b/2-10),this.ms.resize(a-10,b/2-10),this.gc.redraw(),this.gc.drawSeries(),this.ms.drawSeries()},getGC:function(){return this.gc},getMS:function(){return this.ms},searchBinaryIndexMs:function(a,b){var c=this.msData[a],d=b,e=!1,f=0,g=c.length,h=g-2;if(c[f]==d)return f;if(c[h]==d)return h;for(var i,j=0;;){if(j++,j>100)throw"Error loop";if(i=(f+h)/2,i-=i%2,i==f||c[i]==d)return i;c[i]<=d?e?h=i:f=i:c[i]>d&&(e?f=i:h=i)}},blank:function(){for(var a=0,b=this.gcSeries.length;b>a;a++)this.gcSeries[a].kill();this.gcSeries=[],this.msSerie&&(this.msSerie.kill(!0),this.msSerie=!1)},setGC:function(a){var b;if(this.gc){this.blank(),this.gcSeries=[];for(var c in a)b=this.gc.newSerie(c,{areaUnderLine:!0,useSlots:!0}),this.gcSeries.push(b),b.setData(a[c]),b.autoAxis(),this.gc.redraw(),this.gc.drawSeries(),this.gcData=a[c]}},setMS:function(a){this.msData=a},msIonAdded:function(){},setExternalGC:function(a){this.extGC&&this.extGC.kill(!0),this.extGC=this.gc.newSerie("external",{useSlots:!0,lineWidth:2,lineColor:"red"}),this.extGC.setXAxis(this.gc.getXAxis()),this.extGC.setYAxis(this.gc.getRightAxis(0,{primaryGrid:!1,secondaryGrid:!1,axisDataSpacing:{min:0,max:0},display:!1})),this.extGC.setData(a),this.gc.redraw(),this.gc.drawSeries()},setExternalMS:function(a,b){this.extMS&&this.extMS.kill(!0),this.extMS=this.ms.newSerie("external",{useSlots:!1,lineToZero:!b,lineWidth:3,lineColor:"rgba(0, 0, 255, 0.2)"}),this.extMS.setXAxis(this.ms.getXAxis()),this.extMS.setYAxis(this.ms.getRightAxis(1,{primaryGrid:!1,secondaryGrid:!1,axisDataSpacing:{min:0,max:0},display:!1})),this.extMS.setData(a),this.ms.redraw(!0,!0,!1),this.ms.drawSeries()}},c});