define(["modules/default/defaultview","src/util/util","underscore","components/jquery.panzoom/dist/jquery.panzoom","components/jquery-mousewheel/jquery.mousewheel"],function(a,b,c){function d(){this.selectingArea=!1,this.imgWidth=[],this.imgHeight=[]}return d.prototype=$.extend(!0,{},a,{init:function(){b.loadCss("components/jcrop/css/jquery.Jcrop.css"),this.dom||(this._id=b.getNextUniqueId(),this.dom=$(' <div id="'+this._id+'"></div>').css("height","100%").css("width","100%"),this.module.getDomContent().html(this.dom))},blank:{picture:function(){console.log("blank"),this.dom.empty()}},inDom:function(){this.resolveReady()},update:{picture:function(a,b){var c=this;this.clearImages(),console.log("picture update ",a,"varname: ",b),this.addImage(a.get(),b,function(){c.panzoomElements=c.dom.find(".panzoom"),c.panzoomMode(),c.onResize(),c.reorderImages()})}},clearImages:function(){this.imgWidth=[],this.imgHeight=[],this.panzoomElements&&(this.panzoomElements.panzoom("destroy"),this.dom.html(""))},reorderImages:function(){var a=c.map(this.module.definition.vars_in,function(a){return a.name});console.log("vars_in",a),console.log("config",this.module.getConfiguration("img"));for(var b=c.map(this.module.getConfiguration("img"),function(a){return parseInt(a.order)}),d=0;d<a.length;d++)console.log("order",b),this.dom.find("#"+a[d]).css("z-index",b[d]||a.length-d)},addImage:function(a,b,d){var e=this;console.log("add image");var f=e.dom.find("#"+b);0===f.length&&(f=$('<div class="parent" id="'+b+'"><div class="panzoom"><img/></div></div>'));var g=e.module.getConfiguration("img");g=c.find(g,function(a){if(a.variable===b){var c=parseFloat(a.opacity);if(c&&c>=0&&1>=c)return!0}return!1}),console.log("img conf: ",g),g&&g.opacity&&f.find("img").css("opacity",parseFloat(g.opacity)),f.find("img").attr("src",a).load(function(){e.imgWidth.push(this.width),e.imgHeight.push(this.height),e.dom.append(f),d()})},panzoomMode:function(){var a=this;this.panzoomElements.panzoom({increment:.1,maxScale:10,minScale:.2,duration:100}),this.panzoomElements.on("panzoompan",function(b,c){var d=a.panzoomElements.panzoom("instance");for(i=0;i<d.length;i++)d[i]!==c&&d[i].setMatrix(c.getMatrix())}),this.dom.off("dblclick"),this.dom.dblclick(function(){a.panzoomElements.panzoom("reset")}),this.panzoomElements.parent().on("mousewheel.focal",function(b){b.preventDefault();var c=b.delta||b.originalEvent.wheelDelta,d=c?0>c:b.originalEvent.deltaY>0;a.panzoomElements.panzoom("zoom",d,{increment:.1,animate:!1,focal:b})})},selectionMode:function(){this.panzoomElements.panzoom("destroy"),this.jcropApi.enable()},onResize:function(){if(this.panzoomElements){for(var a=this.dom.find("img"),b=0;b<a.length;b++)this.imgWidth[b]/this.imgHeight[b]>this.dom.width()/this.dom.height()?(a[b].width=this.dom.width(),a[b].height=this.imgHeight[b]/this.imgWidth[b]*this.dom.width()):(a[b].height=this.dom.height(),a[b].width=this.imgWidth[b]/this.imgHeight[b]*this.dom.height()),this.dom.find(".parent").width(this.dom.parent().width()).height(this.dom.parent().height());this.panzoomElements.panzoom("resetDimensions")}},getDom:function(){return this.dom}}),d});