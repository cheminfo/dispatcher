define(["modules/default/defaultview","src/util/util","fancytree"],function(a,b){function c(){}function d(a){var b=[];if(a.children&&a.children.length){var c=new DataObject;e(b,a.children,c)}return{fancy:b,model:c}}function e(a,b,c){for(var d,f,g=0,h=b.length;h>g;g++){if(d=b[g],0===g&&"object"==typeof d.info)for(var i,j=Object.keys(d.info),k=0;k<j.length;k++)i=j[k],c.hasOwnProperty(i)||(c[i]=d.info[i]);f={title:d.label||"Untitled node",dataObj:DataObject.check(d)},a.push(f),d.children&&d.children.length&&(f.children=[],e(f.children,d.children,c))}}return c.prototype=$.extend(!0,{},a,{init:function(){var a=b.getNextUniqueId();this.dom=$('<table id="'+a+'">').css({width:"100%"});var c=this.module.getConfiguration("columns")||[],d=$("<colgroup><col></col></colgroup>").appendTo(this.dom),e=$("<tr><th></th></tr>").appendTo($("<thead></thead>").appendTo(this.dom)),f=$("<tr><td></td></tr>").appendTo($("<tbody></tbody>").appendTo(this.dom)),g=[];if(this.jpathsF={},c.length)for(var h,i=0;i<c.length;i++)h=c[i],h.jpath&&(d.append($("<col"+(h.width?' width="'+h.width+'px"':"")+"></col>")),e.append("<th>"+(h.name||"")+"</th>"),f.append("<td></td>"),g.push(h.jpath),b.addjPathFunction(this.jpathsF,h.jpath));this.expand=this.module.getConfiguration("expand"),this.jpaths=g,this.module.getDomContent().html(this.dom)},inDom:function(){var a=this;this.dom.fancytree({extensions:["table"],table:{indentation:20,nodeColumnIdx:0},icons:!1,renderColumns:function(b,c){var d=c.node,e=d.data.dataObj,f=$(d.tr).find(">td"),g=a.jpaths;if(e.info)for(var h=0;h<g.length;h++)f.eq(h+1).text(a.jpathsF[g[h]](e.info))},activate:function(b,c){a.module.controller.onActivate(c.node.data.dataObj.info)}}),this.tree=this.dom.fancytree("getTree"),this.resolveReady()},update:{tree:function(a){var b=d(a.get());if(this.module.model._objectModel=b.model,this.tree.reload(b.fancy),"lvl1"===this.expand)for(var c=this.tree.rootNode.children,e=0;e<c.length;e++)c[e].setExpanded(!0);else"all"===this.expand&&this.tree.visit(function(a){a.setExpanded(!0)})}},blank:{tree:function(){this.tree.reload()}}}),c});