define(["./../matrix-tools","./../../math/matrix","./../../math/norm","./../../math/decompositions"],function(a,b,c,d){function e(c,d,e,f){if("undefined"==typeof e&&(e="center"),"undefined"==typeof f&&(f="nipals"),c instanceof b||(c=new b(c)),d instanceof b||(d=new b(d)),c.rows!==d.rows)throw"The number of rows in the inputs matrix must match the number of rows in the outputs matrix.";this.analysisMethod=e,this._algorithm=f,this.sourceX=c,this.sourceY=d,this.meanX=a.mean(c),this.meanY=a.mean(d),this.stdDevX=a.standardDeviation(c,this.meanX),this.stdDevY=a.standardDeviation(d,this.meanY),this.inputVariables=new l(this,!0),this.outputVariables=new l(this,!1),this.overwriteSourceMatrix=!1}function f(a,e,f,g){for(var h=a.sourceX.rows,i=a.sourceX.columns,j=a.sourceY.columns,k=b.zeros(h,g),l=b.zeros(h,g),m=b.zeros(i,g),n=b.zeros(j,g),o=b.zeros(i,g),p=new Array(g),q=new Array(g),r=b.zeros(i,g),s=e.transpose().mmul(f),t="",u=0;u<s.rows;u++)for(var v=0;v<s.columns;v++)t+=s.get(u,v)+" ";console.log(t),console.log("start iteration");for(var w=0;g>w;w++){var x=new d.SingularValueDecomposition(s,{computeLeftSingularVectors:!0,computeRightSingularVectors:!1,autoTranspose:!0}),y=x.U.getColumn(0),z=s.transpose().mmul(y);y=y.to1DArray();for(var A=new Array(h),u=0;h>u;A[u++]=0);for(var u=0;h>u;u++)for(var v=0,B=y.length;B>v;v++)A[u]+=e[u][v]*y[v];for(var C=c.euclidean(A),u=0;h>u;u++)A[u]/=C;for(var D=new Array(i),u=0;i>u;D[u++]=0);for(var u=0;i>u;u++)for(var v=0;h>v;v++)D[u]+=e[v][u]*A[v];for(var u=0,E=y.length;E>u;u++)y[u]/=C;z=z.divS(C).to1DArray();for(var F=new Array(h),u=0;h>u;u++)for(var v=0,B=z.length;B>v;v++)F[u]+=f[u][v]*z[v];var G=D.slice();if(w>0){for(var v=0;w>v;v++){for(var H=0,I=0;i>I;I++)H+=G[I]*r[I][v];for(var I=0;i>I;I++)G[I]-=H*r[I][v]}for(var v=0;w>v;v++){for(var H=0,I=0;h>I;I++)H+=F[I]*k[I][v];for(var I=0;h>I;I++)F[I]-=H*k[I][v]}}var J=c.euclidean(G);console.log(J);for(var u=0,E=G.length;E>u;u++)G[u]/=J;for(var K=s.clone(),u=0,E=G.Length;E>u;u++)for(var v=0;E>v;v++)for(var L=G[u]*G[v],I=0;j>I;I++)K[u][I]-=L*s[v][I];s=K,console.log(y[0]);for(var t="",u=0;u<s.rows;u++)for(var v=0;v<s.columns;v++)t+=s.get(u,v)+" ";console.log(t),o.setColumn(w,y),l.setColumn(w,F),n.setColumn(w,z),k.setColumn(w,A),m.setColumn(w,D),r.setColumn(w,G),p[w]=b.rowVector(D).dot(b.columnVector(D)),q[w]=b.rowVector(z).dot(b.columnVector(z))}a.scoresX=k,a.scoresY=l,a.loadingsX=m,a.loadingsY=n,a._weights=o,a.coeffbase=o,a.componentProportionX=new Array(g),a.componentProportionY=new Array(g);for(var M=0,N=0,u=0;h>u;u++){for(var v=0;i>v;v++)M+=e[u][v]*e[u][v];for(var v=0;j>v;v++)N+=f[u][v]*f[u][v]}for(var u=0;g>u;u++)a.componentProportionY[u]=q[u]/N,a.componentProportionX[u]=p[u]/M}function g(a,e,f,g,h){for(var i=a.sourceX.rows,j=a.sourceX.columns,l=a.sourceY.columns,m=a.inputsX.clone(),n=a.outputsY.clone(),o=b.zeros(i,g),p=b.zeros(i,g),q=b.zeros(j,g),r=b.zeros(l,g),s=b.zeros(j,j),t=Array(j),u=new Array(g),v=new Array(g),w=!1,x=0;g>x&&!w;x++){for(var y=m.getColumn(k(m)).to1DArray(),z=n.getColumn(k(n)).to1DArray(),A=new Array(j),B=0;j>B;A[B++]=0);for(var C=new Array(l),B=0;j>B;C[B++]=0);for(var D=c.euclidean(y);D>1e-14;){var E=y.slice();A=new Array(j);for(var B=0;j>B;A[B++]=0);for(var F=0;j>F;F++)for(var B=0,G=z.length;G>B;B++)A[F]+=m[B][F]*z[B];for(var H=c.euclidean(A),B=0;j>B;B++)A[B]/=H;y=new Array(i);for(var B=0;i>B;y[B++]=0);for(var B=0;i>B;B++)for(var F=0;j>F;F++)y[B]+=m[B][F]*A[F];D=c.euclidean(y);for(var B=0;i>B;B++)y[B]/=D;C=new Array(l);for(var B=0;l>B;C[B++]=0);for(var F=0;l>F;F++)for(var B=0;i>B;B++)C[F]+=n[B][F]*y[B];for(var I=c.euclidean(C),B=0;l>B;B++)C[B]/=I;z=new Array(i);for(var B=0;i>B;B++)for(var F=0;l>F;F++)z[B]+=n[B][F]*C[F];D=0;for(var B=0;i>B;B++){var J=E[B]-y[B];D+=J*J}D=Math.sqrt(D)}for(var K=b.columnVector(y).dot(b.rowVector(z)),L=new Array(j),B=0;j>B;L[B++]=0);for(var F=0;j>F;F++)for(var B=0;i>B;B++)L[F]+=m[B][F]*y[B];for(var B=0;i>B;B++){for(var F=0;j>F;F++)m[B][F]-=y[B]*L[F];for(var F=0;l>F;F++)n[B][F]-=K*y[B]*C[F]}v[x]=K*K,u[x]=b.columnVector(L).dot(b.rowVector(L)),o.setColumn(x,y),q.setColumn(x,L),p.setColumn(x,z),r.setColumn(x,C),s.setColumn(x,A),t[x]=K;var M=c.euclideanM(m),N=c.euclideanM(n);w=!0;for(var B=0,G=M.length;G>B&&w===!0;B++)(M[B]>h||N[B]>h)&&(w=!1)}a.coeffbase=new d.SingularValueDecomposition(q.transpose()).solveForDiagonal(t),a.scoresX=o,a.scoresY=p,a.loadingsX=q,a.loadingsY=r,a._weights=s,a.componentProportionX=new Array(g),a.componentProportionY=new Array(g);for(var O=0,P=0,B=0;i>B;B++){for(var F=0;j>F;F++)O+=e[B][F]*e[B][F];for(var F=0;l>F;F++)P+=f[B][F]*f[B][F]}for(var B=0;g>B;B++)a.componentProportionY[B]=v[B]/P,a.componentProportionX[B]=u[B]/O}function h(a,d){for(var e=a.sourceX.columns,f=b.zeros(e,d),g=0;e>g;g++){for(var h=new Array(d),i=new Array(d),j=0;d>j;j++){var k=a.loadingsY.getColumn(j)[0][0],l=a.scoresX.getColumn(j),m=a.loadingsX.getColumn(j).to1DArray(),n=k*k*l.dot(l.transpose()),o=m[g]*m[g]/c.squareEuclidean(m);h[j]=n*o,i[j]=n}for(var p=0,q=0;d>q;q++)p+=h[q],r+=i[q];var p,r;require(["./../array-tools"],function(a){p=a.cumulativeSum(h),r=a.cumulativeSum(i)});for(var j=0;d>j;j++)f[g][j]=Math.sqrt(e*p[j]/r[j])}return f}function i(){}function j(c,d,e,f,g){var h=a.center(d,e,g);if(null!==f&&"standardize"===c.analysisMethod){for(var i=0,j=f.length;j>i;i++)if(0===f[i])throw new ArithmeticException("Standard deviation cannot be zero (cannot standardize the constant variable at column index "+i+").");a.standardize(h,f,!0)}return new b(h)}function k(a){for(var b=a.rows,c=a.columns,d=0,e=0,f=0;c>f;f++){for(var g=0,h=0;b>h;h++)g+=a[h][f]*a[h][f];g>e&&(e=g,d=f)}return d}function l(a,b){this.analysis=a,this.inputs=b}return e.prototype={get source(){return this.sourceX},get output(){return this.sourceY},get predictors(){return this.inputVariables},get dependents(){return this.outputVariables},get weights(){return this._weights},get factors(){return this.factorCollection},get algorithm(){return this._algorithm},get method(){return this.analysisMethod},get importance(){return this.vip},set overwrite(a){"boolean"==typeof a&&(this.overwriteSourceMatrix=a)},compute:function(a){var b=Math.min(this.sourceX.rows-1,this.sourceX.columns);if("undefined"==typeof a&&(a=b),a>b)throw"Argument factors out of range.";var c=j(this,this.sourceX,this.meanX,this.stdDevX,this.overwriteSourceMatrix),d=j(this,this.sourceY,this.meanY,null,this.overwriteSourceMatrix);"simpls"===this.algorithm?f(this,c,d,a):g(this,c,d,a,0),this.cumulativeProportionX=new Array(a),this.cumulativeProportionY=new Array(a),this.cumulativeProportionX[0]=this.componentProportionX[0],this.cumulativeProportionY[0]=this.componentProportionY[0];for(var e=1;a>e;e++)this.cumulativeProportionX[e]=this.cumulativeProportionX[e-1]+this.componentProportionX[e],this.cumulativeProportionY[e]=this.cumulativeProportionY[e-1]+this.componentProportionY[e],console.log(this.cumulativeProportionX[e]+" "+this.cumulativeProportionY[e]);this.vip=h(this,a);for(var k=new Array(a),e=0,l=k.length;l>e;e++)k[e]=new i(this,e);this.factorCollection=k},transform:function(a,c){"undefined"==typeof c&&(c=this.loadingsX.columns),a instanceof b||(a=new b(a));var d=a.rows,e=a.columns;if(e>this.loadingsX.rows)throw"The data matrix should have a number of columns less than or equal to the number of rows in the loadings matrix for the input variables.";for(var f=b.zeros(d,c),g=j(this,a,this.meanX,this.stdDevX,!1),h=this.loadingsX,i=0;d>i;i++)for(var k=0;c>k;k++)for(var l=0;e>l;l++)f[i][k]+=g[i][l]*h[l][k];return f},transformOutput:function(a,c){"undefined"==typeof c&&(c=this.loadingsY.columns),a instanceof b||(a=new b(a));var d=a.rows,e=a.columns;if(e>this.loadingsY.rows)throw"The data matrix should have a number of columns less than or equal to the number of rows in the loadings matrix for the input variables.";for(var f=b.zeros(d,c),g=j(this,a,this.meanY,this.stdDevY,!1),h=this.loadingsY,i=0;d>i;i++)for(var k=0;c>k;k++)for(var l=0;e>l;l++)f[i][k]+=g[i][l]*h[l][k];return f},createRegression:function(a){if("undefined"==typeof a&&(a=this.factorCollection.length),a>this.factorCollection.length)throw"The number of factors should be equal to or less than the number of factors computed in the analysis.";for(var c=this.sourceX.columns,d=this.sourceY.columns,e=b.zeros(c,d),f=this.coeffbase,g=this.loadingsY,h=0;c>h;h++)for(var i=0;d>i;i++)for(var j=0;a>j;j++)e[h][i]+=f[h][j]*g[i][j];if("standardize"===this.analysisMethod)for(var h=0;c>h;h++)for(var i=0;d>i;i++)e[h][i]=e[h][i]/this.stdDevX[h];for(var k=new Array(d),h=0;d>h;h++){for(var l=0,i=0;c>i;i++)l+=this.meanX[i]*e[i][h];k[h]=this.meanY[h]-l}var m;return require(["./../models/regression/multivariate-linear-regression"],function(a){m=new a(e,k,!0)}),m}},l.prototype={get source(){return this.inputs?this.analysis.sourceX:this.analysis.sourceY},get result(){return this.inputs?this.analysis.scoresX:this.analysis.scoresY},get means(){return this.inputs?this.analysis.meanX:this.analysis.meanY},get standardDeviations(){return this.inputs?this.analysis.stdDevX:this.analysis.stdDevY},get factorMatrix(){return this.inputs?this.analysis.loadingsX:this.analysis.loadingsY},get factorProportions(){return this.inputs?this.analysis.cumulativeProportionX:this.analysis.cumulativeProportionY},transform:function(a,b){return inputs?this.analysis.transform(a,b):this.analysis.transformOutput(a,b)}},e});