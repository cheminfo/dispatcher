Pixastic.Actions.blend={process:function(a){var b=parseFloat(a.options.amount),c=(a.options.mode||"normal").toLowerCase(),d=a.options.image;if(b=Math.max(0,Math.min(1,b)),!d)return!1;if(Pixastic.Client.hasCanvasImageData()){var e=a.options.rect,f=Pixastic.prepareData(a),g=e.width,h=e.height;a.useData=!1;var i=document.createElement("canvas");i.width=a.canvas.width,i.height=a.canvas.height;var j=i.getContext("2d");j.drawImage(d,0,0);var k,l,m,n,o,p,q,r,s,t,u,v,w,x,y={canvas:i,options:a.options},z=Pixastic.prepareData(y),A=y.canvasData,B=g*h,C=4*B,D=!1;switch(c){case"normal":break;case"multiply":for(;B--;)z[C-=4]=f[C]*z[C]/255,z[k=C+1]=f[k]*z[k]/255,z[l=C+2]=f[l]*z[l]/255;D=!0;break;case"lighten":for(;B--;)(m=f[C-=4])>z[C]&&(z[C]=m),(n=f[k=C+1])>z[k]&&(z[k]=n),(o=f[l=C+2])>z[l]&&(z[l]=o);D=!0;break;case"darken":for(;B--;)(m=f[C-=4])<z[C]&&(z[C]=m),(n=f[k=C+1])<z[k]&&(z[k]=n),(o=f[l=C+2])<z[l]&&(z[l]=o);D=!0;break;case"darkercolor":for(;B--;).3*(m=f[C-=4])+.59*(n=f[k=C+1])+.11*(o=f[l=C+2])<=.3*z[C]+.59*z[k]+.11*z[l]&&(z[C]=m,z[k]=n,z[l]=o);D=!0;break;case"lightercolor":for(;B--;).3*(m=f[C-=4])+.59*(n=f[k=C+1])+.11*(o=f[l=C+2])>.3*z[C]+.59*z[k]+.11*z[l]&&(z[C]=m,z[k]=n,z[l]=o);D=!0;break;case"lineardodge":for(;B--;)z[C]=(s=f[C-=4]+z[C])>255?255:s,z[k]=(t=f[k=C+1]+z[k])>255?255:t,z[l]=(u=f[l=C+2]+z[l])>255?255:u;D=!0;break;case"linearburn":for(;B--;)z[C]=(s=f[C-=4]+z[C])<255?0:s-255,z[k]=(t=f[k=C+1]+z[k])<255?0:t-255,z[l]=(u=f[l=C+2]+z[l])<255?0:u-255;D=!0;break;case"difference":for(;B--;)z[C]=(s=f[C-=4]-z[C])<0?-s:s,z[k]=(t=f[k=C+1]-z[k])<0?-t:t,z[l]=(u=f[l=C+2]-z[l])<0?-u:u;D=!0;break;case"screen":for(;B--;)z[C-=4]=255-((255-z[C])*(255-f[C])>>8),z[k=C+1]=255-((255-z[k])*(255-f[k])>>8),z[l=C+2]=255-((255-z[l])*(255-f[l])>>8);D=!0;break;case"exclusion":for(var E=2/255;B--;)z[C-=4]=(m=f[C])-(m*E-1)*z[C],z[k=C+1]=(n=f[k])-(n*E-1)*z[k],z[l=C+2]=(o=f[l])-(o*E-1)*z[l];D=!0;break;case"overlay":for(var E=2/255;B--;)z[C]=(m=f[C-=4])<128?z[C]*m*E:255-(255-z[C])*(255-m)*E,z[k]=(n=f[k=C+1])<128?z[k]*n*E:255-(255-z[k])*(255-n)*E,z[l]=(o=f[l=C+2])<128?z[l]*o*E:255-(255-z[l])*(255-o)*E;D=!0;break;case"softlight":for(var E=2/255;B--;)z[C]=(m=f[C-=4])<128?((z[C]>>1)+64)*m*E:255-(191-(z[C]>>1))*(255-m)*E,z[k]=(n=f[k=C+1])<128?((z[k]>>1)+64)*n*E:255-(191-(z[k]>>1))*(255-n)*E,z[l]=(o=f[l=C+2])<128?((z[l]>>1)+64)*o*E:255-(191-(z[l]>>1))*(255-o)*E;D=!0;break;case"hardlight":for(var E=2/255;B--;)z[C]=(p=z[C-=4])<128?f[C]*p*E:255-(255-f[C])*(255-p)*E,z[k]=(q=z[k=C+1])<128?f[k]*q*E:255-(255-f[k])*(255-q)*E,z[l]=(r=z[l=C+2])<128?f[l]*r*E:255-(255-f[l])*(255-r)*E;D=!0;break;case"colordodge":for(;B--;)z[C]=(s=(f[C-=4]<<8)/(255-(p=z[C])))>255||255==p?255:s,z[k]=(t=(f[k=C+1]<<8)/(255-(q=z[k])))>255||255==q?255:t,z[l]=(u=(f[l=C+2]<<8)/(255-(r=z[l])))>255||255==r?255:u;D=!0;break;case"colorburn":for(;B--;)z[C]=(s=255-(255-f[C-=4]<<8)/z[C])<0||0==z[C]?0:s,z[k]=(t=255-(255-f[k=C+1]<<8)/z[k])<0||0==z[k]?0:t,z[l]=(u=255-(255-f[l=C+2]<<8)/z[l])<0||0==z[l]?0:u;D=!0;break;case"linearlight":for(;B--;)z[C]=(s=2*(p=z[C-=4])+f[C]-256)<0||128>p&&0>s?0:s>255?255:s,z[k]=(t=2*(q=z[k=C+1])+f[k]-256)<0||128>q&&0>t?0:t>255?255:t,z[l]=(u=2*(r=z[l=C+2])+f[l]-256)<0||128>r&&0>u?0:u>255?255:u;D=!0;break;case"vividlight":for(;B--;)z[C]=(p=z[C-=4])<128?p?(s=255-(255-f[C]<<8)/(2*p))<0?0:s:0:(s=v=2*p-256)<255?(s=(f[C]<<8)/(255-v))>255?255:s:0>s?0:s,z[k]=(q=z[k=C+1])<128?q?(t=255-(255-f[k]<<8)/(2*q))<0?0:t:0:(t=w=2*q-256)<255?(t=(f[k]<<8)/(255-w))>255?255:t:0>t?0:t,z[l]=(r=z[l=C+2])<128?r?(u=255-(255-f[l]<<8)/(2*r))<0?0:u:0:(u=x=2*r-256)<255?(u=(f[l]<<8)/(255-x))>255?255:u:0>u?0:u;D=!0;break;case"pinlight":for(;B--;)z[C]=(p=z[C-=4])<128?(m=f[C])<(v=2*p)?m:v:(m=f[C])>(v=2*p-256)?m:v,z[k]=(q=z[k=C+1])<128?(n=f[k])<(w=2*q)?n:w:(n=f[k])>(w=2*q-256)?n:w,z[l]=(p=z[l=C+2])<128?(m=f[l])<(v=2*p)?m:v:(m=f[l])>(v=2*p-256)?m:v;D=!0;break;case"hardmix":for(;B--;)z[C]=(p=z[C-=4])<128?255-(255-f[C]<<8)/(2*p)<128||0==p?0:255:(v=2*p-256)<255&&(f[C]<<8)/(255-v)<128?0:255,z[k]=(q=z[k=C+1])<128?255-(255-f[k]<<8)/(2*q)<128||0==q?0:255:(w=2*q-256)<255&&(f[k]<<8)/(255-w)<128?0:255,z[l]=(r=z[l=C+2])<128?255-(255-f[l]<<8)/(2*r)<128||0==r?0:255:(x=2*r-256)<255&&(f[l]<<8)/(255-x)<128?0:255;D=!0}if(D&&j.putImageData(A,0,0),1==b||Pixastic.Client.hasGlobalAlpha()){var F=a.canvas.getContext("2d");F.save(),F.globalAlpha=b,F.drawImage(i,0,0,e.width,e.height,e.left,e.top,e.width,e.height),F.globalAlpha=1,F.restore()}else{for(var B=g*h,G=b,H=1-b;B--;){var C=4*B,I=f[C]*H+z[C]*G>>0,J=f[C+1]*H+z[C+1]*G>>0,K=f[C+2]*H+z[C+2]*G>>0;f[C]=I,f[C+1]=J,f[C+2]=K}a.useData=!0}return!0}},checkSupport:function(){return Pixastic.Client.hasCanvasImageData()}};