!function(a){function b(a){var b=a.split("/");return"_design"==b[0]?(b.shift(),"_design/"+encodeURIComponent(b.join("/"))):encodeURIComponent(a)}function c(b,c,d,e){var f,h={contentType:"application/json",headers:{Accept:"application/json"}};return c=a.extend({successStatus:200},c),e=a.extend(h,e),d=d||"Unknown error",f=(new Date).getTime(),a.ajax(a.extend(a.extend({type:"GET",dataType:"json",cache:g(),beforeSend:function(a){if(e&&e.headers)for(var b in e.headers)a.setRequestHeader(b,e.headers[b])},complete:function(b){var e=(new Date).getTime()-f;try{var g=a.parseJSON(b.responseText)}catch(h){if(!c.error)throw d+": "+h;return void c.error(b.status,b,h)}if(c.ajaxStart&&c.ajaxStart(g),b.status==c.successStatus)c.beforeSuccess&&c.beforeSuccess(b,g,e),c.success&&c.success(g,e);else{if(!c.error)throw d+": "+g.reason;c.error(b.status,g&&g.error||d,g&&g.reason||"no response",e)}}},b),e))}function d(a){var a=a||{};if("undefined"!=typeof a.ensure_full_commit){var b=a.ensure_full_commit;return delete a.ensure_full_commit,function(a){a.setRequestHeader("Accept","application/json"),a.setRequestHeader("X-Couch-Full-Commit",b.toString())}}}function e(b){var c=[];if("object"==typeof b&&null!==b)for(var d in b)if(!(a.inArray(d,["error","success","beforeSuccess","ajaxStart"])>=0)){var e=b[d];a.inArray(d,["key","startkey","endkey"])>=0&&(e=f(e)),c.push(encodeURIComponent(d)+"="+encodeURIComponent(e))}return c.length?"?"+c.join("&"):""}function f(a){return null!==a?JSON.stringify(a):null}function g(){return navigator?/(MSIE|Trident)/.test(navigator.userAgent)?!1:!0:!0}a.couch=a.couch||{};var h=[];a.extend(a.couch,{urlPrefix:"",activeTasks:function(a){c({url:this.urlPrefix+"/_active_tasks"},a,"Active task status could not be retrieved")},allDbs:function(a){c({url:this.urlPrefix+"/_all_dbs"},a,"An error occurred retrieving the list of all databases")},config:function(a,b,d,e){var g={url:this.urlPrefix+"/_config/"};b&&(g.url+=encodeURIComponent(b)+"/",d&&(g.url+=encodeURIComponent(d))),null===e?g.type="DELETE":void 0!==e&&(g.type="PUT",g.data=f(e),g.contentType="application/json",g.processData=!1),c(g,a,"An error occurred retrieving/updating the server configuration")},session:function(b){b=b||{},c({type:"GET",url:this.urlPrefix+"/_session",beforeSend:function(a){a.setRequestHeader("Accept","application/json")},complete:function(c){var d=a.parseJSON(c.responseText);if(200==c.status)b.success&&b.success(d);else{if(!b.error)throw"An error occurred getting session info: "+d.reason;b.error(c.status,d.error,d.reason)}}})},userDb:function(b){a.couch.session({success:function(c){var d=a.couch.db(c.info.authentication_db);b(d)}})},signup:function(b,c,d){d=d||{},b.password=c,b.roles=b.roles||[],b.type=b.type="user";var e="org.couchdb.user:";b._id=b._id||e+b.name,a.couch.userDb(function(a){a.saveDoc(b,d)})},login:function(b){b=b||{},a.ajax({type:"POST",url:this.urlPrefix+"/_session",dataType:"json",data:{name:b.name,password:b.password},beforeSend:function(a){a.setRequestHeader("Accept","application/json")},complete:function(c){var d=a.parseJSON(c.responseText);if(200==c.status)b.success&&b.success(d);else{if(!b.error)throw"An error occurred logging in: "+d.reason;b.error(c.status,d.error,d.reason)}}})},logout:function(b){b=b||{},a.ajax({type:"DELETE",url:this.urlPrefix+"/_session",dataType:"json",username:"_",password:"_",beforeSend:function(a){a.setRequestHeader("Accept","application/json")},complete:function(c){var d=a.parseJSON(c.responseText);if(200==c.status)b.success&&b.success(d);else{if(!b.error)throw"An error occurred logging out: "+d.reason;b.error(c.status,d.error,d.reason)}}})},db:function(g,h){function i(a){if(a._id&&a._rev&&j[a._id]&&j[a._id].rev==a._rev){if("undefined"==typeof Base64)throw"Base64 support not found.";return a._attachments=a._attachments||{},a._attachments["rev-"+a._rev.split("-")[0]]={content_type:"application/json",data:Base64.encode(j[a._id].raw)},!0}}h=h||{};var j={};return{name:g,uri:this.urlPrefix+"/"+encodeURIComponent(g)+"/",compact:function(b){a.extend(b,{successStatus:202}),c({type:"POST",url:this.uri+"_compact",data:"",processData:!1},b,"The database could not be compacted")},viewCleanup:function(b){a.extend(b,{successStatus:202}),c({type:"POST",url:this.uri+"_view_cleanup",data:"",processData:!1},b,"The views could not be cleaned up")},compactView:function(b,d){a.extend(d,{successStatus:202}),c({type:"POST",url:this.uri+"_compact/"+b,data:"",processData:!1},d,"The view could not be compacted")},create:function(b){a.extend(b,{successStatus:201}),c({type:"PUT",url:this.uri,contentType:"application/json",data:"",processData:!1},b,"The database could not be created")},drop:function(a){c({type:"DELETE",url:this.uri},a,"The database could not be deleted")},info:function(a){c({url:this.uri},a,"Database information could not be retrieved")},changes:function(b,d){function f(b){a.each(k,function(){this(b)})}function g(){var f=a.extend({heartbeat:1e4},d,{feed:"longpoll",since:b});l=c({url:i.uri+"_changes"+e(f)},d,"Error connecting to "+i.uri+"/_changes.")}d=d||{};var h=100,i=this,j=!0,k=[],l=null,m={onChange:function(a){k.push(a)},stop:function(){j=!1,l&&l.abort()}};return d.success=function(a){h=100,j&&(b=a.last_seq,f(a),g())},d.error=function(){j&&(setTimeout(g,h),h=2*h)},b?g():i.info({success:function(a){b=a.update_seq,g()}}),m},allDocs:function(a){var b="GET",d=null;if(a.keys){b="POST";var g=a.keys;delete a.keys,d=f({keys:g})}c({type:b,data:d,url:this.uri+"_all_docs"+e(a)},a,"An error occurred retrieving a list of all documents")},allDesignDocs:function(b){this.allDocs(a.extend({startkey:"_design",endkey:"_design0"},b))},allApps:function(b){b=b||{};var c=this;if(!b.eachApp)throw"Please provide an eachApp function for allApps()";this.allDesignDocs({success:function(d){a.each(d.rows,function(){c.openDoc(this.id,{success:function(a){var c,d,e=a._id.split("/");e.shift(),e=e.join("/"),c=a.couchapp&&a.couchapp.index,c?d=["",g,a._id,c].join("/"):a._attachments&&a._attachments["index.html"]&&(d=["",g,a._id,"index.html"].join("/")),d&&b.eachApp(e,d,a)}})})}})},openDoc:function(d,f,g){f=f||{},h.attachPrevRev||f.attachPrevRev?a.extend(f,{beforeSuccess:function(a,b){j[b._id]={rev:b._rev,raw:a.responseText}}}):a.extend(f,{beforeSuccess:function(a,b){b["jquery.couch.attachPrevRev"]&&(j[b._id]={rev:b._rev,raw:a.responseText})}}),c({url:this.uri+b(d)+e(f)},f,"The document could not be retrieved",g)},saveDoc:function(c,g){g=g||{};var h=this,j=d(g);if(void 0===c._id)var k="POST",l=this.uri;else var k="PUT",l=this.uri+b(c._id);var m=i(c);a.ajax({type:k,url:l+e(g),contentType:"application/json",dataType:"json",data:f(c),beforeSend:j,complete:function(b){var d=a.parseJSON(b.responseText);if(200==b.status||201==b.status||202==b.status)c._id=d.id,c._rev=d.rev,m?h.openDoc(c._id,{attachPrevRev:!0,success:function(a){c._attachments=a._attachments,g.success&&g.success(d)}}):g.success&&g.success(d);else{if(!g.error)throw"The document could not be saved: "+d.reason;g.error(b.status,d.error,d.reason)}}})},bulkSave:function(b,g){var h=d(g);a.extend(g,{successStatus:201,beforeSend:h}),c({type:"POST",url:this.uri+"_bulk_docs"+e(g),contentType:"application/json",data:f(b)},g,"The documents could not be saved")},removeDoc:function(a,d){c({type:"DELETE",url:this.uri+b(a._id)+e({rev:a._rev})},d,"The document could not be deleted")},bulkRemove:function(b,d){b.docs=a.each(b.docs,function(a,b){b._deleted=!0}),a.extend(d,{successStatus:201}),c({type:"POST",url:this.uri+"_bulk_docs"+e(d),data:f(b)},d,"The documents could not be deleted")},copyDoc:function(d,e,f){f=a.extend(f,{complete:function(b){var c=a.parseJSON(b.responseText);if(201==b.status)e.success&&e.success(c);else{if(!e.error)throw"The document could not be copied: "+c.reason;e.error(b.status,c.error,c.reason)}}}),c({type:"COPY",url:this.uri+b(d)},e,"The document could not be copied",f)},query:function(a,b,d,g){d=d||"javascript","string"!=typeof a&&(a=a.toSource?a.toSource():"("+a.toString()+")");var h={language:d,map:a};null!=b&&("string"!=typeof b&&(b=b.toSource?b.toSource():"("+b.toString()+")"),h.reduce=b),c({type:"POST",url:this.uri+"_temp_view"+e(g),contentType:"application/json",data:f(h)},g,"An error occurred querying the database")},list:function(a,b,d,g){var a=a.split("/"),d=d||{},h="GET",i=null;if(d.keys){h="POST";var j=d.keys;delete d.keys,i=f({keys:j})}c({type:h,data:i,url:this.uri+"_design/"+a[0]+"/_list/"+a[1]+"/"+b+e(d)},g,"An error occurred accessing the list")},view:function(a,b){var a=a.split("/"),b=b||{},d="GET",g=null;if(b.keys){d="POST";var h=b.keys;delete b.keys,g=f({keys:h})}c({type:d,data:g,url:this.uri+"_design/"+a[0]+"/_view/"+a[1]+e(b)},b,"An error occurred accessing the view")},getDbProperty:function(a,b,d){c({url:this.uri+a+e(b)},b,"The property could not be retrieved",d)},setDbProperty:function(a,b,d,f){c({type:"PUT",url:this.uri+a+e(d),data:JSON.stringify(b)},d,"The property could not be updated",f)}}},encodeDocId:b,info:function(a){c({url:this.urlPrefix+"/"},a,"Server information could not be retrieved")},replicate:function(b,d,e,f){f=a.extend({source:b,target:d},f),f.continuous&&!f.cancel&&(e.successStatus=202),c({type:"POST",url:this.urlPrefix+"/_replicate",data:JSON.stringify(f),contentType:"application/json"},e,"Replication failed")},newUUID:function(a){return void 0===a&&(a=1),h.length||c({url:this.urlPrefix+"/_uuids",data:{count:a},async:!1},{success:function(a){h=a.uuids}},"Failed to retrieve UUID batch."),h.shift()}})}(jQuery);