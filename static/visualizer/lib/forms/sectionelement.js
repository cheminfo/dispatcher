define(["require","jquery"],function(a,b){var c=function(){};return c.defaultOptions={},b.extend(c.prototype,{init:function(a){this.options=b.extend({},c.defaultOptions,a),this.splice=Array.prototype.splice,this.groupElements={},this.sectionElements={},this.fieldElements=[],this.readyDef=b.Deferred(),this.done=0},fill:function(a,b){return this._fillGroups(a.groups,b),this._fillSections(a.sections,b),0==this.done&&this.readyDef.resolve(),this.readyDef},_fillGroups:function(a,b){var c=this.section.getGroups();this._fill(c,this.getGroupElement,a,b)},_fillSections:function(a,b){var c=this.section.getSections();this._fill(c,this.getSectionElement,a,b)},_fill:function(a,b,c,d){var e=this;c||(c={});var f,g,h;for(f in a)for(c[f]||(c[f]={}),c[f]instanceof Array||(c[f]=[c[f]]),g=0,h=c[f].length,0==h&&(c[f][0]={},h++);h>g;g++)e.done++,b.call(this,f,g).fill(c[f][g],d).done(function(){e.done--,0==e.done&&e.readyDef.resolve()})},visible:function(){this.eachElements(function(a){a.visible()})},condDisplay:function(a,b,c){var d,e,f=0;switch(b){case"section":d=this.sectionElements[a];break;case"group":d=this.groupElements[a]}for(e=d.length;e>f;f++)c?d[f].show():d[f].hide()},eachGroupElements:function(a,b){if(this.groupElements[a])for(var c=0,d=this.groupElements[a].length;d>c;c++)b.call(this,this.groupElements[a][c])},inDom:function(){this.eachElements(function(a){a.inDom()})},eachElements:function(a){var b=this;this.section.eachGroups(function(c){b.eachGroupElements(c.getName(),function(b){a(b,"group",c.getName())})}),this.section.eachSections(function(c){b.eachSectionElements(c.getName(),function(b){a(b,"section",c.getName())})})},redoTabIndices:function(){this.eachElements(function(a){a.redoTabIndices()})},addFieldElement:function(a){this.fieldElements.push(a)},removeFieldElement:function(a){this.fieldElements.splice(this.fieldElements.indexOf(a),1)},eachSectionElements:function(a,b){if(this.sectionElements[a])for(var c=0,d=this.sectionElements[a].length;d>c;c++)b.call(this,this.sectionElements[a][c])},getGroupElement:function(a,b){return this._getElement(this.groupElements,this.section.getGroup,this.section,a,b)},getSectionElement:function(a,b){return this._getElement(this.sectionElements,this.section.getSection,this.section,a,b)},_getElement:function(a,b,c,d,e){var f;return a[d]=a[d]||[],a[d][e]||(f=b.call(c,d).makeElement(),f.sectionElement=this,a[d][e]=f),a[d][e]},getSectionElements:function(){return this.sectionElements},getGroupElements:function(){return this.groupElements},getValue:function(){var a=this.getGroupElements(),b=this.getSectionElements(),c={sections:{},groups:{}};return this._getValue(b,c.sections),this._getValue(a,c.groups),c},_getValue:function(a,b){var c,d,e;for(c in a)for(d=0,e=a[c].length,b[c]=[];e>d;d++)b[c].push(a[c][d].getValue());return b},getTitle:function(){return this.section.options.title||!1},getTitleIcon:function(){var b="",c=this.getTitle();return this.section.options.icon&&(b+='<img src="'+a.toUrl("./images/"+this.section.options.icon+".png")+'" />'),c&&(b+="<div>"+c+"</div>"),b},makeDom:function(){var a,c,d,e=b("<div />");switch(this.section.form.tplMode){case 1:1==this.section.sectionLevel?(this.section.form.sectionLvl1Buttons.append('<div data-section-name="'+this.section.getName()+'" class="form-section-select">'+this.getTitleIcon()+"</div>"),e.hide()):this.stdTitle(e);break;default:this.stdTitle(e)}for(a in this.groupElements)for(d=this.groupElements[a].length,c=0;d>c;c++)e.append(this.groupElements[a][c].makeDom());for(a in this.sectionElements)for(d=this.sectionElements[a].length,c=0;d>c;c++)e.append(this.sectionElements[a][c].makeDom());return this.dom=e},stdTitle:function(a){var c=this.getTitle(),d=this.section.sectionLevel;(c||this.section.options.multiple)&&(h=b("<h"+d+">"+c+"</h"+d+">"),this.section.options.multiple&&h.append(this.makeDuplicator()),a.append(h))},makeDuplicator:function(){var a=this;return b('<div class="form-duplicator-wrapper"><span class="form-duplicator form-duplicator-add">duplicate</span> - <span class="form-duplicator form-duplicator-remove">remove</span></div>').on("click","span",function(){var c=b(this).hasClass("form-duplicator-add");a.sectionElement[c?"duplicateSectionElement":"removeSectionElement"](a)})},show:function(){this.dom.show()},hide:function(){this.dom.hide()},getSectionIndex:function(a){var b=a.section.getName();if(!this.sectionElements[b])return this.form.throwError("Cannot get section index. Section name "+b+" doesn't exist");var c=this.sectionElements[b].indexOf(a);return 0>c?this.form.throwError("Cannot get section index. Cannot find section element"):c},removeSectionElement:function(a){var b=a.section.getName(),c=this.getSectionIndex(a);c!==!1&&(1==this.sectionElements[b].length&&this.duplicateSectionElement(a),this.sectionElements[b].splice(c,1),a.dom.remove(),a.dom=null,a=null)},duplicateSectionElement:function(a){var b=this,c=a.section.getName(),d=this.getSectionIndex(a);if(d!==!1){var e=this.section.getSection(c).makeElement();return e.sectionElement=this,this.sectionElements[c].splice(d+1,0,e),e.fill({}),e.readyDef.then(function(){a&&a.dom?a.dom.after(e.makeDom()):b.dom.append(e.makeDom());for(var c=0,d=e.fieldElements.length;d>c;c++)b.section.form.conditionalDisplayer.changed(e.fieldElements[c]);e.inDom()}),e}},ready:function(){return b.when.apply(b.when,this.deferreds)},makeDomTpl:function(){return this._makeDomTpl()},_makeDomTpl:function(){this.dom=this.section._tplClean.clone();for(i in this.sectionElements)for(j=0,l=this.sectionElements[i].length;l>j;j++)this.dom.find(".form-section-section-container").append(this.sectionElements[i][j].makeDomTpl());for(i in this.groupElements)for(j=0,l=this.groupElements[i].length;l>j;j++)this.dom.find(".form-section-group-container").append(this.groupElements[i][j].makeDomTpl());return this.dom}}),c});