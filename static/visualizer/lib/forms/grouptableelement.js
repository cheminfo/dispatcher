define(["jquery","./groupelement"],function(a,b){var c=function(){this.duplicators=[]};return c.prototype=new b,c.prototype.makeDom=function(){var b,c,d,e,f,g=this,h=a("<div />").addClass("form-group-table");return this.getTitle()&&h.append('<div class="form-groupelement-title">'+this.getTitle()+"</div>"),b=a("<table />",{cellpadding:0,cellspacing:0}).css({width:"100%"}),c=a("<thead />"),d=a("<tbody />"),e=a("<tr />").appendTo(c),e.append("<th />"),this.group.eachFields(function(b){b.isDisplayed()&&(f=a("<th />").html(b.getTitle(!0)),e.append(f))}),this.options.multiple&&e.append("<th />"),b.append(c).append(d),this.dom=h,this.domHead=c,this.domBody=d,this.options.multiple&&b.on("click",".form-duplicator",function(){var b=a(this).hasClass("form-duplicator-add"),c=parseInt(a(this).parent().attr("data-rowid"));b?g.duplicate(c):g.remove(c)}),this.updateDom(),this.dom.append(b),this.dom},c.prototype._makeDomTpl=function(){return this.makeDom()},c.prototype.visible=function(){var b,c=this.domBody.width(),d=this;c-=20,this.options.multiple&&(c-=30),c/=this.group.nbFields,this.domHead.children().children().each(function(e,f){return b=a(f),0==e?void b.css("width",20):d.group.options.multiple&&e==d.group.nbFields+1?void b.css("width",30):void b.css("width",c)})},c.prototype.updateDom=function(){var b,c,d,e=this,f=[],g=0,h=0,i=[];for(this.domBody.children().detach(),this.group.eachFields(function(b){var d=b.getName();e.getFieldElement(d,0),g=0,e.eachFieldElements(d,function(b){c=a("<td />").html(b.getDom()),f[g]=f[g]||[],f[g][h]=c,g++}),h++,i[h]=b}),g=0,d=f.length;d>g;g++){for(b=a("<tr />"),b.append("<td>"+(g+1)+"</td>"),h=0,m=f[g].length;m>h;h++)b.append(f[g][h]);this.options.multiple&&b.append(this.makeDuplicator(g)),this.domBody.append(b)}return this.group.form.redoTabIndices(),this.dom},c.prototype.makeDuplicator=function(b){if(this.duplicators[b])return this.duplicators[b];var c=a("<td></td>",{"data-rowid":b}).addClass("form-table-duplicator");return c.append('<span class="form-duplicator form-duplicator-add">+</span>'),c.append('<span class="form-duplicator form-duplicator-remove">-</span>'),this.duplicators[b]=c,c},c.prototype.duplicate=function(b){var c=this,d=[];this.group.eachFields(function(a){var e=a.makeElement().done(function(d){d.group=c.group,d.groupElement=c,c.fieldElements[a.getName()].splice(b+1,0,d)});d.push(e)}),a.when.apply(a.when,d).then(function(){c.updateDom();for(var a=0,b=arguments.length;b>a;a++)arguments[a].setDefaultOr(),arguments[a].inDom()})},c.prototype.remove=function(a){var b,c=this;this.group.eachFields(function(d){d.removeElement(c.fieldElements[d.getName()][a]),c.fieldElements[d.getName()].splice(a,1),b=c.fieldElements[d.getName()].length}),0==b?this.duplicate(-1):c.updateDom()},c.prototype.fill=function(a,b){if(!(a instanceof Array))return this.fillOld(a,b);for(var c,d=0,e=a.length,f={},g={},h=this.group.fields;e>d;d++)for(c in h)f[c]=f[c]||[],f[c][d]=a[d][c],g[c]=!0;for(c in h)for(d=0;e>d;d++)f[c][d]=f[c][d]||null;return this._fill(f,b)},c.prototype.fillOld=function(a,b){var c,d,e=0;this.group.eachFields(function(b){a[b.getName()]=a[b.getName()]||[],e=Math.max(e,a[b.getName()].length)});for(c in a)for(d=a[c].length;e>d;d++)a[c][d]=null;return this._fill(a,b)},c.prototype.getValue=function(a,b){var c,d,e,b=[];for(c in this.fieldElements)for(d=0,e=this.fieldElements[c].length;e>d;d++)b[d]=b[d]||{},b[d][c]=this.fieldElements[c][d].extractValue();return b},c.prototype.getExpanderInfosFor=function(a){var b,c=a.getName(),d=0;this.eachFieldElements(c,function(c){c==a&&(b=d),d++});var e=this.group.form.dom.find(".form-sections-wrapper").position(),f=a.dom.position(),g=this.domBody.children("tr:eq("+b+")"),h=this.domBody.position();return{width:g.outerWidth()-f.left+h.left+2,left:f.left+e.left-1,top:f.top+e.top+this.domBody.children("tr:eq("+b+")").innerHeight()-1}},c.prototype.redoTabIndices=function(){var a,b=this,c=0,d=this.group.nbFields,e=0,f=[],g=0;for(this.group.eachFields(function(a){c=0,b.eachFieldElements(a.getName(),function(a){f[c*d+e]=a,c++}),e++}),a=f.length;a>g;g++)this.group.form.incrementTabIndex(f[g])},c.prototype.getFieldElementCorrespondingTo=function(a,b){var c;return this.fieldElements[b]&&(c=this.fieldElements[b][this.fieldElements[a.getName()].indexOf(a)])?c:void 0},c});