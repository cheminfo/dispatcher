Array.indexOf||(Array.prototype.indexOf=function(a,b){for(var c=b||0;c<this.length;c++)if(this[c]===a)return c;return-1});var Parser=function(a){function b(a){function b(){}return b.prototype=a,new b}function c(a,b,c,d){this.type_=a,this.index_=b||0,this.prio_=c||0,this.number_=void 0!==d&&null!==d?d:0,this.toString=function(){switch(this.type_){case r:return this.number_;case s:case t:case u:return this.index_;case v:return"CALL";default:return"Invalid Token"}}}function d(a,b,c,d){this.tokens=a,this.ops1=b,this.ops2=c,this.functions=d}function e(a){return"string"==typeof a?(w.lastIndex=0,w.test(a)?"'"+a.replace(w,function(a){var b=x[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+"'":"'"+a+"'"):a}function f(a,b){return Number(a)+Number(b)}function g(a,b){return a-b}function h(a,b){return a*b}function i(a,b){return a/b}function j(a,b){return a%b}function k(a,b){return""+a+b}function l(a){return-a}function m(a){return Math.random()*(a||1)}function n(a){a=Math.floor(a);for(var b=a;a>1;)b*=--a;return b}function o(a,b){return Math.sqrt(a*a+b*b)}function p(a,b){return"[object Array]"!=Object.prototype.toString.call(a)?[a,b]:(a=a.slice(),a.push(b),a)}function q(){this.success=!1,this.errormsg="",this.expression="",this.pos=0,this.tokennumber=0,this.tokenprio=0,this.tokenindex=0,this.tmpprio=0,this.ops1={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sqrt:Math.sqrt,log:Math.log,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,"-":l,exp:Math.exp},this.ops2={"+":f,"-":g,"*":h,"/":i,"%":j,"^":Math.pow,",":p,"||":k},this.functions={random:m,fac:n,min:Math.min,max:Math.max,pyt:o,pow:Math.pow,atan2:Math.atan2},this.consts={E:Math.E,PI:Math.PI}}var r=0,s=1,t=2,u=3,v=4,w=/[\\\'\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,x={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","'":"\\'","\\":"\\\\"};d.prototype={simplify:function(a){a=a||{};var e,f,g,h,i=[],j=[],k=this.tokens.length,l=0;for(l=0;k>l;l++){h=this.tokens[l];var m=h.type_;if(m===r)i.push(h);else if(m===u&&h.index_ in a)h=new c(r,0,0,a[h.index_]),i.push(h);else if(m===t&&i.length>1)f=i.pop(),e=i.pop(),g=this.ops2[h.index_],h=new c(r,0,0,g(e.number_,f.number_)),i.push(h);else if(m===s&&i.length>0)e=i.pop(),g=this.ops1[h.index_],h=new c(r,0,0,g(e.number_)),i.push(h);else{for(;i.length>0;)j.push(i.shift());j.push(h)}}for(;i.length>0;)j.push(i.shift());return new d(j,b(this.ops1),b(this.ops2),b(this.functions))},substitute:function(a,e){e instanceof d||(e=(new q).parse(String(e)));var f,g=[],h=this.tokens.length,i=0;for(i=0;h>i;i++){f=this.tokens[i];var j=f.type_;if(j===u&&f.index_===a)for(var k=0;k<e.tokens.length;k++){var l=e.tokens[k],m=new c(l.type_,l.index_,l.prio_,l.number_);g.push(m)}else g.push(f)}var n=new d(g,b(this.ops1),b(this.ops2),b(this.functions));return n},evaluate:function(a){a=a||{};var b,c,d,e,f=[],g=this.tokens.length,h=0;for(h=0;g>h;h++){e=this.tokens[h];var i=e.type_;if(i===r)f.push(e.number_);else if(i===t)c=f.pop(),b=f.pop(),d=this.ops2[e.index_],f.push(d(b,c));else if(i===u)if(e.index_ in a)f.push(a[e.index_]);else{if(!(e.index_ in this.functions))throw new Error("undefined variable: "+e.index_);f.push(this.functions[e.index_])}else if(i===s)b=f.pop(),d=this.ops1[e.index_],f.push(d(b));else{if(i!==v)throw new Error("invalid Expression");if(b=f.pop(),d=f.pop(),!d.apply||!d.call)throw new Error(d+" is not a function");f.push("[object Array]"==Object.prototype.toString.call(b)?d.apply(void 0,b):d.call(void 0,b))}}if(f.length>1)throw new Error("invalid Expression (parity)");return f[0]},toString:function(a){var b,c,d,f,g=[],h=this.tokens.length,i=0;for(i=0;h>i;i++){f=this.tokens[i];var j=f.type_;if(j===r)g.push(e(f.number_));else if(j===t)c=g.pop(),b=g.pop(),d=f.index_,g.push(a&&"^"==d?"Math.pow("+b+","+c+")":"("+b+d+c+")");else if(j===u)g.push(f.index_);else if(j===s)b=g.pop(),d=f.index_,g.push("-"===d?"("+d+b+")":d+"("+b+")");else{if(j!==v)throw new Error("invalid Expression");b=g.pop(),d=g.pop(),g.push(d+"("+b+")")}}if(g.length>1)throw new Error("invalid Expression (parity)");return g[0]},variables:function(){for(var a=this.tokens.length,b=[],c=0;a>c;c++){var d=this.tokens[c];d.type_===u&&-1==b.indexOf(d.index_)&&b.push(d.index_)}return b},toJSFunction:function(a,b){var c=new Function(a,"with(Parser.values) { return "+this.simplify(b).toString(!0)+"; }");return c}},q.parse=function(a){return(new q).parse(a)},q.evaluate=function(a,b){return q.parse(a).evaluate(b)},q.Expression=d,q.values={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sqrt:Math.sqrt,log:Math.log,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,random:m,fac:n,exp:Math.exp,min:Math.min,max:Math.max,pyt:o,pow:Math.pow,atan2:Math.atan2,E:Math.E,PI:Math.PI};var y=1,z=2,A=4,B=8,C=16,D=32,E=64,F=128,G=256;return q.prototype={parse:function(a){this.errormsg="",this.success=!0;var e=[],f=[];this.tmpprio=0;var g=y|B|A|E,h=0;for(this.expression=a,this.pos=0;this.pos<this.expression.length;)if(this.isOperator())this.isSign()&&g&E?(this.isNegativeSign()&&(this.tokenprio=2,this.tokenindex="-",h++,this.addfunc(f,e,s)),g=y|B|A|E):this.isComment()||(0===(g&z)&&this.error_parsing(this.pos,"unexpected operator"),h+=2,this.addfunc(f,e,t),g=y|B|A|E);else if(this.isNumber()){0===(g&y)&&this.error_parsing(this.pos,"unexpected number");var i=new c(r,0,0,this.tokennumber);f.push(i),g=z|C|D}else if(this.isString()){0===(g&y)&&this.error_parsing(this.pos,"unexpected string");var i=new c(r,0,0,this.tokennumber);f.push(i),g=z|C|D}else if(this.isLeftParenth())0===(g&B)&&this.error_parsing(this.pos,'unexpected "("'),g&F&&(h+=2,this.tokenprio=-2,this.tokenindex=-1,this.addfunc(f,e,v)),g=y|B|A|E|G;else if(this.isRightParenth()){if(g&G){var i=new c(r,0,0,[]);f.push(i)}else 0===(g&C)&&this.error_parsing(this.pos,'unexpected ")"');g=z|C|D|B|F}else if(this.isComma())0===(g&D)&&this.error_parsing(this.pos,'unexpected ","'),this.addfunc(f,e,t),h+=2,g=y|B|A|E;else if(this.isConst()){0===(g&y)&&this.error_parsing(this.pos,"unexpected constant");var j=new c(r,0,0,this.tokennumber);f.push(j),g=z|C|D}else if(this.isOp2())0===(g&A)&&this.error_parsing(this.pos,"unexpected function"),this.addfunc(f,e,t),h+=2,g=B;else if(this.isOp1())0===(g&A)&&this.error_parsing(this.pos,"unexpected function"),this.addfunc(f,e,s),h++,g=B;else if(this.isVar()){0===(g&y)&&this.error_parsing(this.pos,"unexpected variable");var k=new c(u,this.tokenindex,0,0);f.push(k),g=z|C|D|B|F}else this.isWhite()||(""===this.errormsg?this.error_parsing(this.pos,"unknown character"):this.error_parsing(this.pos,this.errormsg));for((this.tmpprio<0||this.tmpprio>=10)&&this.error_parsing(this.pos,'unmatched "()"');e.length>0;){var l=e.pop();f.push(l)}return h+1!==f.length&&this.error_parsing(this.pos,"parity"),new d(f,b(this.ops1),b(this.ops2),b(this.functions))},evaluate:function(a,b){return this.parse(a).evaluate(b)},error_parsing:function(a,b){throw this.success=!1,this.errormsg="parse error [column "+a+"]: "+b,new Error(this.errormsg)},addfunc:function(a,b,d){for(var e=new c(d,this.tokenindex,this.tokenprio+this.tmpprio,0);b.length>0&&e.prio_<=b[b.length-1].prio_;)a.push(b.pop());b.push(e)},isNumber:function(){for(var a=!1,b="";this.pos<this.expression.length;){var c=this.expression.charCodeAt(this.pos);if(!(c>=48&&57>=c||46===c))break;b+=this.expression.charAt(this.pos),this.pos++,this.tokennumber=parseFloat(b),a=!0}return a},unescape:function(a,b){for(var c=[],d=!1,e=0;e<a.length;e++){var f=a.charAt(e);if(d){switch(f){case"'":c.push("'");break;case"\\":c.push("\\");break;case"/":c.push("/");break;case"b":c.push("\b");break;case"f":c.push("\f");break;case"n":c.push("\n");break;case"r":c.push("\r");break;case"t":c.push("	");break;case"u":var g=parseInt(a.substring(e+1,e+5),16);c.push(String.fromCharCode(g)),e+=4;break;default:throw this.error_parsing(b+e,"Illegal escape sequence: '\\"+f+"'")}d=!1}else"\\"==f?d=!0:c.push(f)}return c.join("")},isString:function(){var a=!1,b="",c=this.pos;if(this.pos<this.expression.length&&"'"==this.expression.charAt(this.pos))for(this.pos++;this.pos<this.expression.length;){var d=this.expression.charAt(this.pos);if("'"==d&&"\\"!=b.slice(-1)){this.pos++,this.tokennumber=this.unescape(b,c),a=!0;break}b+=this.expression.charAt(this.pos),this.pos++}return a},isConst:function(){var a;for(var b in this.consts){var c=b.length;if(a=this.expression.substr(this.pos,c),b===a)return this.tokennumber=this.consts[b],this.pos+=c,!0}return!1},isOperator:function(){var a=this.expression.charCodeAt(this.pos);if(43===a)this.tokenprio=0,this.tokenindex="+";else if(45===a)this.tokenprio=0,this.tokenindex="-";else if(124===a){if(124!==this.expression.charCodeAt(this.pos+1))return!1;this.pos++,this.tokenprio=0,this.tokenindex="||"}else if(42===a)this.tokenprio=1,this.tokenindex="*";else if(47===a)this.tokenprio=2,this.tokenindex="/";else if(37===a)this.tokenprio=2,this.tokenindex="%";else{if(94!==a)return!1;this.tokenprio=3,this.tokenindex="^"}return this.pos++,!0},isSign:function(){var a=this.expression.charCodeAt(this.pos-1);return 45===a||43===a?!0:!1},isPositiveSign:function(){var a=this.expression.charCodeAt(this.pos-1);return 43===a?!0:!1},isNegativeSign:function(){var a=this.expression.charCodeAt(this.pos-1);return 45===a?!0:!1},isLeftParenth:function(){var a=this.expression.charCodeAt(this.pos);return 40===a?(this.pos++,this.tmpprio+=10,!0):!1},isRightParenth:function(){var a=this.expression.charCodeAt(this.pos);return 41===a?(this.pos++,this.tmpprio-=10,!0):!1},isComma:function(){var a=this.expression.charCodeAt(this.pos);return 44===a?(this.pos++,this.tokenprio=-1,this.tokenindex=",",!0):!1},isWhite:function(){var a=this.expression.charCodeAt(this.pos);return 32===a||9===a||10===a||13===a?(this.pos++,!0):!1},isOp1:function(){for(var a="",b=this.pos;b<this.expression.length;b++){var c=this.expression.charAt(b);if(c.toUpperCase()===c.toLowerCase()&&(b===this.pos||"_"!=c&&("0">c||c>"9")))break;a+=c}return a.length>0&&a in this.ops1?(this.tokenindex=a,this.tokenprio=5,this.pos+=a.length,!0):!1},isOp2:function(){for(var a="",b=this.pos;b<this.expression.length;b++){var c=this.expression.charAt(b);if(c.toUpperCase()===c.toLowerCase()&&(b===this.pos||"_"!=c&&("0">c||c>"9")))break;a+=c}return a.length>0&&a in this.ops2?(this.tokenindex=a,this.tokenprio=5,this.pos+=a.length,!0):!1},isVar:function(){for(var a="",b=this.pos;b<this.expression.length;b++){var c=this.expression.charAt(b);if(c.toUpperCase()===c.toLowerCase()&&(b===this.pos||"_"!=c&&("0">c||c>"9")))break;a+=c}return a.length>0?(this.tokenindex=a,this.tokenprio=4,this.pos+=a.length,!0):!1},isComment:function(){var a=this.expression.charCodeAt(this.pos-1);return 47===a&&42===this.expression.charCodeAt(this.pos)?(this.pos=this.expression.indexOf("*/",this.pos)+2,1===this.pos&&(this.pos=this.expression.length),!0):!1}},a.Parser=q,q}("undefined"==typeof exports?{}:exports);