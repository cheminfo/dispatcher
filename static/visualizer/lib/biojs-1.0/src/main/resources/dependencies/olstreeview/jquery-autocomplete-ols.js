!function(a){a.fn.extend({autocomplete:function(b,c){var d="string"==typeof b;return c=a.extend({},a.Autocompleter.defaults,{url:d?b:null,data:d?null:b,delay:d?a.Autocompleter.defaults.delay:10,max:c&&!c.scroll?10:150},c),c.highlight=c.highlight||function(a){return a},"all"==c.ontologyId&&(c.ontologyId=null),this.each(function(){new a.Autocompleter(this,c)})},result:function(a){return this.bind("result",a)},search:function(a){return this.trigger("search",[a])},flushCache:function(){return this.trigger("flushCache")},setOptions:function(a){return this.trigger("setOptions",[a])},unautocomplete:function(){return this.trigger("unautocomplete")}}),a.Autocompleter=function(b,c){function d(){}function e(){var a=H.selected();if(!a)return!1;var b=a.result;D=b;var c=C.val(),d=l(c),e=k(d,b),f=0,g=0,h=C.caret().start,i=h==c.length;do{if(f=c.indexOf(d,g),-1!=f&&h>=f&&h<=f+d.length){var j=c.substring(0,f),m=c.substring(f).replace(d,e);c=j+m;break}g=f+d.length}while(-1!=f);return i&&(c+="f"==a.type?":":" "),C.val(c),t(),C.trigger("result",[a.data,a.value]),!0}function f(a,b){var e=C.val();if(b||e!=D){D=e,d("[onChange] currentValue: ["+e+"]");var f=l(e);d("[onChange] term: ["+f+"]");var g=j(f);d("[onChange] text: ["+g+"]"),g.length>=c.minChars?(C.addClass(c.loadingClass),v(f,u,t)):(x(),H.hide())}}function g(b){return b?a.map(b.split(" "),function(c){return a.trim(b).length?a.trim(c):null}):[""]}function h(a){return o(a,/^[+-]/)}function i(a){return-1!=a.indexOf(":")?(a=a.replace(/^[+-]/,""),o(a,/([^:]+)/)):""}function j(a){var b=a.indexOf('"');return-1!=b?r(a.substring(b+1),'"'):(a=a.replace(/^[+-]/,""),a=a.replace(/^\w+:/,""))}function k(a,b){var c=i(a),d=-1!=b.indexOf(" ");return h(a)+(c.length>0?c+":":"")+(d?'"':"")+b+(d?'"':"")}function l(c){var e=a(b).caret().start,f=e>0?c.substring(0,e):"",g=c.substring(e);return d("[currentTerm] beforeCursor: ["+f+"]"),d("[currentTerm] lastTerm(beforeCursor): ["+n(f)+"]"),d("[currentTerm] afterCursor: ["+g+"]"),c=m(n(f)+g)}function m(a){if(d("[firstTerm] value(1): ["+a+"]"),/^[^ ]*\"/.test(a)){var b=a.indexOf('"'),c=a.substring(0,b),e=a.substring(b+1);a=c+'"'+r(e,'"')+(-1!=e.indexOf('"')?'"':""),d("[firstTerm] value(2): ["+a+"]")}else a=p(a,/AND|OR|NOT|\s\+|\s\-/g).replace(/\s*$/,""),d("[firstTerm] value(3): ["+a+"]");return a}function n(a){return d("[lastTerm] value(1): ["+a+"]"),a=a.replace(/\"$/,"").replace(/\"[^\"]*\"/g,""),d("[lastTerm] value(2): ["+a+"]"),-1!=a.indexOf('"')?(a=o(a,/([^ ]*\".*)$/),d("[lastTerm] value(3): ["+a+"]")):(a=q(a,/AND|OR|NOT|\s\+|\s\-/g),d("[lastTerm] value(4): ["+a+"]")),a}function o(a,b){var c=a.match(b);return null!=c&&c.length>0?c[0]:""}function p(a,b){var c=a.search(b);if(-1==c)return a;var d=a.split(b);return d[0]}function q(a,b){var c=a.search(b);if(-1==c)return a;var d=a.split(b);return d[d.length-1]}function r(a,b){var c=a.indexOf(b);return-1==c?a:a.substring(0,c)}function s(){clearTimeout(y),y=setTimeout(t,200)}function t(){H.visible();H.hide(),clearTimeout(y),x(),c.mustMatch&&C.search(function(a){if(!a){var b=g(C.val()).slice(0,-1);C.val(b.join(" ")+(b.length?" ":""))}})}function u(a,b){b&&b.length&&F?(x(),H.display(b,a),H.show()):t()}function v(d,e,f){var g=j(d),h=i(d);c.matchCase||(g=g.toLowerCase());var k=E.load(d);if(k&&k.length)e(g,k);else if("string"==typeof c.url&&c.url.length>0){var l={timestamp:+new Date};a.each(c.extraParams,function(a,b){l[a]="function"==typeof b?b():b}),a.ajax({mode:"abort",port:"autocomplete"+b.name,dataType:c.dataType,url:c.url,data:a.extend({termname:g,field:h,ontologyname:c.ontologyId,q:"termautocomplete",limit:c.max},l),success:function(a){var b=w(a),d=c.parse(b);E.add(g,d),e(g,d)}})}else H.emptyList(),f(g)}function w(b){var c="";return a(b).find("item").each(function(){var b=a(this).find("name").text(),d=a(this).find("value").text();c+=b+"|o|"+d+"\n"}),c}function x(){C.removeClass(c.loadingClass)}var y,z,A,B={UP:38,DOWN:40,LEFT:37,RIGHT:39,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8},C=a(b).addClass(c.inputClass),D="",E=a.Autocompleter.Cache(c),F=0,G={mouseDownOnSelect:!1},H=a.Autocompleter.Select(c,b,e,G);a.browser.opera&&a(b.form).bind("submit.autocomplete",function(){return A?(A=!1,!1):void 0}),C.bind((a.browser.opera?"keypress":"keydown")+".autocomplete",function(a){switch(F=1,z=a.keyCode,a.keyCode){case B.UP:a.preventDefault(),H.visible()?H.prev():f(0,!0);break;case B.DOWN:a.preventDefault(),H.visible()?H.next():f(0,!0);break;case B.LEFT:H.visible()&&H.collapseTree()&&a.preventDefault();break;case B.RIGHT:H.visible()&&H.expandTree()&&a.preventDefault();break;case B.PAGEUP:a.preventDefault(),H.visible()?H.pageUp():f(0,!0);break;case B.PAGEDOWN:a.preventDefault(),H.visible()?H.pageDown():f(0,!0);break;case B.TAB:case B.RETURN:if(e())return a.preventDefault(),A=!0,!1;break;case B.ESC:H.hide();break;default:clearTimeout(y),y=setTimeout(f,c.delay)}}).focus(function(){F++}).blur(function(){F=0,G.mouseDownOnSelect||s()}).click(function(){F++>1&&!H.visible()&&f(0,!0)}).bind("search",function(){function b(a,b){var d;if(b&&b.length)for(var e=0;e<b.length;e++)if(b[e].result.toLowerCase()==a.toLowerCase()){d=b[e];break}"function"==typeof c?c(d):C.trigger("result",d&&[d.data,d.value])}var c=arguments.length>1?arguments[1]:null;a.each(g(C.val()),function(a,c){v(c,b,b)})}).bind("flushCache",function(){E.flush()}).bind("setOptions",function(){a.extend(c,arguments[1]),"data"in arguments[1]&&E.populate()}).bind("unautocomplete",function(){H.unbind(),C.unbind(),a(b.form).unbind(".autocomplete")})},a.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:!1,matchSubset:!0,matchContains:!1,cacheLength:10,max:100,mustMatch:!1,extraParams:{},selectFirst:!0,width:0,highlight:function(a,b){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},parse:function(b){for(var c=[],d=b.split("\n"),e=0;e<d.length;e++){var f=a.trim(d[e]);f&&(f=f.split("|"),c[c.length]={data:f,value:"f"==f[1]?f[0]+":":f[0],result:f[0],type:f[1],fieldName:"f"==f[1]?f[2]:null,treeId:"o"==f[1]?f[2]:null,treeLevel:"o"==f[1]?0:null,treeIsExpanded:!1})}return c},formatItem:function(a,b,c,d,e,f){if("f"==a.data[1])d=d+'<span class="ac_field">Filter '+a.data[2]+"</span>";else if("o"==a.data[1]){var g=/([^:]*):(.*)/,h=g.exec(d),i="ONTOLOGY";if(void 0!=h&&(i=h[1]),null!=f&&(i=f),d=d+'<span class="ac_efo">'+i+"</span>",null!=a.treeLevel){a.treeId?d='<a href="javascript:void(0);"><div class="ac_tree_control"><div/></div></a>'+d:0<a.treeLevel&&(d='<div class="ac_tree_level"/>'+d);for(var j=0;j<a.treeLevel;j++)d='<div class="ac_tree_level"/>'+d}}return d},scroll:!0,scrollHeight:242},a.Autocompleter.Cache=function(b){function c(a,c){b.matchCase||(a=a.toLowerCase());var d=a.indexOf(c);return"word"==b.matchContains&&(d=a.toLowerCase().search("\\b"+c.toLowerCase())),-1==d?!1:0==d||b.matchContains}function d(a,c){h>b.cacheLength&&f(),g[a]||h++,g[a]=c}function e(){if(!b.data)return!1;var c={},e=0;b.url||(b.cacheLength=1),c[""]=[];for(var f=0,g=b.data.length;g>f;f++){var h=b.data[f];h="string"==typeof h?[h]:h;var i=b.formatItem(h,f+1,b.data.length);if(i!==!1){var j=i.charAt(0).toLowerCase();c[j]||(c[j]=[]);var k={value:i,data:h,result:b.formatResult&&b.formatResult(h)||i};c[j].push(k),e++<b.max&&c[""].push(k)}}a.each(c,function(a,c){b.cacheLength++,d(a,c)})}function f(){g={},h=0}var g={},h=0;return setTimeout(e,25),{flush:f,add:d,populate:e,load:function(d){if(!b.cacheLength||!h)return null;if(!b.url&&b.matchContains){var e=[];for(var f in g)if(f.length>0){var i=g[f];a.each(i,function(a,b){c(b.value,d)&&e.push(b)})}return e}if(g[d])return g[d];if(b.matchSubset)for(var j=d.length-1;j>=b.minChars;j--){var i=g[d.substr(0,j)];if(i){var e=[];return a.each(i,function(a,b){c(b.value,d)&&(e[e.length]=b)}),e}}return null}}},a.Autocompleter.Select=function(b,c,d,e){function f(){E&&(z=a("<div class='ac_outer'><div class='ac_inner'></div></div>").hide().addClass(b.resultsClass).css("position","absolute").appendTo(document.body),A=a("<ul/>").appendTo(z.find(".ac_inner")).mouseover(function(b){g(b).nodeName&&"LI"==g(b).nodeName.toUpperCase()&&(C=a("li",A).removeClass(B.ACTIVE).index(g(b)),a(g(b)).addClass(B.ACTIVE))}).click(function(b){return h(b)?(k(b),c.focus()):(a(g(b)).addClass(B.ACTIVE),d(),c.focus()),!1}).mousedown(function(){e.mouseDownOnSelect=!0}).mouseup(function(){e.mouseDownOnSelect=!1}),b.width>0&&z.css("width",b.width),E=!1)}function g(a){for(var b=a.target;b&&"LI"!=b.tagName;)b=b.parentNode;return b?b:[]}function h(a){for(var b=a.target;b&&"DIV"==b.tagName;){if("ac_tree_control"==b.className)return!0;b=b.parentNode}return b&&"ac_tree_control"==b.className}function i(b){return b&&b.length&&a.data(b[0],"ac_data")}function j(b){return a(b).find("span.ac_efo").text()}function k(b){var c=g(b);a(c).hasClass("ac_tree_collapsed")?m(c):l(c)}function l(b){return a(b).hasClass("ac_tree_expanded")?(o(a(b)),!0):!1}function m(b){return a(b).hasClass("ac_tree_collapsed")?(q(a(b),n,n),!0):!1}function n(a,b){for(var c=i(a),d=0;d<y.length&&c.treeId!=y[d].treeId;++d);if(d<y.length){for(var e=b.length-1;e>=0;--e)b[e]&&(b[e].treeLevel=c.treeLevel+1,d<y.length-1?y.splice(d+1,0,b[e]):y.push(b[e]));c.treeIsExpanded=!0,v(),p()}}function o(a){for(var b=i(a),c=0;c<y.length&&b.treeId!=y[c].treeId;++c);if(c<y.length-1){for(var d=c+1;d<y.length&&b.treeLevel<y[d].treeLevel;)y.splice(d,1);b.treeIsExpanded=!1,v(),p()}}function p(){-1!=C&&x.slice(C,C+1).addClass(B.ACTIVE)}function q(d,e){elt=d;var f=i(d),g=null;g=null==b.ontologyId?j(d):b.ontologyId,a.ajax({mode:"abort",port:"autocomplete"+c.name,url:b.requestTreeUrl+"?termId="+f.treeId+"&ontology="+g,dataType:"json",success:function(a){var c=r(a),d=b.parse(c);e(elt,d)}})}function r(a){var c="";if(a.children&&a.children.length>0)for(var d=0;d<a.children.length;d++){var e="";a.children[d].isLeaf||(e=a.children[d].id);var f="";"all"==b.ontologyId&&(f=a.children[d].ontology+":"),c+=f+a.children[d].name+"|o|"+e+"\n"}return c}function s(a){x.slice(C,C+1).removeClass(B.ACTIVE),t(a);var c=x.slice(C,C+1).addClass(B.ACTIVE);if(b.scroll){var d=0;x.slice(0,C).each(function(){d+=this.offsetHeight}),d+c[0].offsetHeight-A.scrollTop()>A[0].clientHeight?A.scrollTop(d+c[0].offsetHeight-A.innerHeight()):d<A.scrollTop()&&A.scrollTop(d)}}function t(a){C+=a,0>C?C=x.size()-1:C>=x.size()&&(C=0)}function u(a){return b.max&&b.max<a?b.max:a}function v(){A.empty();for(var c=u(y.length),d=0;c>d;d++)if(y[d]){var e=b.highlight(y[d].value,D),f=b.formatItem(y[d],d+1,c,e,D,b.ontologyId);if(f!==!1){var g=a("<li/>").html(f).addClass(d%2==0?"ac_even":"ac_odd").addClass(y[d].treeId?y[d].treeIsExpanded?"ac_tree_expanded":"ac_tree_collapsed":"").appendTo(A)[0];a.data(g,"ac_data",y[d])}}x=A.find("li"),b.selectFirst&&(x.slice(0,1).addClass(B.ACTIVE),C=0),a.fn.bgiframe&&A.bgiframe()}function w(){var b=a.browser.mozilla?2:4;z.width(a(c).width()+b)}var x,y,z,A,B={ACTIVE:"ac_over"},C=-1,D="",E=!0;return{display:function(a,b){f(),y=a,D=b,v()},next:function(){s(1)},prev:function(){s(-1)},pageUp:function(){s(0!=C&&0>C-8?-C:-8)},pageDown:function(){s(C!=x.size()-1&&C+8>x.size()?x.size()-1-C:8)},hide:function(){z&&z.hide(),x&&x.removeClass(B.ACTIVE),C=-1},visible:function(){return z&&z.is(":visible")},current:function(){return this.visible()&&(x.filter("."+B.ACTIVE)[0]||b.selectFirst&&x[0])},collapseTree:function(){return l(this.current())},expandTree:function(){return m(this.current())},show:function(){var d=a(c).offset();if(w(),z.css({top:d.top+c.offsetHeight+2,left:d.left}).show(),a(window).bind("resize",w),b.scroll&&(A.scrollTop(0),A.css({maxHeight:b.scrollHeight,overflow:"auto"}),a.browser.msie&&"undefined"==typeof document.body.style.maxHeight)){var e=0;x.each(function(){e+=this.offsetHeight});var f=e>b.scrollHeight;A.css("height",f?b.scrollHeight:e),f||x.width(A.width()-parseInt(x.css("padding-left"))-parseInt(x.css("padding-right")))}},selected:function(){var b=x&&x.filter("."+B.ACTIVE).removeClass(B.ACTIVE);return b&&b.length&&a.data(b[0],"ac_data")},emptyList:function(){A&&A.empty()},unbind:function(){z&&z.remove()}}}}(jQuery);