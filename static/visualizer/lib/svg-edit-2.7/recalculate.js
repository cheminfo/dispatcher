var svgedit=svgedit||{};!function(){svgedit.recalculate||(svgedit.recalculate={});var a,b=svgedit.NS;svgedit.recalculate.init=function(b){a=b},svgedit.recalculate.updateClipPath=function(b,c,d){var e=getRefElem(b).firstChild,f=svgedit.transformlist.getTransformList(e),g=a.getSVGRoot().createSVGTransform();g.setTranslate(c,d),f.appendItem(g),svgedit.recalculate.recalculateDimensions(e)},svgedit.recalculate.recalculateDimensions=function(c){if(null==c)return null;if("svg"==c.nodeName&&navigator.userAgent.indexOf("Firefox/20")>=0)return null;var d,e=a.getSVGRoot(),f=svgedit.transformlist.getTransformList(c);if(f&&f.numberOfItems>0){for(d=f.numberOfItems;d--;){var g=f.getItem(d);0===g.type?f.removeItem(d):1===g.type?svgedit.math.isIdentity(g.matrix)&&f.removeItem(d):4===g.type&&0===g.angle&&f.removeItem(d)}if(1===f.numberOfItems&&svgedit.utilities.getRotationAngle(c))return null}if(!f||0==f.numberOfItems)return c.setAttribute("transform",""),c.removeAttribute("transform"),null;if(f){d=f.numberOfItems;for(var h=[];d--;){var g=f.getItem(d);1===g.type?h.push([g.matrix,d]):h.length&&(h=[])}if(2===h.length){var i=e.createSVGTransformFromMatrix(svgedit.math.matrixMultiply(h[1][0],h[0][0]));f.removeItem(h[0][1]),f.removeItem(h[1][1]),f.insertItemBefore(i,h[1][1])}if(d=f.numberOfItems,d>=2&&1===f.getItem(d-2).type&&2===f.getItem(d-1).type){var j=e.createSVGTransform(),k=svgedit.math.matrixMultiply(f.getItem(d-2).matrix,f.getItem(d-1).matrix);j.setMatrix(k),f.removeItem(d-2),f.removeItem(d-2),f.appendItem(j)}}switch(c.tagName){case"line":case"polyline":case"polygon":case"path":break;default:if(1===f.numberOfItems&&1===f.getItem(0).type||2===f.numberOfItems&&1===f.getItem(0).type&&4===f.getItem(0).type)return null}var l=$(c).data("gsvg"),m=new svgedit.history.BatchCommand("Transform"),n={},o=null,p=[];switch(c.tagName){case"line":p=["x1","y1","x2","y2"];break;case"circle":p=["cx","cy","r"];break;case"ellipse":p=["cx","cy","rx","ry"];break;case"foreignObject":case"rect":case"image":p=["width","height","x","y"];break;case"use":case"text":case"tspan":p=["x","y"];break;case"polygon":case"polyline":o={},o.points=c.getAttribute("points");var q=c.points,r=q.numberOfItems;n.points=new Array(r);var s;for(s=0;r>s;++s){var t=q.getItem(s);n.points[s]={x:t.x,y:t.y}}break;case"path":o={},o.d=c.getAttribute("d"),n.d=c.getAttribute("d")}if(p.length?(n=$(c).attr(p),$.each(n,function(a,b){n[a]=svgedit.units.convertToNum(a,b)})):l&&(n={x:$(l).attr("x")||0,y:$(l).attr("y")||0}),null==o&&(o=$.extend(!0,{},n),$.each(o,function(a,b){o[a]=svgedit.units.convertToNum(a,b)})),o.transform=a.getStartTransform()||"","g"==c.tagName&&!l||"a"==c.tagName){var u=svgedit.utilities.getBBox(c),v={x:u.x+u.width/2,y:u.y+u.height/2},w=svgedit.math.transformPoint(u.x+u.width/2,u.y+u.height/2,svgedit.math.transformListToTransform(f).matrix),k=e.createSVGMatrix(),x=svgedit.utilities.getRotationAngle(c);if(x){var y=x*Math.PI/180;if(Math.abs(y)>1e-10)var z=Math.sin(y)/(1-Math.cos(y));else var z=2/y;var s;for(s=0;s<f.numberOfItems;++s){var g=f.getItem(s);if(4==g.type){var A=g.matrix;v.y=(z*A.e+A.f)/2,v.x=(A.e-z*A.f)/2,f.removeItem(s);break}}}var B=0,C=0,D=0,E=f.numberOfItems;if(E)var F=f.getItem(0).matrix;if(E>=3&&3==f.getItem(E-2).type&&2==f.getItem(E-3).type&&2==f.getItem(E-1).type){D=3;for(var G=f.getItem(E-3).matrix,H=f.getItem(E-2).matrix,I=f.getItem(E-1).matrix,J=c.childNodes,K=J.length;K--;){var L=J.item(K);if(B=0,C=0,1==L.nodeType){var M=svgedit.transformlist.getTransformList(L);if(!M)continue;var k=svgedit.math.transformListToTransform(M).matrix,N=svgedit.utilities.getRotationAngle(L),O=a.getStartTransform(),P=[];if(a.setStartTransform(L.getAttribute("transform")),N||svgedit.math.hasMatrixTransform(M)){var Q=e.createSVGTransform();Q.setMatrix(svgedit.math.matrixMultiply(G,H,I,k)),M.clear(),M.appendItem(Q),P.push(Q)}else{var R=svgedit.math.matrixMultiply(k.inverse(),I,k),S=e.createSVGMatrix();S.e=-R.e,S.f=-R.f;var T=svgedit.math.matrixMultiply(S.inverse(),k.inverse(),G,H,I,k,R.inverse()),U=e.createSVGTransform(),V=e.createSVGTransform(),W=e.createSVGTransform();U.setTranslate(R.e,R.f),V.setScale(T.a,T.d),W.setTranslate(S.e,S.f),M.appendItem(W),M.appendItem(V),M.appendItem(U),P.push(W),P.push(V),P.push(U)}m.addSubCommand(svgedit.recalculate.recalculateDimensions(L)),a.setStartTransform(O)}}f.removeItem(E-1),f.removeItem(E-2),f.removeItem(E-3)}else if(E>=3&&1==f.getItem(E-1).type){D=3,k=svgedit.math.transformListToTransform(f).matrix;var Q=e.createSVGTransform();Q.setMatrix(k),f.clear(),f.appendItem(Q)}else if((1==E||E>1&&3!=f.getItem(1).type)&&2==f.getItem(0).type){D=2;var X=svgedit.math.transformListToTransform(f).matrix;f.removeItem(0);var Y=svgedit.math.transformListToTransform(f).matrix.inverse(),Z=svgedit.math.matrixMultiply(Y,X);if(B=Z.e,C=Z.f,0!=B||0!=C){for(var J=c.childNodes,K=J.length,_=[];K--;){var L=J.item(K);if(1==L.nodeType){if(L.getAttribute("clip-path")){var ab=L.getAttribute("clip-path");-1===_.indexOf(ab)&&(svgedit.recalculate.updateClipPath(ab,B,C),_.push(ab))}var O=a.getStartTransform();a.setStartTransform(L.getAttribute("transform"));var M=svgedit.transformlist.getTransformList(L);if(M){var bb=e.createSVGTransform();bb.setTranslate(B,C),M.numberOfItems?M.insertItemBefore(bb,0):M.appendItem(bb),m.addSubCommand(svgedit.recalculate.recalculateDimensions(L));for(var cb=c.getElementsByTagNameNS(b.SVG,"use"),db="#"+L.id,eb=cb.length;eb--;){var fb=cb.item(eb);if(db==svgedit.utilities.getHref(fb)){var gb=e.createSVGTransform();gb.setTranslate(-B,-C),svgedit.transformlist.getTransformList(fb).insertItemBefore(gb,0),m.addSubCommand(svgedit.recalculate.recalculateDimensions(fb))}}a.setStartTransform(O)}}}_=[],a.setStartTransform(O)}}else{if(1!=E||1!=f.getItem(0).type||x){if(x){var hb=e.createSVGTransform();hb.setRotate(x,w.x,w.y),f.numberOfItems?f.insertItemBefore(hb,0):f.appendItem(hb)}return 0==f.numberOfItems&&c.removeAttribute("transform"),null}D=1;for(var k=f.getItem(0).matrix,J=c.childNodes,K=J.length;K--;){var L=J.item(K);if(1==L.nodeType){var O=a.getStartTransform();a.setStartTransform(L.getAttribute("transform"));var M=svgedit.transformlist.getTransformList(L);if(!M)continue;var ib=svgedit.math.matrixMultiply(k,svgedit.math.transformListToTransform(M).matrix),jb=e.createSVGTransform();jb.setMatrix(ib),M.clear(),M.appendItem(jb,0),m.addSubCommand(svgedit.recalculate.recalculateDimensions(L)),a.setStartTransform(O);var kb=L.getAttribute("stroke-width");if("none"!==L.getAttribute("stroke")&&!isNaN(kb)){var lb=(Math.abs(ib.a)+Math.abs(ib.d))/2;L.setAttribute("stroke-width",kb*lb)}}}f.clear()}if(2==D){if(x){w={x:v.x+F.e,y:v.y+F.f};var hb=e.createSVGTransform();hb.setRotate(x,w.x,w.y),f.numberOfItems?f.insertItemBefore(hb,0):f.appendItem(hb)}}else if(3==D){var k=svgedit.math.transformListToTransform(f).matrix,mb=e.createSVGTransform();mb.setRotate(x,v.x,v.y);var nb=mb.matrix,ob=e.createSVGTransform();ob.setRotate(x,w.x,w.y);var pb=ob.matrix.inverse(),qb=k.inverse(),rb=svgedit.math.matrixMultiply(qb,pb,nb,k);if(B=rb.e,C=rb.f,0!=B||0!=C)for(var J=c.childNodes,K=J.length;K--;){var L=J.item(K);if(1==L.nodeType){var O=a.getStartTransform();a.setStartTransform(L.getAttribute("transform"));var M=svgedit.transformlist.getTransformList(L),bb=e.createSVGTransform();bb.setTranslate(B,C),M.numberOfItems?M.insertItemBefore(bb,0):M.appendItem(bb),m.addSubCommand(svgedit.recalculate.recalculateDimensions(L)),a.setStartTransform(O)}}x&&(f.numberOfItems?f.insertItemBefore(ob,0):f.appendItem(ob))}}else{var u=svgedit.utilities.getBBox(c);if(!u&&"path"!=c.tagName)return null;var k=e.createSVGMatrix(),N=svgedit.utilities.getRotationAngle(c);if(N){var v={x:u.x+u.width/2,y:u.y+u.height/2},w=svgedit.math.transformPoint(u.x+u.width/2,u.y+u.height/2,svgedit.math.transformListToTransform(f).matrix),y=N*Math.PI/180;if(Math.abs(y)>1e-10)var z=Math.sin(y)/(1-Math.cos(y));else var z=2/y;for(var s=0;s<f.numberOfItems;++s){var g=f.getItem(s);if(4==g.type){var A=g.matrix;v.y=(z*A.e+A.f)/2,v.x=(A.e-z*A.f)/2,f.removeItem(s);break}}}var D=0,E=f.numberOfItems;if(!svgedit.browser.isWebkit()){var sb=c.getAttribute("fill");if(sb&&0===sb.indexOf("url(")){var tb=getRefElem(sb),ub="pattern";tb.tagName!==ub&&(ub="gradient");var vb=tb.getAttribute(ub+"Units");if("userSpaceOnUse"===vb){k=svgedit.math.transformListToTransform(f).matrix;var wb=svgedit.transformlist.getTransformList(tb),xb=svgedit.math.transformListToTransform(wb).matrix;k=svgedit.math.matrixMultiply(k,xb);var yb="matrix("+[k.a,k.b,k.c,k.d,k.e,k.f].join(",")+")";tb.setAttribute(ub+"Transform",yb)}}}if(E>=3&&3==f.getItem(E-2).type&&2==f.getItem(E-3).type&&2==f.getItem(E-1).type)D=3,k=svgedit.math.transformListToTransform(f,E-3,E-1).matrix,f.removeItem(E-1),f.removeItem(E-2),f.removeItem(E-3);else if(4==E&&1==f.getItem(E-1).type){D=3,k=svgedit.math.transformListToTransform(f).matrix;var Q=e.createSVGTransform();Q.setMatrix(k),f.clear(),f.appendItem(Q),k=e.createSVGMatrix()}else if((1==E||E>1&&3!=f.getItem(1).type)&&2==f.getItem(0).type){D=2;var zb=f.getItem(0).matrix,Ab=svgedit.math.transformListToTransform(f,1).matrix,Bb=Ab.inverse();k=svgedit.math.matrixMultiply(Bb,zb,Ab),f.removeItem(0)}else{if(1!=E||1!=f.getItem(0).type||N){if(D=4,N){var hb=e.createSVGTransform();hb.setRotate(N,w.x,w.y),f.numberOfItems?f.insertItemBefore(hb,0):f.appendItem(hb)}return 0==f.numberOfItems&&c.removeAttribute("transform"),null}switch(k=svgedit.math.transformListToTransform(f).matrix,c.tagName){case"line":n=$(c).attr(["x1","y1","x2","y2"]);case"polyline":case"polygon":if(n.points=c.getAttribute("points"),n.points){var q=c.points,r=q.numberOfItems;n.points=new Array(r);for(var s=0;r>s;++s){var t=q.getItem(s);n.points[s]={x:t.x,y:t.y}}}case"path":n.d=c.getAttribute("d"),D=1,f.clear()}}if((1==D||2==D||3==D)&&svgedit.coords.remapElement(c,n,k),2==D){if(N){svgedit.math.hasMatrixTransform(f)||(w={x:v.x+k.e,y:v.y+k.f});var hb=e.createSVGTransform();hb.setRotate(N,w.x,w.y),f.numberOfItems?f.insertItemBefore(hb,0):f.appendItem(hb)}if("text"==c.tagName)for(var J=c.childNodes,K=J.length;K--;){var L=J.item(K);if("tspan"==L.tagName){var Cb={x:$(L).attr("x")||0,y:$(L).attr("y")||0};svgedit.coords.remapElement(L,Cb,k)}}}else if(3==D&&N){var k=svgedit.math.transformListToTransform(f).matrix,mb=e.createSVGTransform();mb.setRotate(N,v.x,v.y);var nb=mb.matrix,ob=e.createSVGTransform();ob.setRotate(N,w.x,w.y);var pb=ob.matrix.inverse(),qb=k.inverse(),rb=svgedit.math.matrixMultiply(qb,pb,nb,k);svgedit.coords.remapElement(c,n,rb),N&&(f.numberOfItems?f.insertItemBefore(ob,0):f.appendItem(ob))}}return 0==f.numberOfItems&&c.removeAttribute("transform"),m.addSubCommand(new svgedit.history.ChangeElementCommand(c,o)),m}}();