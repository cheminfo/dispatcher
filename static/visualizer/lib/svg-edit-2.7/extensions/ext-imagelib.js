svgEditor.addExtension("imagelib",function(){function a(){$("#imgbrowse_holder").hide()}function b(a){var b=svgCanvas.addSvgElementFromJson({element:"image",attr:{x:0,y:0,width:0,height:0,id:svgCanvas.getNextId(),style:"pointer-events:inherit"}});svgCanvas.clearSelection(),svgCanvas.addToSelection([b]),svgCanvas.setImageURL(a)}function c(a){$("#lib_framewrap, #imglib_opts").css({right:a?200:10}),f||(f=$("<div id=imglib_preview>").css({position:"absolute",top:45,right:10,width:180,bottom:45,background:"#fff",overflow:"auto"}).insertAfter("#lib_framewrap"),g=$("<button disabled>Import selected</button>").appendTo("#imgbrowse").on("click touchend",function(){$.each(j,function(a){var c=this[0],d=this[1];"svg"==c?svgCanvas.importSvgString(d):b(d),svgCanvas.moveSelectedElements(20*a,20*a,!1)}),f.empty(),j=[],$("#imgbrowse_holder").hide()}).css({position:"absolute",bottom:10,right:-10})),f.toggle(a),g.toggle(a)}function d(){var a=$("#imgbrowse");if(a.length)$("#imgbrowse_holder").show();else{$("<div id=imgbrowse_holder><div id=imgbrowse class=toolbar_button>			</div></div>").insertAfter("#svg_docprops"),a=$("#imgbrowse");{var b=e.imagelib.select_lib,d=$("<ul id=imglib_opts>").appendTo(a),f=$("<iframe/>").prependTo(a).hide().wrap("<div id=lib_framewrap>"),g=$("<h1>").prependTo(a).text(b).css({position:"absolute",top:0,left:0,width:"100%"}),j=$("<button>"+e.common.cancel+"</button>").appendTo(a).on("click touchend",function(){$("#imgbrowse_holder").hide()}).css({position:"absolute",top:5,right:-10}),k=$("<span>").css({position:"absolute",top:5,left:10}).appendTo(a),l=$("<button hidden>"+e.imagelib.show_list+"</button>").appendTo(k).on("click touchend",function(){f.attr("src","about:blank").hide(),d.show(),g.text(b),l.hide()}).css({"margin-right":5}).hide();$("<select><option value=s>"+e.imagelib.import_single+"</option><option value=m>"+e.imagelib.import_multi+"</option><option value=o>"+e.imagelib.open+"</option></select>").appendTo(k).change(function(){switch(i=$(this).val()){case"s":case"o":c(!1);break;case"m":c(!0)}}).css({"margin-top":10})}j.prepend($.getSvgIcon("cancel",!0)),l.prepend($.getSvgIcon("tool_imagelib",!0)),$.each(h,function(a,b){$("<li>").appendTo(d).text(b.name).on("click touchend",function(){f.attr("src",b.url).show(),g.text(b.name),d.hide(),l.show()}).append("<span>"+b.description+"</span>")})}}var e=svgEditor.uiStrings;$.extend(e,{imagelib:{select_lib:"Select an image library",show_list:"Show library list",import_single:"Import single",import_multi:"Import multiple",open:"Open as new document"}});var f,g,h=[{name:"Demo library (local)",url:svgEditor.curConfig.extPath+"imagelib/index.html",description:"Demonstration library for SVG-edit on this server"},{name:"IAN Symbol Libraries",url:"http://ian.umces.edu/symbols/catalog/svgedit/album_chooser.php",description:"Free library of illustrations"}],i="s",j=[],k=!1,l={};return window.addEventListener("message",function(c){var d=c.data;if(d&&"string"==typeof d){try{var h=JSON.parse(d);if(h.namespace)return}catch(m){}var n,o,p,q=d.charAt(0);if("{"!=q&&k)return void(k=!1);if("|"==q){var r=d.indexOf("|",1);n=d.substr(1,r-1),d=d.substr(r+1),q=d.charAt(0)}$("#dialog_box").hide();var s,t;switch(q){case"{":k=!1,t=JSON.parse(d),l[t.id]=t;var u=t.name||"file",v=e.notification.retrieving.replace("%s",u);return void("m"!=i?$.process_cancel(v,function(){k=!0,$("#dialog_box").hide()}):(s=$("<div>"+v+"</div>").data("id",t.id),f.append(s),t.entry=s));case"<":o=!0;break;case"d":if(0===d.indexOf("data:image/svg+xml")){var w="data:image/svg+xml;base64,",x=d.substring(w.length);d=svgedit.utilities.decode64(x),o=!0;break}if(0===d.indexOf("data:image/")){p=!0;break}default:return void("m"!==i?a():l[n].entry.remove())}switch(i){case"s":o?svgCanvas.importSvgString(d):p&&b(d),a();break;case"m":j.push([o?"svg":"img",d]);var y;if(t=l[n],o){if(t&&t.name)y=t.name;else{var z=(new DOMParser).parseFromString(d,"text/xml").documentElement;y=$(z).children("title").first().text()||"(SVG #"+d.length+")"}t?f.children().each(function(){$(this).data("id")==n&&(t.preview_url?$(this).html('<img src="'+t.preview_url+'">'+y):$(this).text(y),g.removeAttr("disabled"))}):(f.append("<div>"+y+"</div>"),g.removeAttr("disabled"))}else t&&t.preview_url&&(y=t.name||""),s=t&&t.preview_url?'<img src="'+t.preview_url+'">'+y:'<img src="'+d+'">',t?f.children().each(function(){$(this).data("id")==n&&($(this).html(s),g.removeAttr("disabled"))}):(f.append($("<div>").append(s)),g.removeAttr("disabled"));break;case"o":if(!o)break;svgEditor.openPrep(function(a){a&&(svgCanvas.clear(),svgCanvas.setSvgString(d))}),a()}}},!0),{svgicons:svgEditor.curConfig.extPath+"ext-imagelib.xml",buttons:[{id:"tool_imagelib",type:"app_menu",position:4,title:"Image library",events:{mouseup:d}}],callback:function(){$("<style>").text("				#imgbrowse_holder {					position: absolute;					top: 0;					left: 0;					width: 100%;					height: 100%;					background-color: rgba(0, 0, 0, .5);					z-index: 5;				}								#imgbrowse {					position: absolute;					top: 25px;					left: 25px;					right: 25px;					bottom: 25px;					min-width: 300px;					min-height: 200px;					background: #B0B0B0;					border: 1px outset #777;				}				#imgbrowse h1 {					font-size: 20px;					margin: .4em;					text-align: center;				}				#lib_framewrap,				#imgbrowse > ul {					position: absolute;					top: 45px;					left: 10px;					right: 10px;					bottom: 10px;					background: white;					margin: 0;					padding: 0;				}				#imgbrowse > ul {					overflow: auto;				}				#imgbrowse > div {					border: 1px solid #666;				}				#imglib_preview > div {					padding: 5px;					font-size: 12px;				}				#imglib_preview img {					display: block;					margin: 0 auto;					max-height: 100px;				}				#imgbrowse li {					list-style: none;					padding: .5em;					background: #E8E8E8;					border-bottom: 1px solid #B0B0B0;					line-height: 1.2em;					font-style: sans-serif;					}				#imgbrowse li > span {					color: #666;					font-size: 15px;					display: block;					}				#imgbrowse li:hover {					background: #FFC;					cursor: pointer;					}				#imgbrowse iframe {					width: 100%;					height: 100%;					border: 0;				}			").appendTo("head")}}});