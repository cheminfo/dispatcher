svgEditor.addExtension("Markers",function(a){function b(b,c){var d=b.getAttribute(c);if(!d)return null;var e=d.match(/\(\#(.*)\)/);return e&&2===e.length?a.getElem(e[1]):null}function c(a,b){"\\"!==b.substr(0,1)&&(b="\\textmarker");var c="#"+s+a+"_"+b.substr(1);svgEditor.setIcon("#cur_"+a+"_marker_list",$(c).children()),$(c).addClass("current").siblings().removeClass("current")}function d(a){if($("#marker_panel").toggle(a),a){var d,e,f=o[0];$.each(q,function(a,g){var h=b(f,"marker-"+g),i=$("#"+g+"_marker");if(h){if(!h.attributes.se_type)return;d="\\"+h.attributes.se_type.textContent,e=d,"\\textmarker"===d?d=h.lastChild.textContent:i.hide()}else d="\\nomarker",e=d,i.hide();i.val(d),c(g,e)})}}function e(b,c){var d="#ffffff",e="none",f=0,g=a.getElem(b);if(!g&&""!=c&&"\\nomarker"!=c){var h,i=o[0],j=i.getAttribute("stroke"),k=50,l=50,m="0 0 100 100",n=5,q=5,r=10;if(h="\\"===c.substr(0,1)?c.substr(1):"textmarker",t[h]){if(g=p({element:"marker",attr:{id:b,markerUnits:"strokeWidth",orient:"auto",style:"pointer-events:none",se_type:h}}),"textmarker"!=h){var s=p(t[h]),u=j;"_o"===h.substr(-2)&&(u="none"),s.setAttribute("fill",u),s.setAttribute("stroke",j),s.setAttribute("stroke-width",r),g.appendChild(s)}else{var v=p(t[h]);v.textContent=c;var w=v.getBBox(),x=1,y=w;y.x=0,y.y=0,y.width+=2*x,y.height+=2*x,v.setAttribute("x",x),v.setAttribute("y",y.height-x-w.height/4),v.setAttribute("fill",j),k=y.width/2+x,l=y.height/2+x,m=y.x+" "+y.y+" "+y.width+" "+y.height,n=y.width/10,q=y.height/10;var z=p({element:"rect",attr:{x:y.x,y:y.y,width:y.width,height:y.height,fill:d,stroke:e,"stroke-width":f}});g.setAttribute("orient",0),g.appendChild(z),g.appendChild(v)}return g.setAttribute("viewBox",m),g.setAttribute("markerWidth",n),g.setAttribute("markerHeight",q),g.setAttribute("refX",k),g.setAttribute("refY",l),a.findDefs().appendChild(g),g}}}function f(b){if("line"!==b.tagName)return b;var c=Number(b.getAttribute("x1")),d=Number(b.getAttribute("x2")),e=Number(b.getAttribute("y1")),f=Number(b.getAttribute("y2")),g=b.id,h=" "+(c+d)/2+","+(e+f)/2+" ",i=p({element:"polyline",attr:{points:c+","+e+h+d+","+f,stroke:b.getAttribute("stroke"),"stroke-width":b.getAttribute("stroke-width"),fill:"none",opacity:b.getAttribute("opacity")||1}});$.each(q,function(a,c){var d="marker-"+c,e=b.getAttribute(d);e&&i.setAttribute(d,b.getAttribute(d))});var j=new a.BatchCommand;return j.addSubCommand(new a.RemoveElementCommand(b,b.parentNode)),j.addSubCommand(new a.InsertElementCommand(i)),$(b).after(i).remove(),svgCanvas.clearSelection(),i.id=g,svgCanvas.addToSelection([i]),a.addCommandToHistory(j),i}function g(){var d={start_marker:"start",mid_marker:"mid",end_marker:"end"},g=d[this.id],h="marker-"+g,i=this.value,j=o[0],k=b(j,h);if(k&&$(k).remove(),j.removeAttribute(h),""==i&&(i="\\nomarker"),"\\nomarker"==i)return c(g,i),void a.call("changed",o);var l=r+g+"_"+j.id;e(l,i),svgCanvas.changeSelectedAttribute(h,"url(#"+l+")"),"line"===j.tagName&&"mid"==g&&(j=f(j)),a.call("changed",o),c(g,i)}function h(a){var c=a.getAttribute("stroke");$.each(q,function(d,e){var f=b(a,"marker-"+e);if(f&&f.attributes.se_type){var g=f.lastElementChild;if(g){var h=g.getAttribute("fill"),i=g.getAttribute("stroke");h&&"none"!=h&&g.setAttribute("fill",c),i&&"none"!=i&&g.setAttribute("stroke",c)}}})}function i(c){$.each(q,function(d,g){var h=r+g+"_"+c.id,i="marker-"+g,j=b(c,i);if(j&&j.attributes.se_type){var k=c.getAttribute(i);if(k){var l=c.id.length,m=k.substr(-l-1,l);if(c.id!=m){var n=$("#"+g+"_marker").attr("value");e(h,n),svgCanvas.changeSelectedAttribute(i,"url(#"+h+")"),"line"===c.tagName&&"mid"==g&&(c=f(c)),a.call("changed",o)}}}})}function j(a,b){$("#"+a+"_marker").val(b),$("#"+a+"_marker").change()}function k(a){var b=$("#"+a+"_marker").val();"\\"===b.substr(0,1)&&(b=""),$.prompt("Enter text for "+a+" marker",b,function(b){b&&j(a,b)})}function l(){var a=this.id.split("_"),b=a[1],c=a[2];a[3]&&(c+="_"+a[3]),"textmarker"!=c?j(b,"\\"+c):k(b)}function m(a,b){var c,d=u[a];for(c in d)if(d.hasOwnProperty(c)&&d[c].id==b)return d[c].title;return b}function n(){var a=[];return $.each(q,function(b,c){var d=c+"_marker_list",e=!0;$.each(t,function(b){var f=m("en",b);a.push({id:s+c+"_"+b,svgicon:b,title:f,type:"context",events:{click:l},panel:"marker_panel",list:d,isDefault:e}),e=!1})}),a}var o,p=a.addSvgElementFromJson,q=["start","mid","end"],r="se_marker_",s="mkr_",t={nomarker:{},leftarrow:{element:"path",attr:{d:"M0,50 L100,90 L70,50 L100,10 Z"}},rightarrow:{element:"path",attr:{d:"M100,50 L0,90 L30,50 L0,10 Z"}},textmarker:{element:"text",attr:{x:0,y:0,"stroke-width":0,stroke:"none","font-size":75,"font-family":"serif","text-anchor":"left","xml:space":"preserve"}},forwardslash:{element:"path",attr:{d:"M30,100 L70,0"}},reverseslash:{element:"path",attr:{d:"M30,0 L70,100"}},verticalslash:{element:"path",attr:{d:"M50,0 L50,100"}},box:{element:"path",attr:{d:"M20,20 L20,80 L80,80 L80,20 Z"}},star:{element:"path",attr:{d:"M10,30 L90,30 L20,90 L50,10 L80,90 Z"}},xmark:{element:"path",attr:{d:"M20,80 L80,20 M80,80 L20,20"}},triangle:{element:"path",attr:{d:"M10,80 L50,20 L80,80 Z"}},mcircle:{element:"circle",attr:{r:30,cx:50,cy:50}}},u={en:[{id:"start_marker_list",title:"Select start marker type"},{id:"mid_marker_list",title:"Select mid marker type"},{id:"end_marker_list",title:"Select end marker type"},{id:"nomarker",title:"No Marker"},{id:"leftarrow",title:"Left Arrow"},{id:"rightarrow",title:"Right Arrow"},{id:"textmarker",title:"Text Marker"},{id:"forwardslash",title:"Forward Slash"},{id:"reverseslash",title:"Reverse Slash"},{id:"verticalslash",title:"Vertical Slash"},{id:"box",title:"Box"},{id:"star",title:"Star"},{id:"xmark",title:"X"},{id:"triangle",title:"Triangle"},{id:"mcircle",title:"Circle"},{id:"leftarrow_o",title:"Open Left Arrow"},{id:"rightarrow_o",title:"Open Right Arrow"},{id:"box_o",title:"Open Box"},{id:"star_o",title:"Open Star"},{id:"triangle_o",title:"Open Triangle"},{id:"mcircle_o",title:"Open Circle"}]};return $.each(["leftarrow","rightarrow","box","star","mcircle","triangle"],function(a,b){t[b+"_o"]=t[b]}),{name:"Markers",svgicons:svgEditor.curConfig.extPath+"markers-icons.xml",buttons:n(),context_tools:[{type:"input",panel:"marker_panel",title:"Start marker",id:"start_marker",label:"s",size:3,events:{change:g}},{type:"button-select",panel:"marker_panel",title:m("en","start_marker_list"),id:"start_marker_list",colnum:3,events:{change:l}},{type:"input",panel:"marker_panel",title:"Middle marker",id:"mid_marker",label:"m",defval:"",size:3,events:{change:g}},{type:"button-select",panel:"marker_panel",title:m("en","mid_marker_list"),id:"mid_marker_list",colnum:3,events:{change:l}},{type:"input",panel:"marker_panel",title:"End marker",id:"end_marker",label:"e",size:3,events:{change:g}},{type:"button-select",panel:"marker_panel",title:m("en","end_marker_list"),id:"end_marker_list",colnum:3,events:{change:l}}],callback:function(){$("#marker_panel").addClass("toolset").hide()},addLangData:function(a){return{data:u[a]}},selectedChanged:function(a){o=a.elems;for(var b=o.length,c=["line","path","polyline","polygon"];b--;){var e=o[b];d(e&&-1!==$.inArray(e.tagName,c)?a.selectedElement&&!a.multiselected?!0:!1:!1)}},elementChanged:function(a){var b=a.elems[0];b&&(b.getAttribute("marker-start")||b.getAttribute("marker-mid")||b.getAttribute("marker-end"))&&(h(b),i(b))}}});