define(["lib/webtoolkit/base64","src/util/versioning","lib/couchdb/jquery.couch"],function(a,b){function c(c){var e=(c.couchUrl||window.location.origin).replace(/\/$/,""),f=c.database||"x",g=(c.tinyUrl||window.location.origin+"/x/_design/x/_show/x").replace(/\/$/,"")+"/";$.couch.urlPrefix=e;var h=$.couch.db(f),i=b.getView(),j=a.encode(JSON.stringify(i)),k=a.encode(b.getDataJSON()),l=d(),m={_id:l,_attachments:{"view.json":{content_type:"application/json",data:j},"data.json":{content_type:"application/json",data:k}},version:i.version,visualizer:window.location.origin+window.location.pathname,couchdb:e+"/"+f+"/"},n=$.Deferred();return h.saveDoc(m,{success:function(){var a=g+l;n.resolve(a)},error:function(){n.reject()}}),n}function d(){for(var a="",b=0;20>b;b++)a+=e[Math.floor(62*Math.random())];return a}var e="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";return{share:c}});